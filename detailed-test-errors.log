
> backend@1.0.0 test
> jest --coverage --verbose

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:47:12 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized from detected service account file: easy-grocery-521d5-firebase-adminsdk-fbsvc-8df3f201df.json
2025-11-10 18:47:12 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized
  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒôí observe env with Radar: https://dotenvx.com/radar

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:47:13 [[32minfo[39m]: Redis: Connecting...
2025-11-10 18:47:13 [[32minfo[39m]: Redis: Connected and ready
2025-11-10 18:47:13 [[32minfo[39m]: Γ£à Redis caching enabled
  console.log
    Γ£à Connected to MongoDB Atlas test database

      at log (tests/testUtils/dbHandler.js:26:11)

  console.log
    Γ£à Test database dropped

      at log (tests/testUtils/dbHandler.js:37:15)

  console.log
    Γ£à Test database connection closed

      at log (tests/testUtils/dbHandler.js:41:15)

npm : FAIL tests/seller.test.js (13.602 s)
At line:1 char:1
+ npm test 2>&1 | Out-File -FilePath detailed-test-errors.log -Encoding ...
+ ~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (FAIL tests/seller.test.js (13.602 s):String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
  Seller - Integration Tests
    POST /api/seller/products - Create Product
      ΓêÜ should create product successfully (1824 ms)
      ΓêÜ should fail without seller authentication (429 ms)
      ΓêÜ should fail with missing required fields (382 ms)
      ΓêÜ restaurant products should have high default stock (507 ms)
    GET /api/seller/products - List Seller Products
      ΓêÜ should return seller's products only (506 ms)
    PUT /api/seller/products/:id - Update Product
      ΓêÜ should update product successfully (358 ms)
      ΓêÜ should not update product of another seller (446 ms)
    PATCH /api/seller/products/:id - Partial Update
      ΓêÜ should update single field (333 ms)
    DELETE /api/seller/products/:id - Delete Product
      ΓêÜ should soft delete (deactivate) product by default (385 ms)
      ΓêÜ should permanently delete product with permanent=true (384 ms)
    POST /api/seller/toggle-open - Toggle Availability
      ΓêÜ should toggle seller open status (386 ms)
      ΓêÜ should require boolean value (292 ms)
    GET /api/seller/orders - List Seller Orders
      ΓêÜ should return orders containing seller's products (465 ms)
      ΓêÜ should paginate seller orders (431 ms)
    POST /api/seller/orders/accept - Accept Order
      ├ù should accept order successfully (845 ms)
      ΓêÜ should fail with invalid order ID (384 ms)
    GET /api/seller/analytics - Seller Analytics
      ├ù should return seller analytics (332 ms)
      ├ù should filter analytics by date range (335 ms)
    GET /api/seller/inventory - Inventory Management
      ΓêÜ should return low stock products (390 ms)
      ΓêÜ should return inventory stats (329 ms)

  ΓùÅ Seller - Integration Tests ΓÇ║ POST /api/seller/orders/accept - Accept Order ΓÇ║ should accept order successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: "accepted"
    Received: undefined

    [0m [90m 350 |[39m
     [90m 351 |[39m       expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 352 |[39m       expect(res[33m.[39mbody[33m.[39mdata[33m?[39m[33m.[39mstatus [33m||[39m 
res[33m.[39mbody[33m.[39mstatus)[33m.[39mtoBe([32m"accepted"[39m)[33m;[39m
     [90m     |[39m                                                        [31m[1m^[22m[39m
     [90m 353 |[39m
     [90m 354 |[39m       [36mconst[39m updatedOrder [33m=[39m [36mawait[39m [33mOrder[39m[33m.[39mfindById(testOrder[33m.[39m_id)[33m;[39m
     [90m 355 |[39m       expect(updatedOrder[33m.[39mstatus)[33m.[39mtoBe([32m"accepted"[39m)[33m;[39m[0m

      at Object.toBe (tests/seller.test.js:352:56)

  ΓùÅ Seller - Integration Tests ΓÇ║ GET /api/seller/analytics - Seller Analytics ΓÇ║ should return seller analytics

    ValidationError: Order validation failed: delivery.delivery_address.full_address: Path `delivery.delivery_address.full_address` is required., payment.amount: Path 
`payment.amount` is required., order_items.0.qty: Path `qty` is required.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3358:32)
      at node_modules/mongoose/lib/document.js:3119:17
      at node_modules/mongoose/lib/schemaType.js:1416:9

  ΓùÅ Seller - Integration Tests ΓÇ║ GET /api/seller/analytics - Seller Analytics ΓÇ║ should filter analytics by date range

    ValidationError: Order validation failed: delivery.delivery_address.full_address: Path `delivery.delivery_address.full_address` is required., payment.amount: Path 
`payment.amount` is required., order_items.0.qty: Path `qty` is required.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3358:32)
      at node_modules/mongoose/lib/document.js:3119:17
      at node_modules/mongoose/lib/schemaType.js:1416:9

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒôí observe env with Radar: https://dotenvx.com/radar

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:47:25 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized from detected service account file: easy-grocery-521d5-firebase-adminsdk-fbsvc-8df3f201df.json
2025-11-10 18:47:25 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized
  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:47:25 [[32minfo[39m]: Redis: Connecting...
2025-11-10 18:47:25 [[32minfo[39m]: Redis: Connected and ready
2025-11-10 18:47:25 [[32minfo[39m]: Γ£à Redis caching enabled
  console.log
    Γ£à Connected to MongoDB Atlas test database

      at log (tests/testUtils/dbHandler.js:26:11)

  console.log
    Γ£à Test database dropped

      at log (tests/testUtils/dbHandler.js:37:15)

  console.log
    Γ£à Test database connection closed

      at log (tests/testUtils/dbHandler.js:41:15)

FAIL tests/delivery.test.js (12.702 s)
  Delivery System - Integration Tests
    Agent Assignment Logic
      ├ù should assign nearest available agent to order (2609 ms)
      ├ù should not assign agent who is already on delivery (594 ms)
      ├ù should fail if no agents available within radius (571 ms)
    Agent Order Management
      ├ù agent should be able to accept assigned order (511 ms)
      ├ù agent should be able to reject order (525 ms)
      ├ù agent cannot accept order assigned to another agent (491 ms)
      ├ù agent should update order to picked up (491 ms)
      ├ù agent should complete delivery (480 ms)
    Location Tracking
      ├ù agent should update location in real-time (481 ms)
      ├ù should retrieve agent location for tracking (493 ms)
    Order Timeout & Retry Logic
      ├ù should reassign order if agent doesn't accept within timeout (494 ms)
      ├ù should retry pending orders (494 ms)
    Agent Earnings
      ├ù agent earnings should update after delivery completion (479 ms)
      ├ù should retrieve agent earnings history (485 ms)
    Agent Availability
      ├ù agent should toggle availability status (513 ms)
      ├ù unavailable agent should not receive new assignments (489 ms)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Agent Assignment Logic ΓÇ║ should assign nearest available agent to order

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 400

    [0m [90m 119 |[39m         [33m.[39m[36mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer mock_token_${testClient.firebase_uid}`[39m)[33m;[39m
     [90m 120 |[39m
    [31m[1m>[22m[39m[90m 121 |[39m       expect(res[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 122 |[39m       expect(res[33m.[39mbody[33m.[39mdelivery_agent_id)[33m.[39mtoBeDefined()[33m;[39m
     [90m 123 |[39m
     [90m 124 |[39m       [36mconst[39m order [33m=[39m [36mawait[39m [33mOrder[39m[33m.[39mfindById(res[33m.[39mbody[33m.[39m_id)[33m;[39m[0m

      at Object.toBe (tests/delivery.test.js:121:26)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Agent Assignment Logic ΓÇ║ should not assign agent who is already on delivery

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5e898b0eac7d0194b35'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780648940) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780648940), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780648940) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Agent Assignment Logic ΓÇ║ should fail if no agents available within radius

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5e998b0eac7d0194b4c'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780649511) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780649511), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780649511) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Agent Order Management ΓÇ║ agent should be able to accept assigned order

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5ea98b0eac7d0194b5c'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780650064) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780650064), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780650064) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Agent Order Management ΓÇ║ agent should be able to reject order

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5ea98b0eac7d0194b69'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780650607) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780650607), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780650607) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Agent Order Management ΓÇ║ agent cannot accept order assigned to another agent

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5eb98b0eac7d0194b76'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780651090) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780651091), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780651090) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Agent Order Management ΓÇ║ agent should update order to picked up

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5eb98b0eac7d0194b83'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780651580) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780651580), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780651580) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Agent Order Management ΓÇ║ agent should complete delivery

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5ec98b0eac7d0194b90'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780652071) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780652071), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780652071) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Location Tracking ΓÇ║ agent should update location in real-time

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5ec98b0eac7d0194b9d'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780652554) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780652554), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780652554) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Location Tracking ΓÇ║ should retrieve agent location for tracking

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5ed98b0eac7d0194baa'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780653041) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780653041), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780653041) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Order Timeout & Retry Logic ΓÇ║ should reassign order if agent doesn't accept within timeout

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5ed98b0eac7d0194bb7'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780653536) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780653536), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780653536) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Order Timeout & Retry Logic ΓÇ║ should retry pending orders

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5ee98b0eac7d0194bc4'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780654022) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780654023), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780654022) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Agent Earnings ΓÇ║ agent earnings should update after delivery completion

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5ee98b0eac7d0194bd1'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780654514) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780654514), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780654514) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Agent Earnings ΓÇ║ should retrieve agent earnings history

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5ee98b0eac7d0194bde'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780654996) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780654996), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780654996) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Agent Availability ΓÇ║ agent should toggle availability status

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5ef98b0eac7d0194beb'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780655514) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780655514), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780655514) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Agent Availability ΓÇ║ unavailable agent should not receive new assignments

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e5ef98b0eac7d0194bf8'), name: "Agent One", email: "agent1@test.com", phone: "9876543212", approved: 
true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", current_location: { updated_at: new 
Date(1762780655998) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780655998), __v: 0 }  unknown GeoJSON type: { updated_at: new 
Date(1762780655998) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒôí auto-backup env with Radar: https://dotenvx.com/radar

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:47:38 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized from detected service account file: easy-grocery-521d5-firebase-adminsdk-fbsvc-8df3f201df.json
2025-11-10 18:47:38 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized
  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:47:38 [[32minfo[39m]: Redis: Connecting...
2025-11-10 18:47:38 [[32minfo[39m]: Redis: Connected and ready
2025-11-10 18:47:38 [[32minfo[39m]: Γ£à Redis caching enabled
  console.log
    Γ£à Connected to MongoDB Atlas test database

      at log (tests/testUtils/dbHandler.js:26:11)

  console.log
    Γ£à Test database dropped

      at log (tests/testUtils/dbHandler.js:37:15)

  console.log
    Γ£à Test database connection closed

      at log (tests/testUtils/dbHandler.js:41:15)

FAIL tests/products.test.js (11.94 s)
  Products - Integration Tests
    GET /api/products - List Products
      ΓêÜ should return all active products (1675 ms)
      ΓêÜ should filter products by category (429 ms)
      ΓêÜ should search products by name (433 ms)
      ΓêÜ should paginate products (423 ms)
      ΓêÜ should not return inactive products (483 ms)
    GET /api/products/:id - Get Product Details
      ΓêÜ should return product details (540 ms)
      ΓêÜ should return 404 for non-existent product (433 ms)
      ΓêÜ should return 400 for invalid product ID (401 ms)
    POST /api/products/prices - Bulk Price Check
      ΓêÜ should return prices for multiple products (482 ms)
      ΓêÜ should return empty array for empty ids (670 ms)
      ΓêÜ should handle mix of valid and invalid IDs (609 ms)
    Product Stock Management
      ΓêÜ should check stock availability (517 ms)
      ΓêÜ restaurant products should have unlimited stock (525 ms)
    Product Ratings
      ├ù should calculate average rating correctly (518 ms)
    Seller-Specific Product Info
      ΓêÜ should include seller information with products (424 ms)
      ΓêÜ should show restaurant cuisine type (423 ms)
    Product Caching
      ΓêÜ should cache product listings (471 ms)

  ΓùÅ Products - Integration Tests ΓÇ║ Product Ratings ΓÇ║ should calculate average rating correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: 4.5
    Received: undefined

    [0m [90m 217 |[39m
     [90m 218 |[39m       expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 219 |[39m       expect(res[33m.[39mbody[33m.[39mdata[33m?[39m[33m.[39mrating [33m||[39m 
res[33m.[39mbody[33m.[39mrating)[33m.[39mtoBe([35m4.5[39m)[33m;[39m
     [90m     |[39m                                                        [31m[1m^[22m[39m
     [90m 220 |[39m       expect(res[33m.[39mbody[33m.[39mdata[33m?[39m[33m.[39mrating_count [33m||[39m 
res[33m.[39mbody[33m.[39mrating_count)[33m.[39mtoBe([35m10[39m)[33m;[39m
     [90m 221 |[39m     })[33m;[39m
     [90m 222 |[39m   })[33m;[39m[0m

      at Object.toBe (tests/products.test.js:219:56)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:47:50 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized from detected service account file: easy-grocery-521d5-firebase-adminsdk-fbsvc-8df3f201df.json
2025-11-10 18:47:50 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized
  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:47:50 [[32minfo[39m]: Redis: Connecting...
2025-11-10 18:47:50 [[32minfo[39m]: Redis: Connected and ready
2025-11-10 18:47:50 [[32minfo[39m]: Γ£à Redis caching enabled
  console.log
    Γ£à Connected to MongoDB Atlas test database

      at log (tests/testUtils/dbHandler.js:26:11)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at log (routes/uploads.js:38:15)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at log (routes/uploads.js:38:15)

2025-11-10 18:47:53 [[31merror[39m]: Multipart: Boundary not found {"stack":"Error: Multipart: Boundary not found\n    at new Multipart (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\busboy\\lib\\types\\multipart.js:233:13)\n    at getInstance (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\busboy\\lib\\index.js:33:12)\n    at module.exports (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\busboy\\lib\\index.js:56:10)\n    at multerMiddleware (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\multer\\lib\\make-middleware.js:28:16)\n    at Layer.handle [as handle_request] (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:284:15\n    at Function.process_params (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at Function.handle (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:175:3)\n    at router (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:47:12)\n    at Layer.handle [as handle_request] (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\app.js:221:18)\n    at Layer.handle [as handle_request] (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at urlencodedParser (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\body-parser\\lib\\types\\urlencoded.js:103:7)\n    at Layer.handle [as handle_request] (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at jsonParser (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\body-parser\\lib\\types\\json.js:122:7)\n    at Layer.handle [as handle_request] (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express-rate-limit\\dist\\index.cjs:807:7\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\express-rate-limit\\dist\\index.cjs:691:5","url":"/api/uploads","method":"POST","ip":"::ffff:127.0.0.1"}
2025-11-10 18:47:53 [[31merror[39m]: File too large {"stack":"MulterError: File too large\n    at abortWithCode (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\multer\\lib\\make-middleware.js:73:22)\n    at FileStream.<anonymous> (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\multer\\lib\\make-middleware.js:136:11)\n    at FileStream.emit (node:events:514:28)\n    at SBMH.ssCb [as _cb] (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\busboy\\lib\\types\\multipart.js:479:32)\n    at feed (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\streamsearch\\lib\\sbmh.js:248:10)\n    at SBMH.push (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\streamsearch\\lib\\sbmh.js:104:16)\n    at Multipart._write (C:\\Users\\asus\\Documents\\EasyApp\\Backend\\node_modules\\busboy\\lib\\types\\multipart.js:567:19)\n    at writeOrBuffer (node:internal/streams/writable:556:12)\n    at _write (node:internal/streams/writable:490:10)\n    at Multipart.Writable.write (node:internal/streams/writable:494:10)\n    at IncomingMessage.ondata (node:internal/streams/readable:985:22)\n    at IncomingMessage.emit (node:events:514:28)\n    at addChunk (node:internal/streams/readable:545:12)\n    at readableAddChunkPushByteMode (node:internal/streams/readable:495:3)\n    at IncomingMessage.Readable.push (node:internal/streams/readable:375:5)\n    at HTTPParser.parserOnBody (node:_http_common:131:24)\n    at HTTPParser.callbackTrampoline (node:internal/async_hooks:130:17)","url":"/api/uploads","method":"POST","ip":"::ffff:127.0.0.1"}
  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at log (routes/uploads.js:38:15)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at log (routes/uploads.js:38:15)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at log (routes/uploads.js:38:15)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at log (routes/uploads.js:38:15)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at log (routes/uploads.js:38:15)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at log (routes/uploads.js:38:15)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at log (routes/uploads.js:38:15)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at log (routes/uploads.js:38:15)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at log (routes/uploads.js:38:15)

  console.error
    Image optimization error: Error: Input buffer contains unsupported image format
        at Sharp.toBuffer (C:\Users\asus\Documents\EasyApp\node_modules\sharp\lib\output.js:163:17)
        at toBuffer (C:\Users\asus\Documents\EasyApp\Backend\middleware\imageOptimization.js:72:32)
        at optimizeImage (C:\Users\asus\Documents\EasyApp\Backend\routes\uploads.js:28:27)
        at Layer.handle [as handle_request] (C:\Users\asus\Documents\EasyApp\Backend\node_modules\express\lib\router\layer.js:95:5)
        at next (C:\Users\asus\Documents\EasyApp\Backend\node_modules\express\lib\router\route.js:149:13)
        at done (C:\Users\asus\Documents\EasyApp\Backend\node_modules\multer\lib\make-middleware.js:47:7)
        at indicateDone (C:\Users\asus\Documents\EasyApp\Backend\node_modules\multer\lib\make-middleware.js:51:68)
        at Multipart.<anonymous> (C:\Users\asus\Documents\EasyApp\Backend\node_modules\multer\lib\make-middleware.js:168:7)
        at Multipart.emit (node:events:514:28)
        at emitCloseNT (node:internal/streams/destroy:132:10)
        at processTicksAndRejections (node:internal/process/task_queues:81:21)

    [0m [90m 72 |[39m     [36mreturn[39m [36mawait[39m sharpInstance[33m.[39mtoBuffer()[33m;[39m
     [90m 73 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 74 |[39m     console[33m.[39merror([32m"Image optimization error:"[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 75 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m([32m"Failed to optimize image"[39m)[33m;[39m
     [90m 76 |[39m   }
     [90m 77 |[39m }[0m

      at error (middleware/imageOptimization.js:74:13)
      at routes/uploads.js:28:21

  console.error
    Image optimization failed, using original: Error: Failed to optimize image
        at optimizeImage (C:\Users\asus\Documents\EasyApp\Backend\middleware\imageOptimization.js:75:11)
        at C:\Users\asus\Documents\EasyApp\Backend\routes\uploads.js:28:21

    [0m [90m 42 |[39m       )[33m;[39m
     [90m 43 |[39m     } [36mcatch[39m (err) {
    [31m[1m>[22m[39m[90m 44 |[39m       console[33m.[39merror([32m"Image optimization failed, using original:"[39m[33m,[39m err)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 45 |[39m       [90m// Continue with original if optimization fails[39m
     [90m 46 |[39m     }
     [90m 47 |[39m[0m

      at error (routes/uploads.js:44:15)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at log (routes/uploads.js:38:15)

  console.log
    Γ£à Test database dropped

      at log (tests/testUtils/dbHandler.js:37:15)

  console.log
    Γ£à Test database connection closed

      at log (tests/testUtils/dbHandler.js:41:15)

FAIL tests/uploads.test.js (9.382 s)
  Image Upload & CDN - Integration Tests
    POST /api/uploads - Upload Image
      ΓêÜ should upload valid JPEG image (1331 ms)
      ΓêÜ should upload valid PNG image (533 ms)
      ΓêÜ should reject file without image (53 ms)
      ΓêÜ should reject unsupported file type (49 ms)
      ΓêÜ should reject oversized files (64 ms)
    GET /api/uploads/:id - Retrieve Image
      ├ù should retrieve uploaded image (367 ms)
      ΓêÜ should return 404 for non-existent file (425 ms)
      ΓêÜ should return 400 for invalid file ID (383 ms)
      ├ù should set cache headers on image response (410 ms)
    CDN URL Generation
      ΓêÜ should generate CDN URL when CDN is enabled (375 ms)
      ΓêÜ should generate local URL when CDN is disabled (366 ms)
    Image Optimization
      ├ù should optimize JPEG images (369 ms)
      ΓêÜ should handle PNG to WebP conversion if supported (497 ms)
    GridFS Storage
      ├ù should store file metadata in GridFS (664 ms)
      ├ù should clean up failed uploads (383 ms)
    CORS Headers
      ├ù should include CORS headers on image responses (367 ms)

  ΓùÅ Image Upload & CDN - Integration Tests ΓÇ║ GET /api/uploads/:id - Retrieve Image ΓÇ║ should retrieve uploaded image

    expect(received).toMatch(expected)

    Expected pattern: /image/
    Received string:  "application/json; charset=utf-8"

    [0m [90m 128 |[39m         expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m 129 |[39m       }
    [31m[1m>[22m[39m[90m 130 |[39m       expect(res[33m.[39mheaders[[32m"content-type"[39m])[33m.[39mtoMatch([35m/image/[39m)[33m;[39m
     [90m     |[39m                                           [31m[1m^[22m[39m
     [90m 131 |[39m     })[33m;[39m
     [90m 132 |[39m
     [90m 133 |[39m     test([32m"should return 404 for non-existent file"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.toMatch (tests/uploads.test.js:130:43)

  ΓùÅ Image Upload & CDN - Integration Tests ΓÇ║ GET /api/uploads/:id - Retrieve Image ΓÇ║ should set cache headers on image response

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

    [0m [90m 148 |[39m       [36mconst[39m res [33m=[39m [36mawait[39m 
request(app)[33m.[39m[36mget[39m([32m`/api/uploads/${uploadedFileId}`[39m)[33m;[39m
     [90m 149 |[39m
    [31m[1m>[22m[39m[90m 150 |[39m       expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 151 |[39m       expect(res[33m.[39mheaders[[32m"cache-control"[39m])[33m.[39mtoBeDefined()[33m;[39m
     [90m 152 |[39m       expect(res[33m.[39mheaders[[32m"cache-control"[39m])[33m.[39mtoMatch([35m/max-age/[39m)[33m;[39m
     [90m 153 |[39m     })[33m;[39m[0m

      at Object.toBe (tests/uploads.test.js:150:26)

  ΓùÅ Image Upload & CDN - Integration Tests ΓÇ║ Image Optimization ΓÇ║ should optimize JPEG images

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

    [0m [90m 220 |[39m       [36mconst[39m getRes [33m=[39m [36mawait[39m 
request(app)[33m.[39m[36mget[39m([32m`/api/uploads/${res.body.fileId}`[39m)[33m;[39m
     [90m 221 |[39m
    [31m[1m>[22m[39m[90m 222 |[39m       expect(getRes[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                             [31m[1m^[22m[39m
     [90m 223 |[39m       expect(getRes[33m.[39mheaders[[32m"content-type"[39m])[33m.[39mtoBe([32m"image/jpeg"[39m)[33m;[39m
     [90m 224 |[39m     })[33m;[39m
     [90m 225 |[39m[0m

      at Object.toBe (tests/uploads.test.js:222:29)

  ΓùÅ Image Upload & CDN - Integration Tests ΓÇ║ GridFS Storage ΓÇ║ should store file metadata in GridFS

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

    [0m [90m 252 |[39m       [36mconst[39m files [33m=[39m [36mawait[39m bucket[33m.[39mfind({ _id[33m:[39m [36mnew[39m 
mongoose[33m.[39m[33mTypes[39m[33m.[39m[33mObjectId[39m(uploadRes[33m.[39mbody[33m.[39mfileId) })[33m.[39mtoArray()[33m;[39m
     [90m 253 |[39m
    [31m[1m>[22m[39m[90m 254 |[39m       expect(files[33m.[39mlength)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 255 |[39m       expect(files[[35m0[39m][33m.[39mfilename)[33m.[39mtoBeDefined()[33m;[39m
     [90m 256 |[39m       expect(files[[35m0[39m][33m.[39mcontentType)[33m.[39mtoMatch([35m/image/[39m)[33m;[39m
     [90m 257 |[39m     })[33m;[39m[0m

      at Object.toBe (tests/uploads.test.js:254:28)

  ΓùÅ Image Upload & CDN - Integration Tests ΓÇ║ GridFS Storage ΓÇ║ should clean up failed uploads

    expect(received).toContain(expected) // indexOf

    Expected value: 200
    Received array: [400, 413, 500]

    [0m [90m 268 |[39m       [90m// Should fail[39m
     [90m 269 |[39m       [90m// Should fail with invalid file type[39m
    [31m[1m>[22m[39m[90m 270 |[39m       expect([[35m400[39m[33m,[39m [35m413[39m[33m,[39m 
[35m500[39m])[33m.[39mtoContain(res[33m.[39mstatus)[33m;[39m
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 271 |[39m
     [90m 272 |[39m       [90m// Verify no orphaned files in GridFS[39m
     [90m 273 |[39m       [36mconst[39m files [33m=[39m [36mawait[39m bucket[33m.[39mfind({})[33m.[39mtoArray()[33m;[39m[0m

      at Object.toContain (tests/uploads.test.js:270:31)

  ΓùÅ Image Upload & CDN - Integration Tests ΓÇ║ CORS Headers ΓÇ║ should include CORS headers on image responses

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

    [0m [90m 289 |[39m       [36mconst[39m getRes [33m=[39m [36mawait[39m 
request(app)[33m.[39m[36mget[39m([32m`/api/uploads/${uploadRes.body.fileId}`[39m)[33m;[39m
     [90m 290 |[39m
    [31m[1m>[22m[39m[90m 291 |[39m       expect(getRes[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                             [31m[1m^[22m[39m
     [90m 292 |[39m       expect(getRes[33m.[39mheaders[[32m"access-control-allow-origin"[39m])[33m.[39mtoBeDefined()[33m;[39m
     [90m 293 |[39m     })[33m;[39m
     [90m 294 |[39m   })[33m;[39m[0m

      at Object.toBe (tests/uploads.test.js:291:29)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:48:00 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized from detected service account file: easy-grocery-521d5-firebase-adminsdk-fbsvc-8df3f201df.json
2025-11-10 18:48:00 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized
  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:48:00 [[32minfo[39m]: Redis: Connecting...
2025-11-10 18:48:00 [[32minfo[39m]: Redis: Connected and ready
2025-11-10 18:48:00 [[32minfo[39m]: Γ£à Redis caching enabled
  console.log
    Γ£à Connected to MongoDB Atlas test database

      at log (tests/testUtils/dbHandler.js:26:11)

  console.log
    Γ£à Test database dropped

      at log (tests/testUtils/dbHandler.js:37:15)

  console.log
    Γ£à Test database connection closed

      at log (tests/testUtils/dbHandler.js:41:15)

FAIL tests/integration/end-to-end-order.test.js (6.492 s)
  End-to-End Order Flow - Integration Tests
    Complete Order Lifecycle - Happy Path
      ├ù should complete full order flow from creation to delivery (1811 ms)
    Multi-Seller Order Flow
      ├ù should handle order with products from multiple sellers (542 ms)
    Order Rejection & Retry Flow
      ├ù should handle agent rejection and reassignment (668 ms)
    Stock Management During Order Flow
      ├ù should handle concurrent orders for limited stock (457 ms)
    Payment Calculation Accuracy
      ├ù should calculate order totals correctly with all fees (461 ms)

  ΓùÅ End-to-End Order Flow - Integration Tests ΓÇ║ Complete Order Lifecycle - Happy Path ΓÇ║ should complete full order flow from creation to delivery

    TypeError: Cannot read properties of undefined (reading 'create')

    [0m [90m 79 |[39m     })[33m;[39m
     [90m 80 |[39m
    [31m[1m>[22m[39m[90m 81 |[39m     testCoupon [33m=[39m [36mawait[39m [33mCoupon[39m[33m.[39mcreate({
     [90m    |[39m                               [31m[1m^[22m[39m
     [90m 82 |[39m       code[33m:[39m [32m`E2ETEST${uniqueId.slice(-4)}`[39m[33m,[39m
     [90m 83 |[39m       discount_type[33m:[39m [32m"percentage"[39m[33m,[39m
     [90m 84 |[39m       discount_value[33m:[39m [35m10[39m[33m,[39m[0m

      at Object.create (tests/integration/end-to-end-order.test.js:81:31)

  ΓùÅ End-to-End Order Flow - Integration Tests ΓÇ║ Complete Order Lifecycle - Happy Path ΓÇ║ should complete full order flow from creation to delivery

    TypeError: Cannot read properties of undefined (reading 'deleteMany')

    [0m [90m  98 |[39m     [36mawait[39m [33mSeller[39m[33m.[39mdeleteMany({})[33m;[39m
     [90m  99 |[39m     [36mawait[39m [33mClient[39m[33m.[39mdeleteMany({})[33m;[39m
    [31m[1m>[22m[39m[90m 100 |[39m     [36mawait[39m [33mCoupon[39m[33m.[39mdeleteMany({})[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 101 |[39m   })[33m;[39m
     [90m 102 |[39m
     [90m 103 |[39m   describe([32m"Complete Order Lifecycle - Happy Path"[39m[33m,[39m () [33m=>[39m {[0m

      at Object.deleteMany (tests/integration/end-to-end-order.test.js:100:18)

  ΓùÅ End-to-End Order Flow - Integration Tests ΓÇ║ Multi-Seller Order Flow ΓÇ║ should handle order with products from multiple sellers

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e60ac2c2aeb5eea65e0e'), name: "E2E Agent", email: "e2e.agent.1762780682643_28@test.com", phone: 
"9896582643", approved: true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", 
current_location: { updated_at: new Date(1762780682887) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780682888), __v: 0 }  unknown 
GeoJSON type: { updated_at: new Date(1762780682887) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ End-to-End Order Flow - Integration Tests ΓÇ║ Multi-Seller Order Flow ΓÇ║ should handle order with products from multiple sellers

    TypeError: Cannot read properties of undefined (reading 'deleteMany')

    [0m [90m  98 |[39m     [36mawait[39m [33mSeller[39m[33m.[39mdeleteMany({})[33m;[39m
     [90m  99 |[39m     [36mawait[39m [33mClient[39m[33m.[39mdeleteMany({})[33m;[39m
    [31m[1m>[22m[39m[90m 100 |[39m     [36mawait[39m [33mCoupon[39m[33m.[39mdeleteMany({})[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 101 |[39m   })[33m;[39m
     [90m 102 |[39m
     [90m 103 |[39m   describe([32m"Complete Order Lifecycle - Happy Path"[39m[33m,[39m () [33m=>[39m {[0m

      at Object.deleteMany (tests/integration/end-to-end-order.test.js:100:18)

  ΓùÅ End-to-End Order Flow - Integration Tests ΓÇ║ Order Rejection & Retry Flow ΓÇ║ should handle agent rejection and reassignment

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e60bc2c2aeb5eea65e25'), name: "E2E Agent", email: "e2e.agent.1762780683197_441@test.com", phone: 
"9896583197", approved: true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", 
current_location: { updated_at: new Date(1762780683496) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780683497), __v: 0 }  unknown 
GeoJSON type: { updated_at: new Date(1762780683496) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ End-to-End Order Flow - Integration Tests ΓÇ║ Order Rejection & Retry Flow ΓÇ║ should handle agent rejection and reassignment

    TypeError: Cannot read properties of undefined (reading 'deleteMany')

    [0m [90m  98 |[39m     [36mawait[39m [33mSeller[39m[33m.[39mdeleteMany({})[33m;[39m
     [90m  99 |[39m     [36mawait[39m [33mClient[39m[33m.[39mdeleteMany({})[33m;[39m
    [31m[1m>[22m[39m[90m 100 |[39m     [36mawait[39m [33mCoupon[39m[33m.[39mdeleteMany({})[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 101 |[39m   })[33m;[39m
     [90m 102 |[39m
     [90m 103 |[39m   describe([32m"Complete Order Lifecycle - Happy Path"[39m[33m,[39m () [33m=>[39m {[0m

      at Object.deleteMany (tests/integration/end-to-end-order.test.js:100:18)

  ΓùÅ End-to-End Order Flow - Integration Tests ΓÇ║ Stock Management During Order Flow ΓÇ║ should handle concurrent orders for limited stock

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e60cc2c2aeb5eea65e36'), name: "E2E Agent", email: "e2e.agent.1762780683866_941@test.com", phone: 
"9896583866", approved: true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", 
current_location: { updated_at: new Date(1762780684065) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780684066), __v: 0 }  unknown 
GeoJSON type: { updated_at: new Date(1762780684065) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ End-to-End Order Flow - Integration Tests ΓÇ║ Stock Management During Order Flow ΓÇ║ should handle concurrent orders for limited stock

    TypeError: Cannot read properties of undefined (reading 'deleteMany')

    [0m [90m  98 |[39m     [36mawait[39m [33mSeller[39m[33m.[39mdeleteMany({})[33m;[39m
     [90m  99 |[39m     [36mawait[39m [33mClient[39m[33m.[39mdeleteMany({})[33m;[39m
    [31m[1m>[22m[39m[90m 100 |[39m     [36mawait[39m [33mCoupon[39m[33m.[39mdeleteMany({})[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 101 |[39m   })[33m;[39m
     [90m 102 |[39m
     [90m 103 |[39m   describe([32m"Complete Order Lifecycle - Happy Path"[39m[33m,[39m () [33m=>[39m {[0m

      at Object.deleteMany (tests/integration/end-to-end-order.test.js:100:18)

  ΓùÅ End-to-End Order Flow - Integration Tests ΓÇ║ Payment Calculation Accuracy ΓÇ║ should calculate order totals correctly with all fees

    MongoServerError: Can't extract geo keys: { _id: ObjectId('6911e60cc2c2aeb5eea65e43'), name: "E2E Agent", email: "e2e.agent.1762780684324_596@test.com", phone: 
"9896584324", approved: true, active: true, available: true, assigned_orders: 0, completed_orders: 0, rating: 0, total_ratings: 0, vehicle_type: "bike", 
current_location: { updated_at: new Date(1762780684529) }, working_hours: { start: "09:00", end: "21:00" }, created_at: new Date(1762780684530), __v: 0 }  unknown 
GeoJSON type: { updated_at: new Date(1762780684529) }

      at InsertOneOperation.execute (node_modules/mongoose/node_modules/mongodb/src/operations/insert.ts:88:13)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:283:14)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:115:12)
      at Collection.insertOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:286:12)

  ΓùÅ End-to-End Order Flow - Integration Tests ΓÇ║ Payment Calculation Accuracy ΓÇ║ should calculate order totals correctly with all fees

    TypeError: Cannot read properties of undefined (reading 'deleteMany')

    [0m [90m  98 |[39m     [36mawait[39m [33mSeller[39m[33m.[39mdeleteMany({})[33m;[39m
     [90m  99 |[39m     [36mawait[39m [33mClient[39m[33m.[39mdeleteMany({})[33m;[39m
    [31m[1m>[22m[39m[90m 100 |[39m     [36mawait[39m [33mCoupon[39m[33m.[39mdeleteMany({})[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 101 |[39m   })[33m;[39m
     [90m 102 |[39m
     [90m 103 |[39m   describe([32m"Complete Order Lifecycle - Happy Path"[39m[33m,[39m () [33m=>[39m {[0m

      at Object.deleteMany (tests/integration/end-to-end-order.test.js:100:18)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:48:06 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized from detected service account file: easy-grocery-521d5-firebase-adminsdk-fbsvc-8df3f201df.json
2025-11-10 18:48:06 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized
  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒôí auto-backup env with Radar: https://dotenvx.com/radar

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:48:06 [[32minfo[39m]: Redis: Connecting...
2025-11-10 18:48:06 [[32minfo[39m]: Redis: Connected and ready
2025-11-10 18:48:06 [[32minfo[39m]: Γ£à Redis caching enabled
  console.log
    Γ£à Connected to MongoDB Atlas test database

      at log (tests/testUtils/dbHandler.js:26:11)

  console.log
    Γ£à Test database dropped

      at log (tests/testUtils/dbHandler.js:37:15)

  console.log
    Γ£à Test database connection closed

      at log (tests/testUtils/dbHandler.js:41:15)

PASS tests/orders.test.js (14.986 s)
  Orders Controller - Unit Tests
    POST /api/orders - Create Order
      ΓêÜ should create order successfully with valid data (2588 ms)
      ΓêÜ should fail when product does not exist (1375 ms)
      ΓêÜ should fail when product is not available (1161 ms)
      ΓêÜ should fail when stock is insufficient (1055 ms)
      ΓêÜ should apply valid coupon correctly (1694 ms)
      ΓêÜ should fail when coupon is invalid (1179 ms)
      ΓêÜ should fail when coupon usage limit reached (1231 ms)
      ΓêÜ should fail when user already used coupon (max uses per user) (1280 ms)
      ΓêÜ should fail without authentication (1099 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:48:22 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized from detected service account file: easy-grocery-521d5-firebase-adminsdk-fbsvc-8df3f201df.json
2025-11-10 18:48:22 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized
  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:48:22 [[32minfo[39m]: Redis: Connecting...
2025-11-10 18:48:22 [[32minfo[39m]: Redis: Connected and ready
2025-11-10 18:48:22 [[32minfo[39m]: Γ£à Redis caching enabled
  console.log
    Γ£à Connected to MongoDB Atlas test database

      at log (tests/testUtils/dbHandler.js:26:11)

  console.log
    Γ£à Test database dropped

      at log (tests/testUtils/dbHandler.js:37:15)

  console.log
    Γ£à Test database connection closed

      at log (tests/testUtils/dbHandler.js:41:15)

PASS tests/auth.test.js (13.65 s)
  Authentication - Integration Tests
    POST /api/admin/login - Admin Login
      ΓêÜ should login successfully with valid credentials (2170 ms)
      ΓêÜ should fail with invalid email (908 ms)
      ΓêÜ should fail with invalid password (962 ms)
      ΓêÜ should fail with missing credentials (856 ms)
    POST /api/auth/login/seller - Seller Login
      ΓêÜ should login successfully with valid credentials (1185 ms)
      ΓêÜ should fail with invalid email (901 ms)
      ΓêÜ should fail with invalid password (976 ms)
    POST /api/auth/signup/seller - Seller Registration
      ΓêÜ should register new seller successfully (833 ms)
      ΓêÜ should fail with duplicate email (908 ms)
      ΓêÜ should fail with missing required fields (813 ms)
      ΓêÜ should fail with invalid email format (794 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:48:35 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized from detected service account file: easy-grocery-521d5-firebase-adminsdk-fbsvc-8df3f201df.json
2025-11-10 18:48:35 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized
  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒôí version env with Radar: https://dotenvx.com/radar

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:48:36 [[32minfo[39m]: Redis: Connecting...
2025-11-10 18:48:36 [[32minfo[39m]: Redis: Connected and ready
2025-11-10 18:48:36 [[32minfo[39m]: Γ£à Redis caching enabled
  console.log
    Γ£à Connected to MongoDB Atlas test database

      at log (tests/testUtils/dbHandler.js:26:11)

  console.log
    Γ£à Test database dropped

      at log (tests/testUtils/dbHandler.js:37:15)

  console.log
    Γ£à Test database connection closed

      at log (tests/testUtils/dbHandler.js:41:15)

PASS tests/cart.test.js (9.633 s)
  Cart - Integration Tests
    GET /api/cart/:uid - Get Cart
      ΓêÜ should return empty cart for new user (1651 ms)
      ΓêÜ should return cart items for existing cart (591 ms)
    PUT /api/cart/:uid - Update Cart
      ΓêÜ should add items to cart (561 ms)
      ΓêÜ should update existing cart (592 ms)
      ΓêÜ should clear cart with empty items array (588 ms)
      ΓêÜ should fail with invalid items format (446 ms)
      ΓêÜ should fail with missing items field (442 ms)
    Cart Item Validation
      ΓêÜ should handle multiple items from different sellers (712 ms)
      ΓêÜ should maintain cart item order (580 ms)
    Cart Calculations
      ΓêÜ should calculate correct cart total (546 ms)
    Cart Persistence
      ΓêÜ cart should persist across sessions (550 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:48:45 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized from detected service account file: easy-grocery-521d5-firebase-adminsdk-fbsvc-8df3f201df.json
2025-11-10 18:48:45 [[32minfo[39m]: ≡ƒöÉ Firebase Admin initialized
  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

      at _log (node_modules/dotenv/lib/main.js:139:11)

2025-11-10 18:48:46 [[32minfo[39m]: Redis: Connecting...
2025-11-10 18:48:46 [[32minfo[39m]: Redis: Connected and ready
2025-11-10 18:48:46 [[32minfo[39m]: Γ£à Redis caching enabled
  console.log
    Γ£à Connected to MongoDB Atlas test database

      at log (tests/testUtils/dbHandler.js:26:11)

  console.warn
    ΓÜá∩╕Å  Coupon applied despite not meeting minSubtotal - backend may need fixing

    [0m [90m 158 |[39m       [90m// For now, accept either behavior[39m
     [90m 159 |[39m       [36mif[39m (couponAdjustment) {
    [31m[1m>[22m[39m[90m 160 |[39m         console[33m.[39mwarn([32m'ΓÜá∩╕Å  Coupon applied despite not meeting minSubtotal - backend may need fixing'[39m)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 161 |[39m       }
     [90m 162 |[39m     })[33m;[39m
     [90m 163 |[39m[0m

      at Object.warn (tests/coupons.test.js:160:17)

  console.log
    Γ£à Test database dropped

      at log (tests/testUtils/dbHandler.js:37:15)

  console.log
    Γ£à Test database connection closed

      at log (tests/testUtils/dbHandler.js:41:15)

PASS tests/coupons.test.js (6.831 s)
  Coupons - Integration Tests
    Coupon Application via Quote Endpoint
      ΓêÜ should apply valid percentage coupon correctly (1591 ms)
      ΓêÜ should reject expired coupon (576 ms)
      ΓêÜ should apply coupon only when min subtotal is met (568 ms)
      ΓêÜ should apply category-specific coupon (554 ms)
      ΓêÜ should handle case-insensitive coupon codes (563 ms)
    Admin Coupon Management
      ΓêÜ should list all coupons (516 ms)

-------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File                     | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
-------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All files                |   19.85 |    14.16 |   18.16 |   20.45 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
 controllers             |   33.68 |    30.89 |   29.78 |    34.4 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  clientsController.js   |    2.24 |        0 |       0 |    2.43 | 6-221                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
  ordersController.js    |   38.54 |    34.89 |   32.55 |   39.22 | 21-153,168,204-219,237-268,297,344-363,384-425,487,510,559-564,575-667,691,711-718,796,813-815,857-858,969-1324,1339-1340,1373                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 middleware              |   30.21 |    16.33 |   33.33 |   30.53 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  cache.js               |    38.8 |    21.42 |      40 |    38.8 | 18-22,29-34,47-48,55-65,84,101-168                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
  cdn.js                 |   21.42 |    29.26 |   21.42 |   21.81 | 37,56,67-193                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
  couponValidation.js    |       0 |        0 |       0 |       0 | 1-214                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
  imageOptimization.js   |   22.53 |     5.35 |   14.28 |   22.53 | 52-66,86-230                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
  pagination.js          |   55.55 |    26.66 |      50 |   55.55 | 54-82                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
  validation.js          |   93.47 |    72.72 |     100 |   97.67 | 226                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
  verifyFirebaseToken.js |    7.31 |        0 |       0 |    7.31 | 16-132                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
 routes                  |   15.25 |     8.04 |   12.35 |    15.9 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  admin.js               |    7.67 |     1.44 |       3 |    8.13 | 14,70-72,136-138,166-167,173-309,315-422,428-486,492-573,578-593,598-611,617-715,721-768,773-786,793-803,812-862,871-934,943-944,1000-1077,1082-1093,1099-1118,1123-1221,1226-1246,1252-1261,1267-1351,1372-1380,1389-1458,1467-1468,1477-1490,1499-1577,1581-1769,1778-1876,1886-2006,2014-2025,2030-2035,2040-2061,2066-2098,2103-2123,2129-2155,2161-2266,2272-2370,2375,2378,2387-2415,2425-2498,2508-2571,2581-2614,2624-2666,2677-2702,2707-2715,2720-2740,2745-2768,2773-2834,2839-2859,2865-2880,2884-2898,2902-2915,2921-2936,2940-2948,2952-2965,2972-3061,3068-3133,3140-3155,3163-3188,3193-3215,3220-3232,3238-3251,3257-3316,3321-3343,3349-3371,3376-3393,3399-3441,3447-3481,3487-3517,3522-3537,3543-3562,3568-3581 
  auth.js                |   18.65 |    13.14 |      20 |   20.52 | 22,33-58,122,128,141,156-157,164-194,200-225,232-281,287-349,360-398,406-440,446-452,459-494,501-575                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
  cart.js                |   85.18 |    66.66 |     100 |   84.61 | 14-15,44-45                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  clients.js             |   24.32 |        0 |       0 |   29.03 | 15-26,32-61                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  delivery.js            |    3.01 |        0 |       0 |    3.15 | 23-93,99-282,288-463,469-760,764-898,904-1044,1050-1210,1216-1371,1377-1426,1432-1464,1470-1514,1520-1733,1739-1769,1776-1839,1846-1955,1963-2162,2168-2217,2223-2249,2256-2442,2452-2730                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  orders.js              |    12.5 |        0 |       0 |   13.22 | 30-132,147-165,170-264                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
  products.js            |   67.32 |    54.85 |    64.7 |   68.55 | 18-60,93-94,123-124,132-169,185,199,215,218-229,238-240,242-243,288,348-349,359,361,412-413                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  restaurant_manage.js   |   22.58 |        0 |       0 |   25.92 | 9-14,19-25,31-57                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
  restaurants.js         |   13.46 |        0 |       0 |   15.21 | 12-100                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
  reviews.js             |   13.18 |        0 |       0 |   13.63 | 17-80,92-151,163-187,199-241,253-287,299-320                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
  seller.js              |   25.29 |     18.9 |   27.41 |   25.87 | 23-33,50-51,93-94,103,114-115,124,135-136,147,168-169,179-180,248-249,254-304,310-369,375-385,402,409,418,445-446,472-480,485,497-531,541-544,553,559,585,599-600,606-673,689-818,827-846,852-871,878-984,990-1017,1032-1422,1439-1546,1559-1609,1618-1646,1661-1719,1734-1835,1889-1890,1900-1937,1947-2007,2021-2111                                                                                                                                                                                                                                                                                                                                                                                                               
  tokens.js              |   21.73 |        0 |       0 |   21.73 | 8-39                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
  uploads.js             |   84.21 |    57.14 |   66.66 |   87.03 | 56-57,76-77,90-92                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
  users.js               |   14.43 |        0 |       0 |   14.58 | 7-12,17-25,31-48,54-79,85-99,105-114,120-133,139-159,165-193,202-218                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
  wishlist.js            |   17.74 |        0 |       0 |   18.03 | 15-63,75-109,121-136,148-174,186-202                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
 services                |   36.76 |    31.13 |   34.14 |   37.65 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  geocode.js             |   15.21 |     6.89 |       0 |   17.07 | 13-70                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
  orderEvents.js         |    12.5 |    13.33 |   15.38 |   11.53 | 8-22,29-54,61-135                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
  pricing.js             |   44.77 |    29.26 |   55.55 |   43.54 | 7-56,65,76,95,119-132                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
  push.js                |   54.19 |    38.72 |      70 |   56.42 | 6-75,86-89,94-96,101,146-149,170,174-177,183,187-193,276,290-309,328-331,350-354,371-372                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  upi.js                 |       0 |      100 |       0 |       0 | 3-8                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
-------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Test Suites: 5 failed, 4 passed, 9 total
Tests:       31 failed, 80 passed, 111 total
Snapshots:   0 total
Time:        102.051 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
