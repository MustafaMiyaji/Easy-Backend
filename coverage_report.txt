
> backend@1.0.0 test
> jest --coverage --verbose

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

npm : FAIL tests/admin_phase25_6.test.js (6.823 s)
At line:1 char:1
+ npm test 2>&1 | Out-File -FilePath coverage_report.txt -Encoding utf8 ...
+ ~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (FAIL tests/admi...st.js (6.823 s):String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
  Phase 25.6: Admin Panel Testing
    Section 1: Reporting & Overview (Lines 307-425)
      ├ù GET /api/admin/reporting/overview - should return platform metrics (87 ms)
      ΓêÜ GET /api/admin/reporting/overview - should use default date range (30 days) (56 ms)
      ├ù GET /api/admin/reporting/overview - should exclude cancelled orders (110 ms)
      ΓêÜ GET /api/admin/reporting/overview - should handle database errors (7 ms)
    Section 2: Fraud Detection (Lines 421-490)
      ΓêÜ GET /api/admin/fraud/signals - should detect rapid orders (3 within 10 min) (255 ms)
      ΓêÜ GET /api/admin/fraud/signals - should detect high COD amounts (>2000) (150 ms)
      ΓêÜ GET /api/admin/fraud/signals - should detect high refund rate (>40%) (328 ms)
      ΓêÜ GET /api/admin/fraud/signals - should use default 7-day window (93 ms)
      ΓêÜ GET /api/admin/fraud/signals - should handle database errors (50 ms)
    Section 3: Automated Alerts (Lines 491-577)
      ΓêÜ POST /api/admin/alerts/evaluate - should detect order count drop (648 ms)
      ΓêÜ POST /api/admin/alerts/evaluate - should use default 1-day window (94 ms)
      ΓêÜ POST /api/admin/alerts/evaluate - should handle database errors (50 ms)
    Section 4: Seller Approval (Lines 767-790)
      ΓêÜ PATCH /api/admin/sellers/:id/approve - should approve seller (106 ms)
      ΓêÜ PATCH /api/admin/sellers/:id/approve - should reject invalid seller ID (7 ms)
      ΓêÜ PATCH /api/admin/sellers/:id/approve - should return 404 for non-existent seller (52 ms)
      ΓêÜ PATCH /api/admin/sellers/:id/approve - should handle database errors (7 ms)
    Section 5: Platform Settings (Lines 1098-1225)
      ΓêÜ GET /api/admin/settings - should return platform settings (102 ms)
      ΓêÜ PUT /api/admin/settings - should update delivery charge (54 ms)
      ΓêÜ PUT /api/admin/settings - should update coupons array (57 ms)
      ΓêÜ PUT /api/admin/settings - should filter invalid coupon codes (55 ms)
      ΓêÜ PUT /api/admin/settings - should filter invalid categories (54 ms)
      ΓêÜ PUT /api/admin/settings - should handle database errors (7 ms)
    Section 6: Product Management (Lines 999-1081)
      ΓêÜ GET /api/admin/products - should list all products with pagination (52 ms)
      ΓêÜ GET /api/admin/products - should filter by seller_id (50 ms)
      ΓêÜ GET /api/admin/products - should search by product name (50 ms)
      ΓêÜ GET /api/admin/products - should handle database errors (7 ms)
      ΓêÜ GET /api/admin/product-categories - should return unique categories (51 ms)
    Section 7: Device Token Management (Lines 1225-1351)
      ΓêÜ GET /api/admin/device-tokens - should list all device tokens (51 ms)
      ΓêÜ GET /api/admin/device-tokens - should filter by userId (49 ms)
      ΓêÜ GET /api/admin/device-tokens - should respect limit parameter (49 ms)
      ΓêÜ GET /api/admin/device-tokens - should sort by last_seen descending (48 ms)
      ΓêÜ GET /api/admin/device-tokens/by-client - should return tokens for specific UID (49 ms)
      ΓêÜ GET /api/admin/device-tokens/by-client - should reject missing uid (6 ms)
      ΓêÜ GET /api/admin/device-tokens/by-client - should return empty for non-existent UID (51 ms)
      ΓêÜ GET /api/admin/device-tokens - should handle database errors (6 ms)
    Section 8: Test Push Notifications (Lines 1266-1351)
      ΓêÜ POST /api/admin/test-push - should reject when no tokens found (50 ms)
      ΓêÜ POST /api/admin/test-push - should attempt to send notification with valid userId (49 ms)
      ΓêÜ POST /api/admin/test-push - should handle Firebase not initialized (6 ms)

  ΓùÅ Phase 25.6: Admin Panel Testing ΓÇ║ Section 1: Reporting & Overview (Lines 307-425) ΓÇ║ GET /api/admin/reporting/overview - should return platform metrics

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1
    Received:    0

    [0m [90m 157 |[39m       expect(response[33m.[39mbody[33m.[39mmetrics)[33m.[39mtoHaveProperty([32m"orderCount"[39m)[33m;[39m
     [90m 158 |[39m       expect(response[33m.[39mbody[33m.[39mmetrics)[33m.[39mtoHaveProperty([32m"averageOrderValue"[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 159 |[39m       expect(response[33m.[39mbody[33m.[39mmetrics[33m.[39morderCount)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m [90m// Should find our test 
order[39m
     [90m     |[39m                                                [31m[1m^[22m[39m
     [90m 160 |[39m     })[33m;[39m
     [90m 161 |[39m
     [90m 162 |[39m     test([32m"GET /api/admin/reporting/overview - should use default date range (30 days)"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.toBeGreaterThanOrEqual (tests/admin_phase25_6.test.js:159:48)

  ΓùÅ Phase 25.6: Admin Panel Testing ΓÇ║ Section 1: Reporting & Overview (Lines 307-425) ΓÇ║ GET /api/admin/reporting/overview - should exclude cancelled orders

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1
    Received:    0

    [0m [90m 199 |[39m       [90m// Cancelled order should not affect revenue[39m
     [90m 200 |[39m       expect(response[33m.[39mbody[33m.[39mmetrics)[33m.[39mtoHaveProperty([32m"orderCount"[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 201 |[39m       expect(response[33m.[39mbody[33m.[39mmetrics[33m.[39morderCount)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m
     [90m     |[39m                                                [31m[1m^[22m[39m
     [90m 202 |[39m     })[33m;[39m
     [90m 203 |[39m
     [90m 204 |[39m     test([32m"GET /api/admin/reporting/overview - should handle database errors"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.toBeGreaterThanOrEqual (tests/admin_phase25_6.test.js:201:48)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

FAIL tests/phase25_14_cdn.test.js
  Phase 25.14: CDN Middleware - Array Transformation
    Section 1: Array Handling (line 118)
      ΓêÜ 1.1: should handle array responses from products route (765 ms)
      ├ù 1.2: should handle array responses from seller products route (8 ms)
      ΓêÜ 1.3: should handle array responses from orders route (15 ms)
      ΓêÜ 1.4: should handle array responses from restaurants route (473 ms)

  ΓùÅ Phase 25.14: CDN Middleware - Array Transformation ΓÇ║ Section 1: Array Handling (line 118) ΓÇ║ 1.2: should handle array responses from seller products route

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [200, 401, 403, 404, 500]

    [0m [90m 46 |[39m         [33m.[39m[36mset[39m([32m"Accept"[39m[33m,[39m [32m"application/json"[39m)[33m;[39m
     [90m 47 |[39m
    [31m[1m>[22m[39m[90m 48 |[39m       expect([[35m200[39m[33m,[39m [35m401[39m[33m,[39m [35m403[39m[33m,[39m [35m404[39m[33m,[39m 
[35m500[39m])[33m.[39mtoContain(res[33m.[39mstatus)[33m;[39m
     [90m    |[39m                                         [31m[1m^[22m[39m
     [90m 49 |[39m     })[33m;[39m
     [90m 50 |[39m
     [90m 51 |[39m     it([32m"1.3: should handle array responses from orders route"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.toContain (tests/phase25_14_cdn.test.js:48:41)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒôí auto-backup env with Radar: https://dotenvx.com/radar

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [METRICS] Starting metrics fetch...

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [METRICS] Starting metrics fetch...

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [METRICS] Starting metrics fetch...

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [METRICS] Starting metrics fetch...

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [METRICS] Starting metrics fetch...

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/admin.test.js (630.355 s)
  POST /api/admin/login - Admin Login
    ΓêÜ should login successfully with valid credentials (2255 ms)
    ΓêÜ should login with case-insensitive email (945 ms)
    ΓêÜ should reject login with incorrect password (946 ms)
    ΓêÜ should reject login with non-existent email (878 ms)
    ΓêÜ should reject login with missing email (1101 ms)
    ΓêÜ should reject login with missing password (833 ms)
    ΓêÜ should handle login with bcrypt hashed password (normal case) (1091 ms)
  PUT /api/admin/change-password - Password Change
    ΓêÜ should change password successfully with valid current password (1264 ms)
    ΓêÜ should reject password change with incorrect current password (952 ms)
    ΓêÜ should reject password change with weak new password (842 ms)
    ΓêÜ should reject password change when new password equals current password (844 ms)
    ΓêÜ should reject password change with missing current password (844 ms)
    ΓêÜ should reject password change with missing new password (837 ms)
    ΓêÜ should reject password change without authentication (838 ms)
  requireAdmin Middleware - JWT Authentication
    ΓêÜ should allow access with valid JWT Bearer token (881 ms)
    ΓêÜ should reject access with invalid JWT token (871 ms)
    ΓêÜ should reject access with expired JWT token (867 ms)
    ΓêÜ should reject JWT token without admin role (843 ms)
    ΓêÜ should reject access without Authorization header (836 ms)
  requireAdmin Middleware - API Key Authentication
    ΓêÜ should allow access with valid API key in Bearer token (913 ms)
    ΓêÜ should allow access with valid API key in x-api-key header (1014 ms)
    ΓêÜ should reject access with invalid API key (871 ms)
  requireAdmin Middleware - Legacy Authentication
    ΓêÜ should allow access with legacy x-admin header (885 ms)
    ΓêÜ should reject access with invalid x-admin header value (833 ms)
  requireAdmin Middleware - Firebase Authentication
    ΓêÜ should allow access when Firebase user matches Admin document by firebase_uid (979 ms)
  GET /api/admin/clients - Client Management
    ΓêÜ should list all clients with pagination (982 ms)
    ΓêÜ should support pagination parameters (1026 ms)
    ΓêÜ should search clients by name (1030 ms)
    ΓêÜ should search clients by phone (1044 ms)
    ΓêÜ should require admin authentication (944 ms)
  GET /api/admin/sellers - Seller Management
    ΓêÜ should list all sellers with pagination (1186 ms)
    ΓêÜ should filter pending sellers only (1165 ms)
    ΓêÜ should support legacy status=pending parameter (1184 ms)
    ΓêÜ should search sellers by business name (1603 ms)
    ΓêÜ should require admin authentication (1118 ms)
  PATCH /api/admin/sellers/:id/approve - Seller Approval
    ΓêÜ should approve a pending seller (1124 ms)
    ΓêÜ should reject invalid seller ID (1032 ms)
    ΓêÜ should return 404 for non-existent seller (1069 ms)
    ΓêÜ should require admin authentication (1014 ms)
  GET /api/admin/sellers/:sellerId - Seller Details
    ΓêÜ should get seller details by ID (1084 ms)
    ΓêÜ should reject invalid seller ID (1055 ms)
    ΓêÜ should return 404 for non-existent seller (1045 ms)
  GET /api/admin/delivery-agents - Delivery Agent Management
    ΓêÜ should list all delivery agents with pagination (1030 ms)
    ΓêÜ should support pagination parameters (1032 ms)
    ΓêÜ should require admin authentication (937 ms)
  GET /api/admin/delivery-agents/pending - Pending Agents
    ΓêÜ should list only pending delivery agents (984 ms)
    ΓêÜ should return empty array when no pending agents (1033 ms)
  PATCH /api/admin/delivery-agents/:id/approve - Agent Approval
    ΓêÜ should approve a pending delivery agent (1027 ms)
    ΓêÜ should reject invalid agent ID (936 ms)
    ΓêÜ should return 404 for non-existent agent (975 ms)
  PATCH /api/admin/delivery-agents/:id/reject - Agent Rejection
    ΓêÜ should reject/suspend a delivery agent (1019 ms)
    ΓêÜ should reject invalid agent ID (932 ms)
    ΓêÜ should return 404 for non-existent agent (985 ms)
  GET /api/admin/delivery-agents/:id - Agent Details
    ΓêÜ should get delivery agent details by ID (1074 ms)
    ΓêÜ should reject invalid agent ID (948 ms)
    ΓêÜ should return 404 for non-existent agent (980 ms)
  GET /api/admin/settings - Platform Settings
    ΓêÜ should return default settings when none exist (940 ms)
    ΓêÜ should return existing settings (989 ms)
    ΓêÜ should require admin authentication (883 ms)
  PUT /api/admin/settings - Update Platform Settings
    ΓêÜ should update delivery charges (985 ms)
    ΓêÜ should coerce negative values to zero (987 ms)
    ΓêÜ should update boolean settings (972 ms)
    ΓêÜ should require admin authentication (885 ms)
  GET /api/admin/coupons - List Coupons
    ΓêÜ should list all coupons (977 ms)
    ΓêÜ should return empty array when no settings exist (1712 ms)
    ΓêÜ should require admin authentication (927 ms)
  POST /api/admin/coupons - Create Coupon
    ΓêÜ should create a new coupon (970 ms)
    ΓêÜ should convert coupon code to uppercase (1442 ms)
    ΓêÜ should reject duplicate coupon codes (1096 ms)
    ΓêÜ should reject invalid percent values (888 ms)
    ΓêÜ should reject missing required fields (891 ms)
    ΓêÜ should require admin authentication (991 ms)
  PUT /api/admin/coupons/:code - Update Coupon
    ΓêÜ should update coupon fields (1065 ms)
    ΓêÜ should reject invalid percent values (1051 ms)
    ΓêÜ should return 404 for non-existent coupon (1031 ms)
    ΓêÜ should require admin authentication (976 ms)
  DELETE /api/admin/coupons/:code - Delete Coupon
    ΓêÜ should delete a coupon (1118 ms)
    ΓêÜ should return 404 for non-existent coupon (1033 ms)
    ΓêÜ should require admin authentication (990 ms)
  GET /api/admin/coupons/:code/usage - Coupon Usage Statistics
    ΓêÜ should return coupon usage statistics (1073 ms)
    ΓêÜ should return 404 for non-existent coupon (1194 ms)
    ΓêÜ should require admin authentication (988 ms)
  GET /api/admin/metrics - Platform Metrics
    ΓêÜ should return platform metrics (1190 ms)
    ΓêÜ should calculate sales and discounts correctly (1152 ms)
    ΓêÜ should require admin authentication (1101 ms)
  GET /api/admin/orders - Order Listing
    ΓêÜ should list all orders (1099 ms)
    ΓêÜ should support pagination (1092 ms)
    ΓêÜ should filter by payment status (1088 ms)
    ΓêÜ should filter by delivery status (1094 ms)
    ΓêÜ should filter by payment method (1182 ms)
    ΓêÜ should filter by amount range (1112 ms)
    ΓêÜ should search orders by client ID (1102 ms)
    ΓêÜ should require admin authentication (1316 ms)
  PUT /api/admin/orders/:id - Update Order
    ΓêÜ should update order fields (1113 ms)
    ΓêÜ should reject invalid order ID (1062 ms)
    ΓêÜ should return 404 for non-existent order (1103 ms)
    ΓêÜ should require admin authentication (1059 ms)
  PATCH /api/admin/orders/:id/payment - Update Payment Status
    ΓêÜ should update payment status (1713 ms)
    ΓêÜ should require admin authentication (1045 ms)
  PATCH /api/admin/orders/:id/delivery - Update Delivery Status
    ΓêÜ should update delivery status (1488 ms)
    ΓêÜ should require admin authentication (1063 ms)
  GET /api/admin/products - Product Listing
    ΓêÜ should list all products with pagination (1094 ms)
    ΓêÜ should support pagination parameters (1088 ms)
    ΓêÜ should filter products by category (1097 ms)
    ΓêÜ should filter products by seller ID (1083 ms)
    ΓêÜ should search products by name (1363 ms)
    ΓêÜ should require admin authentication (1060 ms)
  GET /api/admin/product-categories - Product Categories
    ΓêÜ should return distinct product categories (1099 ms)
    ΓêÜ should return sorted categories (1099 ms)
    ΓêÜ should require admin authentication (1057 ms)
  POST /api/admin/products - Create Product
    ΓêÜ should create a new product (1064 ms)
    ΓêÜ should set restaurant product stock to 100000 (1059 ms)
    ΓêÜ should set inactive status when published is false (1070 ms)
    ΓêÜ should reject product without required fields (1009 ms)
    ΓêÜ should require admin authentication (1004 ms)
  PUT /api/admin/products/:id - Update Product
    ΓêÜ should update product fields (1366 ms)
    ΓêÜ should update product status via published field (1091 ms)
    ΓêÜ should update stock via in_stock field (1106 ms)
    ΓêÜ should reject invalid product ID (1055 ms)
    ΓêÜ should return 404 for non-existent product (1092 ms)
    ΓêÜ should require admin authentication (1060 ms)
  PATCH /api/admin/products/:id - Patch Product
    ΓêÜ should partially update product (1089 ms)
    ΓêÜ should handle image_url field (1109 ms)
    ΓêÜ should reject invalid product ID (1047 ms)
    ΓêÜ should return 404 for non-existent product (1365 ms)
    ΓêÜ should require admin authentication (1046 ms)
  DELETE /api/admin/products/:id - Delete Product
    ΓêÜ should delete a product (1155 ms)
    ΓêÜ should reject invalid product ID (1041 ms)
    ΓêÜ should return 404 for non-existent product (1096 ms)
    ΓêÜ should require admin authentication (1039 ms)
  GET /api/admin/reporting/overview - Reporting Overview
    ΓêÜ should return reporting overview with metrics (1229 ms)
    ΓêÜ should support date range filters (1232 ms)
    ΓêÜ should require admin authentication (1150 ms)
  PATCH /api/admin/sellers/:sellerId - Update Seller Location
    ΓêÜ should update seller address (1097 ms)
    ΓêÜ should update seller location coordinates (1293 ms)
    ΓêÜ should update both address and location (1090 ms)
    ΓêÜ should reject invalid seller ID (995 ms)
    ΓêÜ should return 404 for non-existent seller (1047 ms)
    ΓêÜ should require admin authentication (993 ms)
  GET /api/admin/sellers/:sellerId/test-pickup - Test Pickup Address
    ΓêÜ should return pickup address information (1047 ms)
    ΓêÜ should use address as primary source (1315 ms)
    ΓêÜ should reject invalid seller ID (985 ms)
    ΓêÜ should return 404 for non-existent seller (1048 ms)
    ΓêÜ should require admin authentication (1006 ms)
  GET /api/admin/roles - List Admin Roles
    ΓêÜ should list all admins with roles (939 ms)
    ΓêÜ should require admin authentication (892 ms)
  POST /api/admin/roles - Create Admin Role
    ΓêÜ should create a new admin (1058 ms)
    ΓêÜ should reject duplicate email (1066 ms)
    ΓêÜ should reject invalid email (910 ms)
    ΓêÜ should reject invalid role (901 ms)
    ΓêÜ should reject weak password (940 ms)
    ΓêÜ should require admin authentication (897 ms)
  GET /api/admin/payouts - List Payouts
    ΓêÜ should list payouts with pagination (1265 ms)
    ΓêÜ should support pagination parameters (1195 ms)
    ΓêÜ should support search filter (1182 ms)
    ΓêÜ should require admin authentication (1136 ms)
  PHASE 7: Fraud Detection System
    ΓêÜ should detect rapid fire orders (3+ orders in 10 minutes) (1292 ms)
    ΓêÜ should detect high COD orders (amount > Γé╣2000) (1209 ms)
    ΓêÜ should detect high refund rate (>40% of orders refunded) (1371 ms)
    ΓêÜ should require admin authentication (1086 ms)
  PHASE 7: Automated Alerts Evaluation
    ΓêÜ should generate revenue drop alert (>40% drop) (1529 ms)
    ΓêÜ should generate high refund ratio alert (>30%) (1745 ms)
    ΓêÜ should prevent duplicate alerts (check unacknowledged) (1313 ms)
    ΓêÜ should handle custom date ranges (1190 ms)
    ΓêÜ should require admin authentication (1208 ms)
  PHASE 7: Alert Management
    ΓêÜ should list all alerts with pagination (1075 ms)
    ΓêÜ should filter unacknowledged alerts (983 ms)
    ΓêÜ should acknowledge an alert (1053 ms)
    ΓêÜ should require admin authentication (1203 ms)
  PHASE 7: Device Token Management
    ΓêÜ should list device tokens with userId filter (1116 ms)
    ΓêÜ should get tokens by client Firebase UID (1027 ms)
    ΓêÜ should send test push notification (or fail gracefully if no Firebase Admin) (1777 ms)
    ΓêÜ should handle missing Firebase Admin SDK gracefully (1226 ms)
    ΓêÜ should require admin authentication (993 ms)
  PHASE 16: Client CRUD Operations
    ΓêÜ should reject client creation without required fields (918 ms)
    ΓêÜ should update an existing client (986 ms)
    ΓêÜ should reject invalid client ID for update (885 ms)
    ΓêÜ should return 404 for non-existent client update (927 ms)
    ΓêÜ should require admin authentication (958 ms)
  PHASE 16: Seller Advanced CRUD
    ΓêÜ should create a new seller (987 ms)
    ΓêÜ should reject seller creation without required fields (894 ms)
    ΓêÜ should update seller with PUT (full update) (1037 ms)
    ΓêÜ should delete seller without cascade (1350 ms)
    ΓêÜ should delete seller with full cascade (1257 ms)
    ΓêÜ should reject invalid seller ID for delete (906 ms)
    ΓêÜ should return 404 for non-existent seller delete (928 ms)
    ΓêÜ should require admin authentication (1213 ms)
  PHASE 16: Delivery Agent Advanced Operations
    ΓêÜ should update delivery agent with PATCH (972 ms)
    ΓêÜ should reject invalid agent ID for patch (887 ms)
    ΓêÜ should return 404 for non-existent agent patch (998 ms)
    ΓêÜ should delete delivery agent without cascade (1157 ms)
    ΓêÜ should delete delivery agent with full cascade (1188 ms)
    ΓêÜ should reject invalid agent ID for delete (884 ms)
    ΓêÜ should return 404 for non-existent agent delete (933 ms)
    ΓêÜ should require admin authentication (881 ms)
  PHASE 16: Feedback Management
    ΓêÜ should create feedback as admin (982 ms)
    ΓêÜ should reject feedback without required fields (915 ms)
    ΓêÜ should update feedback status (1021 ms)
    ΓêÜ should reject invalid feedback ID (898 ms)
    ΓêÜ should return 404 for non-existent feedback (982 ms)
    ΓêÜ should require admin authentication (905 ms)
  PHASE 16: Payout Logs Advanced
    ΓêÜ should get payout summary (1209 ms)
    ΓêÜ should filter payout summary by seller (1153 ms)
    ΓêÜ should get detailed payout logs (1209 ms)
    ΓêÜ should support pagination for payout logs (968 ms)
    ΓêÜ should filter payout logs by status (944 ms)
    ΓêÜ should filter payout logs by seller (1145 ms)
    ΓêÜ should reject invalid earning log ID (886 ms)
    ΓêÜ should return 404 for non-existent earning log (931 ms)
    ΓêÜ should require admin authentication (896 ms)
  Phase 17 Section 1: Client Error Handling
    ΓêÜ PUT /api/admin/clients/:id - should handle invalid ObjectId (1035 ms)
    ΓêÜ PUT /api/admin/clients/:id - should handle client not found (1313 ms)
    ΓêÜ PUT /api/admin/clients/:id - should successfully update client (1076 ms)
  Phase 17 Section 2: Seller Error Handling
    ΓêÜ PUT /api/admin/sellers/:id - should handle invalid ObjectId (1284 ms)
    ΓêÜ PUT /api/admin/sellers/:id - should handle seller not found (1023 ms)
    ΓêÜ PUT /api/admin/sellers/:id - should successfully update seller (1151 ms)
    ΓêÜ PATCH /api/admin/sellers/:id - should handle invalid ObjectId (1010 ms)
    ΓêÜ PATCH /api/admin/sellers/:id - should handle seller not found (1026 ms)
    ΓêÜ PATCH /api/admin/sellers/:id - should successfully update seller (1191 ms)
  Phase 17 Section 3: Product CRUD Error Handling
    ΓêÜ PUT /api/admin/products/:id - should handle invalid ObjectId (992 ms)
    ΓêÜ PUT /api/admin/products/:id - should handle product not found (1038 ms)
    ΓêÜ PUT /api/admin/products/:id - should successfully update with published field (1228 ms)
    ΓêÜ PUT /api/admin/products/:id - should handle in_stock field conversion (1187 ms)
    ΓêÜ PUT /api/admin/products/:id - should handle image_url to image conversion (1192 ms)
    ΓêÜ PATCH /api/admin/products/:id - should handle invalid ObjectId (1005 ms)
    ΓêÜ PATCH /api/admin/products/:id - should handle product not found (1035 ms)
    ΓêÜ PATCH /api/admin/products/:id - should successfully update product (1219 ms)
    ΓêÜ DELETE /api/admin/products/:id - should handle invalid ObjectId (989 ms)
    ΓêÜ DELETE /api/admin/products/:id - should handle product not found (1066 ms)
    ΓêÜ DELETE /api/admin/products/:id - should successfully delete product (1479 ms)
  Phase 17 Section 4: Order Management Error Handling
    ΓêÜ PUT /api/admin/orders/:id - should handle invalid ObjectId (989 ms)
    ΓêÜ PUT /api/admin/orders/:id - should handle order not found (1028 ms)
    ΓêÜ PUT /api/admin/orders/:id - should successfully update order (1162 ms)
  Phase 17 Section 5: Delivery Agent Pending & Approval
    ΓêÜ GET /api/admin/delivery-agents/pending - should return pending agents (1081 ms)
    ΓêÜ PATCH /api/admin/delivery-agents/:id/approve - should approve agent (1384 ms)
    ΓêÜ GET /api/admin/delivery-agents - should include approved agents (1119 ms)
  Phase 19: Admin SSE Stream Endpoint
    ΓêÜ GET /api/admin/stream - should require admin authentication (no token) (990 ms)
    ΓêÜ GET /api/admin/stream - should require admin authentication (invalid token) (1027 ms)
    ΓêÜ GET /api/admin/stream - should accept valid admin authentication (1499 ms)
    ΓêÜ GET /api/admin/stream - should set SSE headers (1499 ms)
    ΓêÜ GET /api/admin/stream - should support concurrent connections (1528 ms)
  Phase 19.5: Additional Error Paths (60% Target)
    ΓêÜ PUT /api/admin/orders/:id - should return 404 when order not found (1054 ms)
    ΓêÜ DELETE /api/admin/products/:id - should handle database errors (1195 ms)
    ΓêÜ PUT /api/admin/orders/:id - should handle database errors during update (1092 ms)
  Phase 20.1: Campaign & Feedback Routes (100% Target)
    Campaign Management
      ΓêÜ GET /api/admin/campaigns - should list all campaigns with pagination (1178 ms)
      ΓêÜ GET /api/admin/campaigns - should filter by status (1176 ms)
      ΓêÜ GET /api/admin/campaigns - should handle database errors (1050 ms)
      ΓêÜ POST /api/admin/campaigns - should create campaign successfully (1121 ms)
      ΓêÜ POST /api/admin/campaigns - should create scheduled campaign (1076 ms)
      ΓêÜ POST /api/admin/campaigns - should reject missing title (1041 ms)
      ΓêÜ POST /api/admin/campaigns - should reject missing message (1025 ms)
      ΓêÜ POST /api/admin/campaigns - should handle database errors (1057 ms)
      ΓêÜ PATCH /api/admin/campaigns/:id - should update campaign successfully (1165 ms)
      ΓêÜ PATCH /api/admin/campaigns/:id - should reject invalid ID (1043 ms)
      ΓêÜ PATCH /api/admin/campaigns/:id - should return 404 for non-existent campaign (1079 ms)
      ΓêÜ PATCH /api/admin/campaigns/:id - should handle database errors (1111 ms)
    Feedback Management
      ΓêÜ GET /api/admin/feedback - should list all feedback with pagination (1460 ms)
      ΓêÜ GET /api/admin/feedback - should filter by status (1199 ms)
      ΓêÜ GET /api/admin/feedback - should handle database errors (1093 ms)
      ΓêÜ POST /api/admin/feedback - should create feedback successfully (1094 ms)
      ΓêÜ POST /api/admin/feedback - should reject missing user_id (1038 ms)
      ΓêÜ POST /api/admin/feedback - should reject missing message (1034 ms)
      ΓêÜ POST /api/admin/feedback - should handle database errors (1034 ms)
      ΓêÜ PATCH /api/admin/feedback/:id - should update feedback successfully (1179 ms)
      ΓêÜ PATCH /api/admin/feedback/:id - should reject invalid ID (1292 ms)
      ΓêÜ PATCH /api/admin/feedback/:id - should return 404 for non-existent feedback (1070 ms)
      ΓêÜ PATCH /api/admin/feedback/:id - should handle database errors (1075 ms)
  Phase 20.2: requireAdmin Middleware Edge Cases (100% Target)
    ΓêÜ GET /api/admin/clients - should handle JWT_SECRET gracefully (1131 ms)
    ΓêÜ Multiple rapid requests - should not hit rate limit in test mode (1454 ms)
    ΓêÜ GET /api/admin/clients - should log request even without admin (1131 ms)
    ΓêÜ GET /api/admin/clients - should reject malformed Bearer token (1094 ms)
    ΓêÜ GET /api/admin/clients - should reject expired JWT token (1102 ms)
    ΓêÜ GET /api/admin/clients - should reject JWT with non-admin role (1103 ms)
    ΓêÜ GET /api/admin/clients - should handle Firebase auth fallback path (1191 ms)
    ΓêÜ GET /api/admin/clients - should accept valid x-api-key header (1130 ms)
    ΓêÜ GET /api/admin/clients - should accept API key as Bearer token (1393 ms)
    ΓêÜ GET /api/admin/clients - should handle Firebase auth errors gracefully (1140 ms)
    ΓêÜ GET /api/admin/clients - should accept legacy x-admin header (1143 ms)
  Phase 20.3-20.5: Client, Seller, Product Routes Edge Cases (100% Target)
    Client Routes Edge Cases
      ΓêÜ GET /api/admin/clients - should handle roles enrichment errors gracefully (1256 ms)
      ΓêÜ GET /api/admin/clients - should handle search with special characters (1621 ms)
      ΓêÜ GET /api/admin/clients - should handle database errors (1210 ms)
    Seller Routes Edge Cases
      ΓêÜ GET /api/admin/sellers - should handle search with regex patterns (1430 ms)
      ΓêÜ GET /api/admin/sellers - should return array for legacy status=pending (1236 ms)
      ΓêÜ GET /api/admin/sellers - should handle database errors (1234 ms)
      ΓêÜ PATCH /api/admin/sellers/:id/approve - should handle database errors (1208 ms)
    Product Routes Edge Cases
      ΓêÜ GET /api/admin/products - should handle search with regex escape (1316 ms)
      ΓêÜ GET /api/admin/products - should handle database errors (1203 ms)
      ΓêÜ GET /api/admin/product-categories - should handle database errors (1205 ms)
      ΓêÜ POST /api/admin/products - should set high stock for restaurant products (1410 ms)
      ΓêÜ POST /api/admin/products - should handle database errors (1197 ms)
      ΓêÜ PUT /api/admin/products/:id - should convert published to status (1308 ms)
      ΓêÜ PUT /api/admin/products/:id - should convert image_url to image (1246 ms)
      ΓêÜ PUT /api/admin/products/:id - should handle database errors (1243 ms)
      ΓêÜ PATCH /api/admin/products/:id - should handle image_url field (1240 ms)
      ΓêÜ PATCH /api/admin/products/:id - should handle database errors (1196 ms)
  Phase 20.6: Order Routes Complex Scenarios (100% Target)
    Order Listing & Filtering
      ΓêÜ GET /api/admin/device-tokens - should handle database errors (1457 ms)
      ΓêÜ GET /api/admin/device-tokens/by-client - should require uid parameter (1521 ms)
      ΓêÜ GET /api/admin/device-tokens/by-client - should handle database errors (1283 ms)
      ΓêÜ POST /api/admin/test-push - should reject when Firebase Admin not initialized (1284 ms)
      ΓêÜ POST /api/admin/test-push - should reject when no tokens found (1330 ms)
    Backfill Migrations
      ΓêÜ POST /api/admin/migrations/backfill-locations/start - should reject if already running (1434 ms)
      ΓêÜ GET /api/admin/migrations/backfill-locations/progress - should return job status (1268 ms)
      ΓêÜ GET /api/admin/migrations/backfill-locations/preview-count - should handle database errors (1245 ms)
    Order Address Fixing
      ΓêÜ POST /api/admin/orders/:orderId/fix-address - should require GOOGLE_MAPS_API_KEY (1179 ms)
      ΓêÜ POST /api/admin/orders/:orderId/fix-address - should reject non-existent order (1293 ms)
      ΓêÜ POST /api/admin/orders/:orderId/fix-address - should accept direct lat/lng (1318 ms)
      ΓêÜ POST /api/admin/orders/:orderId/fix-address - should parse lat,lng text (1643 ms)
      ΓêÜ POST /api/admin/orders/:orderId/fix-address - should handle errors gracefully (1226 ms)
    Available Delivery Agents
      ΓêÜ GET /api/admin/orders/:orderId/available-agents - should reject non-existent order (1266 ms)
      ΓêÜ GET /api/admin/orders/:orderId/available-agents - should reject unpaid orders (1286 ms)
      ΓêÜ GET /api/admin/orders/:orderId/available-agents - should reject when seller location unavailable (1431 ms)
      ΓêÜ GET /api/admin/orders/:orderId/available-agents - should handle database errors (1252 ms)
    Manual Agent Assignment
      ΓêÜ POST /api/admin/orders/:orderId/assign-delivery-agent - should require agent_id or agent_email (1280 ms)
      ΓêÜ POST /api/admin/orders/:orderId/assign-delivery-agent - should reject non-existent order (1290 ms)
      ΓêÜ POST /api/admin/orders/:orderId/assign-delivery-agent - should reject unpaid orders (1363 ms)
      ΓêÜ POST /api/admin/orders/:orderId/assign-delivery-agent - should reject non-existent agent (1352 ms)
      ΓêÜ POST /api/admin/orders/:orderId/assign-delivery-agent - should reject unapproved agent (1379 ms)
      ΓêÜ POST /api/admin/orders/:orderId/assign-delivery-agent - should reject offline agent without force (1400 ms)
      ΓêÜ POST /api/admin/orders/:orderId/assign-delivery-agent - should assign agent successfully (1392 ms)
      ΓêÜ POST /api/admin/orders/:orderId/assign-delivery-agent - should handle already assigned agent (1449 ms)
      ΓêÜ POST /api/admin/orders/:orderId/assign-delivery-agent - should handle database errors (1249 ms)
    Admin Roles Management
      ΓêÜ GET /api/admin/roles - should list all admins (1244 ms)
      ΓêÜ GET /api/admin/roles - should handle database errors (1199 ms)
      ΓêÜ POST /api/admin/roles - should require valid email (1170 ms)
      ΓêÜ POST /api/admin/roles - should require valid role (1270 ms)
      ΓêÜ POST /api/admin/roles - should require password with min 4 chars (1177 ms)
      ΓêÜ POST /api/admin/roles - should reject duplicate email (1232 ms)
      ΓêÜ POST /api/admin/roles - should create new admin successfully (1312 ms)
      ΓêÜ PATCH /api/admin/roles/:id - should require valid admin ID (1224 ms)
      ΓêÜ PATCH /api/admin/roles/:id - should require valid role (1177 ms)
      ΓêÜ PATCH /api/admin/roles/:id - should reject non-existent admin (1223 ms)
      ΓêÜ PATCH /api/admin/roles/:id - should prevent demoting last superadmin (1390 ms)
      ΓêÜ PATCH /api/admin/roles/:id - should handle database errors (1287 ms)
    Backfill Stop Endpoint
      ΓêÜ POST /api/admin/migrations/backfill-locations/stop - should reject when no job running (1226 ms)
    Phase 20.7: Delivery Agent Management & Analytics
      ΓêÜ DELETE /api/admin/roles/:id - should reject invalid admin id (1280 ms)
      ΓêÜ DELETE /api/admin/roles/:id - should reject deleting non-existent admin (1315 ms)
      ΓêÜ DELETE /api/admin/roles/:id - should prevent deleting last superadmin (1502 ms)
      ΓêÜ DELETE /api/admin/roles/:id - should successfully delete moderator admin (1413 ms)
      ΓêÜ GET /api/admin/payouts - should return payout aggregations with pagination (1522 ms)
      ΓêÜ GET /api/admin/payouts - should filter by search query (1535 ms)
      ΓêÜ GET /api/admin/payouts - should respect pagination parameters (1600 ms)
      ΓêÜ GET /api/admin/metrics - should return platform metrics (1722 ms)
      ΓêÜ GET /api/admin/metrics - should differentiate restaurants from sellers (1389 ms)
      ΓêÜ GET /api/admin/metrics - should count pure clients correctly (1447 ms)
    Phase 20.8: Platform Settings & Coupons
      ΓêÜ GET /api/admin/settings - should return default settings when none exist (1333 ms)
      ΓêÜ GET /api/admin/settings - should return existing settings (1344 ms)
      ΓêÜ PUT /api/admin/settings - should update delivery charges (1450 ms)
      ΓêÜ PUT /api/admin/settings - should coerce negative values to zero (1290 ms)
      ΓêÜ PUT /api/admin/settings - should update boolean settings (1416 ms)
      ΓêÜ GET /api/admin/coupons - should list all coupons (1413 ms)
      ΓêÜ GET /api/admin/coupons - should return empty array when no settings exist (1394 ms)
      ΓêÜ POST /api/admin/coupons - should create a new coupon (1433 ms)
      ΓêÜ POST /api/admin/coupons - should convert coupon code to uppercase (1364 ms)
      ΓêÜ POST /api/admin/coupons - should reject duplicate coupon codes (1523 ms)
      ΓêÜ POST /api/admin/coupons - should reject invalid percent values (1291 ms)
      ΓêÜ POST /api/admin/coupons - should reject missing required fields (1293 ms)
      ΓêÜ PUT /api/admin/coupons/:code - should update coupon fields (1466 ms)
      ΓêÜ PUT /api/admin/coupons/:code - should reject invalid percent values (1433 ms)
      ΓêÜ PUT /api/admin/coupons/:code - should return 404 for non-existent coupon (1309 ms)
      ΓêÜ DELETE /api/admin/coupons/:code - should delete a coupon (1585 ms)
      ΓêÜ DELETE /api/admin/coupons/:code - should return 404 for non-existent coupon (1577 ms)
      ΓêÜ GET /api/admin/coupons/:code/usage - should return coupon usage statistics (1517 ms)
      ΓêÜ GET /api/admin/coupons/:code/usage - should return 404 for non-existent coupon (1309 ms)
    Phase 20.9: Feedback Management & Payout Logs
      ΓêÜ GET /api/admin/feedback - should list all feedback with pagination (1556 ms)
      ΓêÜ GET /api/admin/feedback - should filter by status (1723 ms)
      ΓêÜ GET /api/admin/feedback - should handle database errors (1595 ms)
      ΓêÜ POST /api/admin/feedback - should create feedback successfully (1452 ms)
      ΓêÜ POST /api/admin/feedback - should reject missing user_id (1624 ms)
      ΓêÜ POST /api/admin/feedback - should reject missing message (1446 ms)
      ΓêÜ POST /api/admin/feedback - should handle database errors (1410 ms)
      ΓêÜ PATCH /api/admin/feedback/:id - should update feedback successfully (1466 ms)
      ΓêÜ PATCH /api/admin/feedback/:id - should reject invalid ID (1422 ms)
      ΓêÜ PATCH /api/admin/feedback/:id - should return 404 for non-existent feedback (1504 ms)
      ΓêÜ PATCH /api/admin/feedback/:id - should handle database errors (1400 ms)
      ΓêÜ GET /api/admin/payouts/summary - should return payout summary (1552 ms)
      ΓêÜ GET /api/admin/payouts/summary - should filter by sellerId (1548 ms)
      ΓêÜ GET /api/admin/payouts/summary - should handle date range filters (1501 ms)
      ΓêÜ GET /api/admin/payouts/summary - should handle database errors (1495 ms)
      ΓêÜ GET /api/admin/payouts/logs - should list payout logs with pagination (1818 ms)
      ΓêÜ GET /api/admin/payouts/logs - should filter by role (seller) (1747 ms)
      ΓêÜ GET /api/admin/payouts/logs - should filter by paid status (1501 ms)
      ΓêÜ GET /api/admin/payouts/logs - should filter by sellerId (1491 ms)
      ΓêÜ GET /api/admin/payouts/logs - should handle database errors (1439 ms)
      ΓêÜ PATCH /api/admin/payouts/logs/:id/paid - should mark payout as paid (1450 ms)
      ΓêÜ PATCH /api/admin/payouts/logs/:id/paid - should reject invalid ID (1472 ms)
      ΓêÜ PATCH /api/admin/payouts/logs/:id/paid - should return 404 for non-existent log (1453 ms)
      ΓêÜ PATCH /api/admin/payouts/logs/:id/paid - should handle database errors (1424 ms)
    Phase 20.10: Alert Management Routes
      Alert Evaluation
        ΓêÜ POST /api/admin/alerts/evaluate - should evaluate and create alerts (1554 ms)
        ΓêÜ POST /api/admin/alerts/evaluate - should detect revenue drop (1676 ms)
        ΓêÜ POST /api/admin/alerts/evaluate - should detect high refund ratio (1912 ms)
        ΓêÜ POST /api/admin/alerts/evaluate - should not duplicate alerts (1641 ms)
        ΓêÜ POST /api/admin/alerts/evaluate - should handle database errors (1476 ms)
      Alert Listing
        ΓêÜ GET /api/admin/alerts - should list alerts with pagination (1860 ms)
        ΓêÜ GET /api/admin/alerts?unacked=1 - should filter unacknowledged alerts (1566 ms)
        ΓêÜ GET /api/admin/alerts - should handle pagination parameters (1558 ms)
        ΓêÜ GET /api/admin/alerts - should handle database errors (1854 ms)
      Alert Acknowledgment
        ΓêÜ POST /api/admin/alerts/:id/ack - should acknowledge alert (1527 ms)
        ΓêÜ POST /api/admin/alerts/:id/ack - should reject invalid alert ID (1461 ms)
        ΓêÜ POST /api/admin/alerts/:id/ack - should return 404 for non-existent alert (1512 ms)
        ΓêÜ POST /api/admin/alerts/:id/ack - should handle database errors (1451 ms)
    Phase 20.11: Order Address Fixing & Available Agents
      Order Address Fixing
        ΓêÜ POST /api/admin/orders/:orderId/fix-address - should reject when no GOOGLE_MAPS_API_KEY (1510 ms)
        ΓêÜ POST /api/admin/orders/:orderId/fix-address - should reject non-existent order (1604 ms)
        ΓêÜ POST /api/admin/orders/:orderId/fix-address - should accept direct lat/lng (1601 ms)
        ΓêÜ POST /api/admin/orders/:orderId/fix-address - should handle errors gracefully (1502 ms)
      Available Delivery Agents
        ΓêÜ GET /api/admin/orders/:orderId/available-agents - should reject non-existent order (1615 ms)
        ΓêÜ GET /api/admin/orders/:orderId/available-agents - should reject unpaid order (1616 ms)
        ΓêÜ GET /api/admin/orders/:orderId/available-agents - should reject when seller location unavailable (1762 ms)
        ΓêÜ GET /api/admin/orders/:orderId/available-agents - should list agents with distance (1615 ms)
        ΓêÜ GET /api/admin/orders/:orderId/available-agents - should sort by online status then distance (1610 ms)
        ΓêÜ GET /api/admin/orders/:orderId/available-agents - should handle agents without location (1660 ms)
        ΓêÜ GET /api/admin/orders/:orderId/available-agents - should handle database errors (1478 ms)
    Phase 20.12: Device Token Management & Helper Functions
      Device Token Listing
        ΓêÜ GET /api/admin/device-tokens - should list all tokens with default limit (1473 ms)
        ΓêÜ GET /api/admin/device-tokens?userId=... - should filter by userId (1490 ms)
        ΓêÜ GET /api/admin/device-tokens?email=... - should resolve email to userIds across all collections (1521 ms)
        ΓêÜ GET /api/admin/device-tokens?limit=2 - should respect limit parameter (1476 ms)
        ΓêÜ GET /api/admin/device-tokens - should sort by last_seen descending (1479 ms)
        ΓêÜ GET /api/admin/device-tokens - should handle database errors gracefully (1449 ms)
      Device Tokens By Client UID
        ΓêÜ GET /api/admin/device-tokens/by-client?uid=... - should return tokens for specific UID (1471 ms)
        ΓêÜ GET /api/admin/device-tokens/by-client - should reject missing uid (1423 ms)
        ΓêÜ GET /api/admin/device-tokens/by-client?uid=nonexistent - should return empty results (1505 ms)
        ΓêÜ GET /api/admin/device-tokens/by-client - should handle database errors (1430 ms)
      Test Push Notifications
        ΓêÜ POST /api/admin/test-push - should reject when Firebase Admin not initialized (1438 ms)
        ΓêÜ POST /api/admin/test-push - should reject when no tokens found (1498 ms)
        ΓêÜ POST /api/admin/test-push - should send notification with direct token (1620 ms)
        ΓêÜ POST /api/admin/test-push - should attempt userId token resolution (1679 ms)
        ΓêÜ POST /api/admin/test-push - should attempt email token resolution across collections (1762 ms)
      Platform Settings Coupons Update
        ΓêÜ PUT /api/admin/settings - should update coupons with validation (1522 ms)
        ΓêÜ PUT /api/admin/settings - should filter invalid categories (1519 ms)
        ΓêÜ PUT /api/admin/settings - should filter out invalid coupon codes (1511 ms)
    Phase 20.13: Geocoding Logic Block
      Section 1: Direct Coordinates
        ΓêÜ POST /api/admin/orders/:id/fix-address - should fix address with direct lat/lng (1597 ms)
        ΓêÜ POST /api/admin/orders/:id/fix-address - should update UserAddress if missing location (1667 ms)
        ΓêÜ POST /api/admin/orders/:id/fix-address - should handle string coordinates (1521 ms)
      Section 2: Coordinates from Address Text
        ΓêÜ POST /api/admin/orders/:id/fix-address - should parse lat,lng from address text (1511 ms)
        ΓêÜ POST /api/admin/orders/:id/fix-address - should handle various whitespace in coords (1516 ms)
      Section 3: Reuse UserAddress Coordinates
        ΓêÜ POST /api/admin/orders/:id/fix-address - should reuse existing UA location (1553 ms)
      Section 4: Missing API Key
        ΓêÜ POST /api/admin/orders/:id/fix-address - should reject when GOOGLE_MAPS_API_KEY missing (1345 ms)
      Section 5: Order Not Found
        ΓêÜ POST /api/admin/orders/:id/fix-address - should return 404 for non-existent order (1412 ms)
      Section 6: Geocoding Error Paths
        ΓêÜ POST /api/admin/orders/:id/fix-address - should return 400 when no address available (1647 ms)
        ΓêÜ POST /api/admin/orders/:id/fix-address - should handle database errors (1328 ms)
    Phase 20.14: Small Uncovered Blocks Cleanup
      Section 1: Seller Location Update with Geocoding
        ΓêÜ should handle place_id geocoding failure gracefully (line 830-832) (2526 ms)
        ΓêÜ should handle reverse geocoding failure gracefully (line 840-843) (1854 ms)
        ΓêÜ should handle database save error during location update (line 860) (1818 ms)
        ΓêÜ should return 404 for invalid seller in test-pickup endpoint (line 886-890) (1747 ms)
        ΓêÜ should handle geocoding errors in test-pickup gracefully (line 901-908) (1911 ms)
        ΓêÜ should handle database error in test-pickup endpoint (line 934) (1701 ms)
      Section 2: Cascade Delete with Firebase Errors
        ΓêÜ should handle database error in product-categories endpoint (line 1117-1118) (1667 ms)
      Section 3: Manual Delivery Agent Assignment
        ΓêÜ should reject assignment when payment status is not paid (line 1933) (1853 ms)
        ΓêÜ should reject unapproved agent assignment (line 1966-1967) (1870 ms)
        ΓêÜ should reject unavailable agent without force flag (line 1969-1972) (1861 ms)
        ΓêÜ should allow unavailable agent with force flag (line 1969-1972) (1972 ms)
        ΓêÜ should return already_assigned when assigning same agent (line 1978-1987) (2017 ms)
        ΓêÜ should decrement previous agent counter when reassigning (line 1989-1997) (2266 ms)
      Section 4: Orders Listing Advanced Filters
        ΓêÜ should filter orders by payment method (line 2300) (1940 ms)
        ΓêÜ should filter orders by minimum amount (line 2306) (1930 ms)
        ΓêÜ should filter orders by maximum amount (line 2307) (1936 ms)
        ΓêÜ should filter orders by amount range (line 2304-2310) (2002 ms)
        ΓêÜ should search orders by client_id regex (line 2329) (1946 ms)
        ΓêÜ should search orders by order_no regex (line 2329) (1951 ms)
    Phase 20.15: Helper Functions & Final Coverage Push (100% Target)
      Section 1: Helper Function _httpGetJson (lines 1515-1530)
        ΓêÜ should successfully fetch and parse JSON from HTTPS (1316 ms)
        ΓêÜ should handle JSON parse errors in _httpGetJson (line 1525) (1322 ms)
        ΓêÜ should handle HTTPS network errors (line 1530) (1351 ms)
      Section 2: Helper Function _geocodeAddress (lines 1532-1548)
        ΓêÜ should return null for empty address (line 1533) (1382 ms)
        ΓêÜ should use GOOGLE_GEOCODE_COMPONENTS env variable (line 1539-1542) (1462 ms)
        ΓêÜ should use GEO_COUNTRY env variable fallback (line 1539-1542) (1344 ms)
        ΓêÜ should return null when geocoding status is not OK (line 1545) (1369 ms)
        ΓêÜ should handle missing geometry in geocoding result (line 1548) (1325 ms)
      Section 3: Helper Function _placeDetails (lines 1550-1565)
        ΓêÜ should return null for empty placeId (line 1551) (1420 ms)
        ΓêÜ should handle missing geometry in place details (line 1563) (1375 ms)
      Section 4: Test Pickup Address Edge Cases (lines 889-944)
        ΓêÜ should handle reverseGeocode errors gracefully (line 901-908) (1571 ms)
        ΓêÜ should use coords format when no other source available (line 918-921) (1541 ms)
        ΓêÜ should return default message when no location data (line 943-944) (1436 ms)
      Section 5: Remaining Scattered Lines
        ΓêÜ should handle fix-address when address is ObjectId-like (line 1623-1624) (1427 ms)
        ΓêÜ should handle manual assignment when payment status is COD (line 1920) (1616 ms)
        ΓêÜ should handle available-agents database errors (line 1720) (1468 ms)
    Phase 20.16: High-Value CRUD & Filtering Endpoints (Target: 83.15% ΓåÆ 89%+)
      Section 1: Order Search with ObjectId Time Range (lines 2317-2332)
        ΓêÜ should filter orders by 'from' date using ObjectId time range (line 2319-2324) (1511 ms)
        ΓêÜ should filter orders by 'to' date using ObjectId time range (line 2326-2331) (1562 ms)
        ΓêÜ should filter orders by both 'from' and 'to' dates (lines 2317-2332) (1471 ms)
        ΓêÜ should handle invalid _id regex search with ObjectId cast error (line 2339) (1419 ms)
      Section 2: EarningLog Date Filtering (lines 3095-3104)
        ΓêÜ should filter EarningLog by 'from' date (lines 3097-3100) (1648 ms)
        ΓêÜ should filter EarningLog by 'to' date (lines 3101-3104) (1470 ms)
        ΓêÜ should filter EarningLog by paid status true (line 3093) (1479 ms)
        ΓêÜ should filter EarningLog by paid status false (line 3094) (1526 ms)
      Section 3: POST /clients Endpoint (lines 3181-3197)
        ΓêÜ should create a new client with all fields (lines 3181-3192) (1474 ms)
        ΓêÜ should handle E11000 duplicate firebase_uid error (line 3193-3195) (1518 ms)
        ΓêÜ should handle database errors during client creation (line 3196-3198) (1460 ms)
      Section 4: DELETE /delivery-agents/:id Cascade (lines 3240-3260)
        ΓêÜ should delete delivery agent without cascade (line 3247-3261) (1738 ms)
        ΓêÜ should delete delivery agent with full cascade (line 3249, full=true) (1654 ms)
        ΓêÜ should reject invalid delivery agent ID (line 3250-3252) (1420 ms)
        ΓêÜ should handle delivery agent not found (line 3253-3255) (1531 ms)
        ΓêÜ should handle database errors during deletion (line 3258-3260) (1505 ms)
      Section 5: POST /sellers E11000 Error Handling (lines 3321-3325)
        ΓêÜ should create a new seller successfully (lines 3266-3322) (1468 ms)
        ΓêÜ should handle E11000 duplicate email error for sellers (line 3323-3325) (1518 ms)
        ΓêÜ should handle database errors during seller creation (line 3326-3328) (1416 ms)
    Phase 20.18: PATCH /sellers Endpoint
      Section 1: PATCH /sellers Error Paths
        ΓêÜ should return 400 for invalid seller ID in PATCH (1241 ms)
        ΓêÜ should return 404 for non-existent seller in PATCH (1291 ms)
        ΓêÜ should filter earning logs by sellerId (1486 ms)
      Section 2: PUT /sellers Database Error
        ΓêÜ should handle database error in PUT /sellers (1304 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db2a48adc37d78e1855e6 reassigned to agent Agent Two (least assigned, no store location)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 0 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db2bb8adc37d78e1858ab reassigned to agent Agent Two (least assigned, no store location)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 0 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 0 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 2 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒÜ¿ Order 692db2d28adc37d78e185b68 exceeded 10 retry attempts - escalating for admin intervention

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry complete: 0 assigned, 1 escalated, 0 skipped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 2 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ│ No orders ready for retry (1 in cooldown or no agents available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 2 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry: Order 692db2d38adc37d78e185bc4 assigned to agent Agent Two (attempt 2/10)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry complete: 1 assigned, 0 escalated, 0 skipped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 3 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry: Order 692db2d58adc37d78e185bee assigned to agent Far Agent (attempt 1/10)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry complete: 1 assigned, 0 escalated, 0 skipped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 1 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ│ No orders ready for retry (1 in cooldown or no agents available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 3 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry: Order 692db2d78adc37d78e185c42 assigned to agent Agent Two (attempt 1/10)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry complete: 1 assigned, 0 escalated, 0 skipped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 2 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry: Order 692db2d88adc37d78e185c6a assigned to agent Agent Two (attempt 2/10)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry complete: 1 assigned, 0 escalated, 0 skipped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 3 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 2 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry: Order 692db2d98adc37d78e185c96 assigned to agent Agent Two (attempt 2/10)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry: Order 692db2d98adc37d78e185c9c assigned to agent Agent Two (attempt 2/10)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry: Order 692db2d98adc37d78e185ca2 assigned to agent Agent Two (attempt 2/10)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry complete: 3 assigned, 0 escalated, 0 skipped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 2 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry: Order 692db2dc8adc37d78e185cf8 assigned to agent Agent Two (attempt 2/10)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry complete: 1 assigned, 0 escalated, 0 skipped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 1 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Order 692db2de8adc37d78e185d35 reassigned from timeout to agent Agent Two

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 0 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 1 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Order 692db2df8adc37d78e185d72 reassigned from timeout to agent Timeout Test Agent

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 1 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Order 692db2e08adc37d78e185da1 reassigned from timeout to agent Agent Two

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 1 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Order 692db2e18adc37d78e185dca marked as pending (no agents available after timeout)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 1 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Order 692db2e28adc37d78e185ded reassigned from timeout to agent Agent Two

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 3 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Order 692db2e48adc37d78e185e1e reassigned from timeout to agent Agent Two

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Order 692db2e38adc37d78e185e1a reassigned from timeout to agent Agent Two

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Order 692db2e38adc37d78e185e16 reassigned from timeout to agent Agent Two

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 1 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Order 692db2e58adc37d78e185e76 reassigned from timeout to agent Agent Two

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 1 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Order 692db2e68adc37d78e185e9e reassigned from timeout to agent Agent Two

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 0 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 0 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 0 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 0 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 0 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db3098adc37d78e1862e9 reassigned to agent Agent One (least assigned, no store location)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÜá∩╕Å FORCE OFFLINE: Reassigning 1 active deliveries from agent 692db30d8adc37d78e186363

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
      Γ£ô Order 692db30d8adc37d78e186367 reassigned to Agent One

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db31f8adc37d78e1865ae reassigned to agent Agent One (least assigned, no store location)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÜá∩╕Å FORCE OFFLINE: Reassigning 1 active deliveries from agent 692db3238adc37d78e186628

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
      Γ£ô Order 692db3238adc37d78e18662c reassigned to Agent One

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÜá∩╕Å FORCE OFFLINE: Reassigning 3 active deliveries from agent 692db3248adc37d78e18664b

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
      Γ£ô Order 692db3248adc37d78e18664f reassigned to Agent One

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
      Γ£ô Order 692db3248adc37d78e186653 reassigned to Agent One

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
      Γ£ô Order 692db3248adc37d78e186657 reassigned to Agent One

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db33d8adc37d78e1869aa reassigned to agent Agent One (least assigned, no store location)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÜá∩╕Å FORCE OFFLINE: Reassigning 1 active deliveries from agent 692db3418adc37d78e186a10

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
      Γ£ô Order 692db3418adc37d78e186a14 reassigned to Agent One

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 0 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db36d8adc37d78e186fbc reassigned to agent Agent One (least assigned, no store location)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/delivery.test.js (224.495 s)
  Delivery System - Integration Tests
    Agent Assignment Logic
      ΓêÜ should assign nearest available agent to order (2056 ms)
      ΓêÜ should not assign agent who is already on delivery (1138 ms)
      ΓêÜ should fail if no agents available within radius (1158 ms)
    Agent Order Management
      ΓêÜ agent should be able to accept assigned order (1262 ms)
      ΓêÜ agent should be able to reject order (1387 ms)
      ΓêÜ agent cannot accept order assigned to another agent (1235 ms)
      ΓêÜ agent should update order to picked up (1111 ms)
      ΓêÜ agent should complete delivery (1318 ms)
    Location Tracking
      ΓêÜ agent should update location in real-time (632 ms)
      ΓêÜ should retrieve agent location for tracking (835 ms)
    Order Timeout & Retry Logic
      ΓêÜ should reassign order if agent doesn't accept within timeout (648 ms)
      ΓêÜ should retry pending orders (608 ms)
    Agent Earnings
      ΓêÜ agent earnings should update after delivery completion (997 ms)
      ΓêÜ should retrieve agent earnings history (539 ms)
    Agent Availability
      ΓêÜ agent should toggle availability status (710 ms)
      ΓêÜ unavailable agent should not receive new assignments (1189 ms)
    Delivery Proof & Verification
      ΓêÜ agent should upload delivery proof on completion (564 ms)
      ΓêÜ should reject delivery proof from wrong agent (543 ms)
      ΓêÜ should verify OTP before delivery completion (590 ms)
    Agent Order History & Tracking
      ΓêÜ should retrieve agent's current orders (541 ms)
      ΓêÜ should retrieve agent's completed orders (544 ms)
      ΓêÜ should retrieve agent performance statistics (501 ms)
    Distance & Route Optimization
      ΓêÜ should calculate distance between two locations (494 ms)
      ΓêÜ should get route between agent and delivery location (540 ms)
      ΓêÜ should handle invalid coordinates gracefully (495 ms)
    Payment Collection & Verification
      ΓêÜ agent should mark COD payment as collected (603 ms)
      ΓêÜ should reject payment collection by wrong agent (547 ms)
    Agent Load Balancing
      ΓêÜ should prefer agent with fewer assigned orders (1161 ms)
      ΓêÜ should not assign multiple concurrent orders to single agent (1115 ms)
    Pending Orders Endpoint
      ΓêÜ should return formatted pending orders for agent (717 ms)
      ΓêÜ should exclude orders already offered to the agent (682 ms)
    Offers Endpoint
      ΓêÜ should return offers for specific agent (644 ms)
    Assigned Orders Endpoint
      ΓêÜ should return assigned orders for agent (750 ms)
    Order History Endpoint
      ΓêÜ should return completed orders for agent (708 ms)
    Reject Order Endpoint
      ΓêÜ should allow agent to reject an order (1484 ms)
    Update Status Endpoint
      ΓêÜ should update order delivery status (624 ms)
    Generate OTP Endpoint
      ΓêÜ should generate OTP for order (1015 ms)
    Verify OTP Endpoint
      ΓêÜ should verify OTP for order (993 ms)
    Update Location Endpoint
      ΓêÜ should update agent location (590 ms)
    Toggle Availability Endpoint
      ΓêÜ should toggle agent availability (662 ms)
    Agent Profile Endpoint
      ΓêÜ should return agent profile (595 ms)
    Earnings Summary Endpoint
      ΓêÜ should return agent earnings summary (538 ms)
    Earnings Breakdown Endpoint
      ΓêÜ should return earnings breakdown (542 ms)
    Route Optimize Endpoint
      ΓêÜ should optimize delivery route (547 ms)
    Logout Endpoint
      ΓêÜ should logout agent (593 ms)
    Earnings Logs Endpoint
      ΓêÜ should return detailed earnings logs (535 ms)
    Check Timeouts Endpoint
      ΓêÜ should check for timed out orders (538 ms)
    Retry Pending Orders Endpoint
      ΓêÜ should retry pending orders (582 ms)
    Additional Coverage - High-Value Areas
      ΓêÜ should handle earnings breakdown for different periods (623 ms)
      ΓêÜ should retrieve earnings logs with pagination (542 ms)
      ΓêÜ should handle agent profile retrieval (542 ms)
      ΓêÜ should handle missing agent profile gracefully (550 ms)
      ΓêÜ should update agent location (583 ms)
      ΓêÜ should handle invalid location coordinates (579 ms)
      ΓêÜ should logout agent and set inactive (666 ms)
      ΓêÜ should handle pending orders with no available agents (1401 ms)
      ΓêÜ should handle retry with truly pending orders (1085 ms)
      ΓêÜ should handle orders from different product categories (1251 ms)
      ΓêÜ should handle restaurant/food orders (1129 ms)
      ΓêÜ should handle agent earnings summary (548 ms)
      ΓêÜ should check timeouts and detect timed out orders (550 ms)
      ΓêÜ should handle order with missing seller location (1100 ms)
      ΓêÜ should handle offers endpoint (629 ms)
      ΓêÜ should handle earnings with no completed deliveries (718 ms)
      ΓêÜ should handle concurrent agent assignment attempts (1041 ms)
    Retry Logic System
      ΓêÜ should escalate order after max retry attempts exceeded (772 ms)
      ΓêÜ should skip orders in retry cooldown period (681 ms)
      ΓêÜ should avoid recently-tried agents within agent retry cooldown (1147 ms)
      ΓêÜ should select nearest untried agent for retry (1261 ms)
      ΓêÜ should handle retry when all agents at capacity (1067 ms)
      ΓêÜ should use fallback agent selection when no location available (1216 ms)
      ΓêÜ should increment assignment_history on each retry (1190 ms)
      ΓêÜ should handle multiple pending orders in one retry call (2387 ms)
      ΓêÜ should send SSE notification on successful retry assignment (1302 ms)
      ΓêÜ should return correct response when no orders need retry (692 ms)
    Timeout Detection & Reassignment System
      ΓêÜ should detect and reassign order when agent timeout exceeded (889 ms)
      ΓêÜ should not reassign order within timeout window (630 ms)
      ΓêÜ should exclude previously-tried agents from reassignment (1147 ms)
      ΓêÜ should select nearest available agent for timeout reassignment (1083 ms)
      ΓêÜ should mark order as pending when no agents available after timeout (1001 ms)
      ΓêÜ should use fallback (least assigned) when no location available (1068 ms)
      ΓêÜ should handle multiple timed-out orders in single check (1806 ms)
      ΓêÜ should send SSE notification on timeout reassignment (965 ms)
      ΓêÜ should update assignment_history with timeout response (979 ms)
      ΓêÜ should return correct response when no timeouts detected (575 ms)
    Batch C: Offers Endpoint - Order Formatting Logic
      ΓêÜ should return formatted offers for active agent with pending orders (835 ms)
      ΓêÜ should return empty offers for inactive agent (764 ms)
      ΓêÜ should handle offers with geocoding fallback for missing seller address (1457 ms)
      ΓêÜ should detect product categories (vegetables) in offers (884 ms)
      ΓêÜ should detect product categories (grocery) in offers (881 ms)
      ΓêÜ should detect product categories (food/restaurant) in offers (875 ms)
      ΓêÜ should use business_type for category detection when products lack categories (978 ms)
      ΓêÜ should exclude offers that agent previously rejected (708 ms)
      ΓêÜ should set hasActiveOrder=true when agent has active delivery (888 ms)
      ΓêÜ should handle offers with missing client address using coordinate fallback (848 ms)
    Batch D: Earnings Breakdown System (Lines 1846-1960)
      ΓêÜ should return daily breakdown with completed deliveries (881 ms)
      ΓêÜ should filter earnings by date range (from/to) (809 ms)
      ΓêÜ should return empty breakdown when agent has no delivered orders (580 ms)
      ΓêÜ should calculate agent earnings with platform share rate (80%) (1008 ms)
      ΓêÜ should calculate COD collection totals correctly (823 ms)
      ΓêÜ should handle invalid agentId with 400 error (494 ms)
    Batch E: Error Handling & Edge Cases (Uncovered Lines)
      ΓêÜ should handle check-timeouts with no timed out orders (1044 ms)
      ΓêÜ should handle retry-pending-orders with no pending orders (599 ms)
      ΓêÜ should handle timeout reassignment with no agents available (639 ms)
      ΓêÜ should use fallback agent selection for timeout when store location missing (786 ms)
      ΓêÜ should use fallback agent selection for retry when store location missing (749 ms)
      ΓêÜ should filter out agents in cooldown during retry (631 ms)
      ΓêÜ should skip orders in cooldown period during retry (631 ms)
      ΓêÜ should handle seller without address in retry system (749 ms)
      ΓêÜ should use seller business_type for category detection (773 ms)
      ΓêÜ should handle platform settings updates (580 ms)
      ΓêÜ should continue retry assignment even if SSE notification fails (632 ms)
      ΓêÜ should continue timeout reassignment even if SSE publish fails (683 ms)
    Batch F: Complete Remaining Lines Coverage
      ΓêÜ should calculate earnings with admin_pays_agent and admin_agent_payment (766 ms)
      ΓêÜ should calculate effective delivery charge from order items (998 ms)
      ΓêÜ should use geocoding fallback for offers when seller has place_id (1131 ms)
      ΓêÜ should handle geocoding in current-order endpoint (726 ms)
      ΓêÜ should resolve client by firebase_uid in current-order (734 ms)
      ΓêÜ should handle geocoding fallback in pending-orders (771 ms)
      ΓêÜ should resolve client details in pending-orders (780 ms)
      ΓêÜ should calculate route info in delivery history (828 ms)
      ΓêÜ should handle missing store_location in route_info (761 ms)
      ΓêÜ should handle accept-order idempotency (already accepted) (726 ms)
      ΓêÜ should reject accept-order when agent has active orders (812 ms)
      ΓêÜ should set pickup_address from seller location on accept (1455 ms)
      ΓêÜ should reassign order without store location using least assigned (685 ms)
      ΓêÜ should handle reject-order with agent and order validation (1297 ms)
      ΓêÜ should handle complete delivery with OTP validation (639 ms)
      ΓêÜ should update agent location and broadcast to active orders (722 ms)
      ΓêÜ should validate agentId in toggle-availability (514 ms)
      ΓêÜ should block toggle offline with active deliveries (no forceOffline) (744 ms)
      ΓêÜ should force offline and reassign active deliveries (984 ms)
      ΓêÜ should reassign pending offers when agent goes offline (853 ms)
      ΓêÜ should toggle agent online and increment assigned_orders (642 ms)
      ΓêÜ should calculate earnings summary with COD and platform payments (823 ms)
      ΓêÜ should fetch earnings logs with pagination (630 ms)
      ΓêÜ should optimize route with order_ids (860 ms)
      ΓêÜ should optimize route with custom points array (586 ms)
      ΓêÜ should handle route optimization with no agent location (598 ms)
    Batch G: Helper Function Edge Cases
      ΓêÜ should use platform share rate fallback when admin payment invalid (766 ms)
      ΓêÜ should detect restaurant category and use food delivery charge (947 ms)
      ΓêÜ should use grocery charge when no food category detected (852 ms)
    Batch H: Complex Order Workflows
      ΓêÜ should calculate route_info with accept_location and pickup_address (765 ms)
      ΓêÜ should handle missing location in route calculations (773 ms)
      ΓêÜ should calculate route durations from timestamps (777 ms)
      ΓêÜ should handle orders without seller store_location (861 ms)
      ΓêÜ should handle null locations in route info (808 ms)
      ΓêÜ should handle duplicate accept attempts idempotently (802 ms)
      ΓêÜ should validate agent and order existence on accept (545 ms)
      ΓêÜ should check agent availability before accepting (1271 ms)
      ΓêÜ should reject accept when agent already has active delivery (849 ms)
      ΓêÜ should set pickup_address from seller location on accept (1370 ms)
      ΓêÜ should use least assigned agent when no store location available (764 ms)
      ΓêÜ should allow agent to reject assigned order (1277 ms)
      ΓêÜ should validate OTP before completing delivery (652 ms)
      ΓêÜ should broadcast location updates to active order clients (751 ms)
    Batch I: Availability Toggle Complex Scenarios
      ΓêÜ should validate agentId in toggle availability (509 ms)
      ΓêÜ should prevent going offline with active deliveries without force flag (746 ms)
      ΓêÜ should reassign active deliveries when force offline (1034 ms)
      ΓêÜ should handle complex reassignment during force offline (1422 ms)
      ΓêÜ should reassign pending offers when agent goes offline (853 ms)
      ΓêÜ should allow agent to go online and reset assigned_orders (700 ms)
    Batch J: Earnings & Routing Edge Cases
      ΓêÜ should calculate COD collected and platform payments separately (731 ms)
      ΓêÜ should paginate earnings logs correctly (1193 ms)
      ΓêÜ should sort earnings logs by date descending (587 ms)
      ΓêÜ should optimize route when provided with order IDs (761 ms)
      ΓêÜ should optimize route with custom waypoints (589 ms)
      ΓêÜ should calculate total route distance and duration (591 ms)
      ΓêÜ should handle route optimization when agent has no location (595 ms)
    Batch K: Retry & Timing Logic
      ΓêÜ should respect retry cooldown periods (683 ms)
      ΓêÜ should avoid agents within agent cooldown period (772 ms)
      ΓêÜ should escalate order after max retry attempts (643 ms)
      ΓêÜ should select nearest available agent for retry (728 ms)
      ΓêÜ should skip agents at maximum capacity (719 ms)
      ΓêÜ should filter retries by specific time windows (633 ms)
      ΓêÜ should use fallback selection when no location available (735 ms)
      ΓêÜ should continue retry even if SSE notification fails (685 ms)
    Batch L: Geocoding Service Fallbacks
      ΓêÜ should use seller address when reverseGeocode fails in offers (718 ms)
      ΓêÜ should fallback when placeDetails fails in offers (778 ms)
      ΓêÜ should try multiple geocoding methods before using raw coordinates (716 ms)
      ΓêÜ should handle geocoding failure in current-order endpoint (736 ms)
      ΓêÜ should use place_id geocoding in pending-orders (808 ms)
      ΓêÜ should gracefully handle nested geocoding errors (933 ms)
    Batch M: Precision Coverage Tests
      ΓêÜ should use admin payment amount when admin_pays_agent=true (780 ms)
      ΓêÜ should detect food category and calculate food delivery charge (950 ms)
      ΓêÜ should resolve client by firebase_uid in pending orders (813 ms)
      ΓêÜ should calculate route distances when all locations present (774 ms)
      ΓêÜ should handle orders from sellers without location data (856 ms)
      ΓêÜ should handle idempotent accept requests gracefully (1350 ms)
      ΓêÜ should set pickup_address from seller location when accepting order (1310 ms)
      ΓêÜ should allow agent to reject assigned order (1262 ms)
      ΓêÜ should update agent location and broadcast to active deliveries (1274 ms)
      ΓêÜ should validate agentId format in toggle availability (502 ms)
      ΓêÜ should prevent agent from going offline with active deliveries (721 ms)
      ΓêÜ should reassign orders when forcing agent offline (1016 ms)
      ΓêÜ should reset assigned_orders counter when agent goes online (676 ms)
      ΓêÜ should calculate earnings summary with COD breakdown (719 ms)
      ΓêÜ should filter orders within retry cooldown period (695 ms)
      ΓêÜ should avoid agents within cooldown period during retry (727 ms)
      ΓêÜ should escalate order after max retry attempts (642 ms)
      ΓêÜ should select nearest agent when retry with location (735 ms)
      ΓêÜ should skip agents who reached max assigned orders (862 ms)
      ΓêÜ should apply time window filtering in retry logic (640 ms)
      ΓêÜ should use least assigned fallback when delivery address has no location (729 ms)
      ΓêÜ should continue retry even when SSE notification fails (680 ms)
    Batch N: Multi-Agent Complex Scenarios
      ΓêÜ should assign orders to 3 nearest available agents when multiple orders exist (1130 ms)
      ΓêÜ should skip agents who are at maximum capacity (3 orders) (944 ms)
      ΓêÜ should reassign multiple active orders when agent forces offline (1217 ms)
      ΓêÜ should handle multiple agents going offline simultaneously (1113 ms)
      ΓêÜ should handle complete order lifecycle: pending ΓåÆ offered ΓåÆ accepted ΓåÆ delivered (674 ms)
      ΓêÜ should exclude agents who recently rejected order from retry (813 ms)
      ΓêÜ should detect and reassign multiple timed-out orders in one check (863 ms)
      ΓêÜ should mark order for escalation after exceeding max retry attempts (772 ms)
      ΓêÜ should assign order to agent closest to seller location (848 ms)
      ΓêÜ should keep order pending when no agents are available (796 ms)
      ΓêÜ should use least-assigned fallback when agent locations are null (761 ms)
      ΓêÜ should allow agent to handle 2 orders simultaneously (under capacity) (863 ms)
      ΓêÜ should reset agent state when going back online (708 ms)
      ΓêÜ should successfully assign to 3rd agent after 2 rejections (812 ms)
      ΓêÜ should not reassign order to agent within cooldown period (5 min) (722 ms)
    Batch O: External Service Mocking
      ΓêÜ should use reverseGeocode to get pickup address from seller location (778 ms)
      ΓêÜ should use placeDetails to get pickup address from place_id (759 ms)
      ΓêÜ should fallback to coordinates when geocoding is disabled (758 ms)
      ΓêÜ should use geocoding for client delivery address when available (1090 ms)
      ΓêÜ should handle geocoding service errors gracefully (730 ms)
      ΓêÜ should calculate route info with complete location data (818 ms)
      ΓêÜ should handle SSE broadcast errors gracefully (1235 ms)
      ΓêÜ should handle orders with missing store location data (782 ms)
      ΓêÜ should set pickup_address from seller when accepting order (1362 ms)
      ΓêÜ should handle OTP generation for orders without valid data (931 ms)
      ΓêÜ should calculate COD earnings correctly in summary (713 ms)
      ΓêÜ should handle earnings breakdown pagination correctly (588 ms)
      ΓêÜ should handle route optimization with missing order data (587 ms)
      ΓêÜ should handle logout when agent has no assigned orders (626 ms)
    Phase 21.5: Helper Function Error Paths (Lines 52, 93)
      ΓêÜ Line 52: _calculateAgentEarning - PlatformSettings.findOne error fallback (727 ms)
      ΓêÜ Line 93: _effectiveDeliveryCharge - error fallback returns 0 (692 ms)
    Phase 21.5: Geocoding Error Paths
      ΓêÜ Lines 197-223: pending-orders - reverseGeocode catch block (846 ms)
      ΓêÜ Lines 373-416: offers - seller geocoding fallback chain (995 ms)
      ΓêÜ Lines 532-559: assigned-orders - geocoding catch block (999 ms)
    Phase 21.5: Agent/Seller Location Error Paths
      ΓêÜ Lines 636, 645: current-order - DeliveryAgent.findById error (828 ms)
      ΓêÜ Lines 733-734, 822, 831-834: current-order - Seller.findById error and no location (1280 ms)
    Phase 21.5: Edge Cases - Order History
      ΓêÜ Line 852: order-history - no orders returns empty array (663 ms)
      ΓêÜ Lines 897-898: order-history - Seller.findById error (762 ms)
    Phase 21.5: Edge Cases - Accept Order
      ΓêÜ Lines 1044-1045: accept-order - Seller.findById error (1262 ms)
      ΓêÜ Lines 1086-1087, 1112-1139: accept-order - seller with place_id and geocoding (1976 ms)
    Phase 21.5: Edge Cases - Reject Order
      ΓêÜ Lines 1210-1211, 1248: reject-order - reassignment Seller.findById error (1265 ms)
    Phase 21.5: Edge Cases - Update Status
      ΓêÜ Lines 1317-1335: update-status - no OTP generated (1642 ms)
      ΓêÜ Lines 1358, 1371-1372, 1386, 1396: update-status - commission calculation and earning log (1214 ms)
    Phase 21.5: Edge Cases - Toggle Availability
      ΓêÜ Lines 1426-1427, 1441: toggle-availability - no active deliveries (721 ms)
    Phase 21.5: Edge Cases - Update Location
      ΓêÜ Lines 1464-1465: update-location - no active orders (635 ms)
    Phase 21.5: Edge Cases - Earnings Summary
      ΓêÜ Lines 1514-1515, 1532-1533, 1600: earnings-summary - pagination and COD breakdown (1165 ms)
    Phase 21.5: Edge Cases - Logout
      ΓêÜ Lines 1633-1640, 1658-1702, 1717-1718: logout - active orders and force logout (818 ms)
    Phase 21.5: Edge Cases - Route Optimization
      ΓêÜ Lines 1839-1840, 1955-1956: optimize-route - calculation and error (592 ms)
    Phase 21.5: Edge Cases - Verify OTP
      ΓêÜ Lines 1967, 1973, 1997: verify-otp - missing OTP, order not found, no OTP generated (595 ms)
    Phase 21.5: Edge Cases - Commission Calculation
      ΓêÜ Lines 2034-2062, 2090: commission - missing product_id and Product.find error (978 ms)
    Phase 21.5: Edge Cases - Miscellaneous
      ΓêÜ Lines 281-282, 462-463, 501-505, 516-519: database errors (843 ms)
      ΓêÜ Lines 166-170, 182-185: pending-orders - no kindsSet and Seller.findById edge cases (753 ms)
      ΓêÜ Lines 2173, 2192-2207, 2217-2218, 2227, 2235-2237: client phone normalization and location fallbacks (932 ms)
      ΓêÜ Lines 2249-2250, 2318-2319, 2342-2362: seller fallbacks and geocoding (762 ms)
      ΓêÜ Lines 2413-2416, 2432, 2442-2443, 2498-2499, 2549-2557: update-status errors and earnings aggregation (1179 ms)
      ΓêÜ Lines 2583-2584, 2628-2632, 2661-2662, 2704, 2730-2731: SSE/snapshot errors and fallbacks (796 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/seller.test.js (118.678 s)
  Seller - Integration Tests
    POST /api/seller/products - Create Product
      ΓêÜ should create product successfully (1382 ms)
      ΓêÜ should fail without seller authentication (419 ms)
      ΓêÜ should fail with missing required fields (1224 ms)
      ΓêÜ restaurant products should have high default stock (553 ms)
    GET /api/seller/products - List Seller Products
      ΓêÜ should return seller's products only (610 ms)
    PUT /api/seller/products/:id - Update Product
      ΓêÜ should update product successfully (451 ms)
      ΓêÜ should not update product of another seller (537 ms)
    PATCH /api/seller/products/:id - Partial Update
      ΓêÜ should update single field (443 ms)
    DELETE /api/seller/products/:id - Delete Product
      ΓêÜ should soft delete (deactivate) product by default (487 ms)
      ΓêÜ should permanently delete product with permanent=true (480 ms)
    POST /api/seller/toggle-open - Toggle Availability
      ΓêÜ should toggle seller open status (490 ms)
      ΓêÜ should require boolean value (395 ms)
    GET /api/seller/orders - List Seller Orders
      ΓêÜ should return orders containing seller's products (579 ms)
      ΓêÜ should paginate seller orders (542 ms)
    POST /api/seller/orders/accept - Accept Order
      ΓêÜ should accept order successfully (1266 ms)
      ΓêÜ should fail with invalid order ID (497 ms)
    GET /api/seller/analytics - Seller Analytics
      ΓêÜ should return seller analytics (576 ms)
      ΓêÜ should filter analytics by date range (529 ms)
    GET /api/seller/inventory - Inventory Management
      ΓêÜ should return low stock products (483 ms)
      ΓêÜ should return inventory stats (436 ms)
    GET /api/seller/orders/pending - List Pending Orders
      ΓêÜ should list only pending orders (536 ms)
      ΓêÜ should exclude non-pending orders (636 ms)
    GET /api/seller/orders/:id - Get Single Order
      ΓêÜ should retrieve single order by ID (674 ms)
      ΓêÜ should return 404 for non-existent order (540 ms)
      ΓêÜ should return 400 for invalid order ID format (488 ms)
    POST /api/seller/orders/reject - Reject Order
      ΓêÜ should reject order with reason (858 ms)
      ΓêÜ should fail rejection without order ID (500 ms)
      ΓêÜ should fail rejection with invalid order ID (568 ms)
    POST /api/seller/check-delivery-availability - Delivery Availability Check
      ΓêÜ should check delivery availability with valid coordinates (447 ms)
      ΓêÜ should fail without store location (384 ms)
      ΓêÜ should fail without longitude (386 ms)
      ΓêÜ should handle invalid coordinate types (441 ms)
    POST /api/seller/:sellerId/feedback - Submit Feedback
      ΓêÜ should submit feedback successfully (441 ms)
      ΓêÜ should fail without message (392 ms)
      ΓêÜ should fail with invalid seller ID (399 ms)
      ΓêÜ should accept feedback without type (defaults to other) (449 ms)
    GET /api/seller/:sellerId/feedback - Get Seller Feedback
      ΓêÜ should retrieve seller feedback (488 ms)
      ΓêÜ should return empty rows for seller without feedback (620 ms)
    GET /api/seller/:sellerId/earnings/summary - Earnings Summary
      ΓêÜ should return earnings summary (483 ms)
      ΓêÜ should filter earnings by date range (500 ms)
      ΓêÜ should handle invalid seller ID (391 ms)
    GET /api/seller/:sellerId/earnings/logs - Earnings Logs
      ΓêÜ should return earnings logs with pagination (457 ms)
      ΓêÜ should filter logs by date range (444 ms)
    GET /api/seller/products/reviews - Product Reviews
      ΓêÜ should retrieve reviews for seller products (528 ms)
      ΓêÜ should support pagination for reviews (534 ms)
      ΓêÜ should filter reviews by product ID (531 ms)
    POST /api/seller/reviews/:reviewId/respond - Respond to Review
      ΓêÜ should respond to review successfully (689 ms)
      ΓêÜ should fail without message (486 ms)
      ΓêÜ should fail with non-existent review ID (531 ms)
    DELETE /api/seller/reviews/:reviewId/respond - Delete Review Response
      ΓêÜ should delete review response successfully (619 ms)
      ΓêÜ should fail with non-existent review ID (529 ms)
    Edge Cases & Error Handling
      ΓêÜ should handle missing seller authentication across endpoints (396 ms)
      ΓêÜ should handle invalid MongoDB ObjectIds gracefully (467 ms)
      ΓêÜ should prevent seller from updating another seller's product (550 ms)
      ΓêÜ should handle non-existent seller ID in toggle-open (445 ms)
      ΓêÜ should handle server errors gracefully in product creation (398 ms)
      ΓêÜ should handle DELETE with non-existent product (439 ms)
      ΓêÜ should handle PATCH with invalid product ID (387 ms)
      ΓêÜ should handle order rejection with too short reason (483 ms)
      ΓêÜ should handle order rejection without seller items (723 ms)
      ΓêÜ should handle order rejection with no items (531 ms)
      ΓêÜ should handle order reject with non-existent order (435 ms)
      ΓêÜ should handle feedback with very short message (386 ms)
      ΓêÜ should handle review response with empty message (482 ms)
      ΓêÜ should handle review response with message > 500 chars (564 ms)
      ΓêÜ should handle review response for another seller's product (748 ms)
      ΓêÜ should handle delete review response for another seller's product (746 ms)
    GET /api/seller/stream - SSE Order Updates
      ΓêÜ should establish SSE connection with correct headers (893 ms)
      ΓêÜ should handle missing seller authentication (392 ms)
    GET /api/seller/analytics/export - Export Analytics CSV
      ΓêÜ should export analytics as CSV with default period (month) (432 ms)
      ΓêÜ should export analytics with specific period (week) (433 ms)
      ΓêÜ should export analytics with period=today (429 ms)
      ΓêÜ should export analytics with period=year (430 ms)
      ΓêÜ should export analytics with period=all (444 ms)
    GET /api/seller/analytics/stream - Real-time Analytics SSE
      ΓêÜ should establish analytics SSE connection with correct headers (896 ms)
      ΓêÜ should reject analytics stream without authentication (497 ms)
    GET /api/seller/inventory - Extended Inventory Tests
      ΓêÜ should filter low stock products only (520 ms)
      ΓêÜ should use custom threshold for low stock (432 ms)
      ΓêÜ should calculate inventory stats correctly (434 ms)
    PUT /api/seller/inventory/:productId/stock - Update Stock
      ΓêÜ should update product stock (521 ms)
      ΓêÜ should reject invalid stock value (negative) (432 ms)
      ΓêÜ should reject invalid stock value (non-numeric) (432 ms)
      ΓêÜ should handle non-existent product (404) (432 ms)
      ΓêÜ should prevent updating stock for another seller's product (599 ms)
    GET /api/seller/analytics - Extended Period Tests
      ΓêÜ should handle period=today (438 ms)
      ΓêÜ should handle period=year (430 ms)
      ΓêÜ should handle period=all (437 ms)
      ΓêÜ should handle invalid period with fallback to month (442 ms)
    POST /api/seller/orders/accept - Delivery Assignment Edge Cases
      ΓêÜ should handle order acceptance when no delivery agent available (394 ms)
      ΓêÜ should handle order acceptance with missing order_id (391 ms)
      ΓêÜ should handle order acceptance with invalid order_id format (399 ms)
    POST /api/seller/check-delivery-availability - Edge Cases
      ΓêÜ should handle extreme coordinate values (385 ms)
      ΓêÜ should handle same location for store and delivery (414 ms)
      ΓêÜ should handle missing delivery location latitude (394 ms)
      ΓêÜ should handle delivery location with invalid types (385 ms)
    Product Management - Additional Tests
      ΓêÜ should create restaurant product with high default stock (1091 ms)
      ΓêÜ should handle product creation with all optional fields (428 ms)
      ΓêÜ should handle product update with empty fields (485 ms)
    POST /api/seller/inventory/bulk-update - Bulk Stock Updates
      ΓêÜ should bulk update multiple product stocks (571 ms)
      ΓêÜ should handle partial bulk update failures (526 ms)
      ΓêÜ should reject bulk update with invalid stock values (429 ms)
      ΓêÜ should handle empty bulk update array (394 ms)
    GET /api/seller/analytics - Advanced Analytics Aggregations
      ΓêÜ should calculate revenue trends over time (436 ms)
      ΓêÜ should calculate category-wise sales breakdown (442 ms)
      ΓêÜ should calculate top products by revenue (438 ms)
      ΓêÜ should handle analytics with custom date range (447 ms)
      ΓêÜ should calculate average order value (436 ms)
      ΓêÜ should handle analytics for seller with no orders (548 ms)
    Order Status Management - Extended
      ΓêÜ should handle order ready for pickup notification (437 ms)
      ΓêÜ should handle order cancellation by seller (439 ms)
    Product Management - Advanced Features
      ΓêÜ should handle product image updates (484 ms)
      ΓêÜ should handle product category change (482 ms)
      ΓêÜ should handle product price updates (492 ms)
      ΓêÜ should handle product with very long description (441 ms)
      ΓêÜ should handle product with special characters in name (429 ms)
      ΓêÜ should handle bulk product deactivation (482 ms)
    Seller Profile Management
      ΓêÜ should retrieve seller profile (391 ms)
      ΓêÜ should update seller business name (393 ms)
      ΓêÜ should update seller location coordinates (406 ms)
      ΓêÜ should update seller operating hours (394 ms)
    Error Handling - Additional Edge Cases
      ΓêÜ should handle concurrent product updates (509 ms)
      ΓêÜ should handle malformed MongoDB ObjectId (381 ms)
      ΓêÜ should handle request with missing content-type header (389 ms)
      ΓêÜ should handle very large request payload (398 ms)
    Delivery Agent Assignment & Availability
      ΓêÜ should check delivery availability with nearby agents (589 ms)
      ΓêÜ should calculate nearest agent correctly (576 ms)
      ΓêÜ should warn when no agents available (all at capacity) (672 ms)
      ΓêÜ should handle agent with no location data (622 ms)
      ΓêÜ should calculate estimated wait time based on agent load (579 ms)
      ΓêÜ should filter out offline agents from availability (570 ms)
    Complex Analytics Period Calculations
      ΓêÜ should calculate analytics for "today" period (598 ms)
      ΓêÜ should calculate analytics for "week" period (600 ms)
      ΓêÜ should calculate analytics for "month" period (578 ms)
      ΓêÜ should calculate analytics for "year" period (578 ms)
      ΓêÜ should calculate analytics for "all" period (beginning of time) (578 ms)
      ΓêÜ should default to month period for invalid period (576 ms)
    Inventory Management Advanced
      ΓêÜ should check low stock products (442 ms)
      ΓêÜ should get inventory alerts (397 ms)
      ΓêÜ should bulk update stock levels (444 ms)
      ΓêÜ should get inventory summary statistics (392 ms)
    Distance Calculation Helper
      ΓêÜ should calculate distance between two coordinates correctly (437 ms)
    SSE Streaming Endpoints
      ΓêÜ should connect to seller SSE stream with proper headers (lines 375-385) (1003 ms)
      ΓêÜ should connect to analytics SSE stream (lines 1734-1835) (1013 ms)
      ΓêÜ should handle SSE connection errors gracefully (line 385) (397 ms)
    Inventory Advanced Operations
      ΓêÜ should get inventory with stats (lines 1889-1937) (689 ms)
      ΓêÜ should filter low stock products (lines 1889-1937) (683 ms)
      ΓêÜ should update product stock via PUT /inventory/:productId/stock (lines 1900-1937) (738 ms)
      ΓêÜ should reject negative stock values (lines 1900-1937) (645 ms)
      ΓêÜ should handle product not found for stock update (lines 1900-1937) (689 ms)
      ΓêÜ should handle invalid stock type (lines 1900-1937) (905 ms)
      ΓêÜ should handle stock update errors (lines 1947-2007) (623 ms)
    CSV Upload & Export Operations
      ΓêÜ should upload products via CSV (lines 2021-2111) (669 ms)
      ΓêÜ should reject CSV upload with empty array (lines 2021-2111) (510 ms)
      ΓêÜ should handle CSV upload validation errors (lines 2021-2111) (608 ms)
      ΓêÜ should export analytics as CSV (lines 1661-1719) (603 ms)
      ΓêÜ should export analytics for different periods (lines 1661-1719) (737 ms)
    Error Handling & Edge Cases
      ΓêÜ should handle toggle-open errors (lines 50-51) (516 ms)
      ΓêÜ should handle product listing errors (lines 114-115) (531 ms)
      ΓêÜ should handle product creation errors (lines 135-136) (504 ms)
      ΓêÜ should handle product update errors (lines 168-169) (556 ms)
      ΓêÜ should handle product deletion errors (lines 179-180) (488 ms)
      ΓêÜ should handle order listing errors (lines 248-249) (545 ms)
      ΓêÜ should handle pending orders errors (lines 303-304) (493 ms)
      ΓêÜ should handle order acceptance errors (lines 328, 337) (480 ms)
      ΓêÜ should handle order rejection errors (lines 368-369) (488 ms)
      ΓêÜ should handle delivery check errors (lines 402, 409, 418) (524 ms)
      ΓêÜ should handle feedback submission errors (lines 445-446) (484 ms)
      ΓêÜ should handle feedback retrieval errors (lines 472-480) (482 ms)
      ΓêÜ should handle earnings summary errors (lines 541-544, 553, 559) (489 ms)
      ΓêÜ should handle earnings logs errors (lines 585, 599-600) (767 ms)
      ΓêÜ should handle review retrieval errors (lines 662, 672-673) (505 ms)
      ΓêÜ should handle review response errors (lines 845-846, 855, 870-871) (489 ms)
      ΓêÜ should handle analytics errors (lines 890-892, 983-984, 993, 1002-1004, 1016-1017) (485 ms)
      ΓêÜ should handle profile update errors (lines 1421-1422, 1453) (487 ms)
      ΓêÜ should handle low availability mode (lines 497-531) (525 ms)
      ΓêÜ should handle agent without location fallback (lines 497-531) (635 ms)
    Review Statistics & Aggregation
      ΓêÜ should calculate review statistics with rating distribution (lines 1520-1546) (665 ms)
      ΓêÜ should handle reviews with seller response (lines 1608-1609) (712 ms)
      ΓêÜ should handle review deletion (lines 1645-1646) (726 ms)
    Advanced Delivery Agent Logic
      ΓêÜ should handle multiple agents at max capacity (lines 754, 764-770) (668 ms)
      ΓêÜ should sort agents by distance correctly (lines 780-787) (667 ms)
      ΓêÜ should log distance information (lines 817-818) (619 ms)
    Review Statistics & Seller Response (lines 1520-1546, 1608-1609, 1645-1646)
      ΓêÜ should calculate review statistics with rating distribution (lines 1520-1546) (989 ms)
      ΓêÜ should handle reviews with seller response (lines 1608-1609) (704 ms)
      ΓêÜ should handle review deletion (lines 1645-1646) (715 ms)
    Analytics CSV Export (lines 1685, 1700-1709, 1718-1719)
      ΓêÜ should export analytics as CSV with proper formatting (lines 1685, 1700-1709) (501 ms)
      ΓêÜ should handle CSV export with 'all' period (lines 1685) (495 ms)
      ΓêÜ should handle CSV export error gracefully (lines 1718-1719) (461 ms)
    Analytics SSE Streaming (lines 1734-1835)
      ΓêÜ should setup SSE connection with proper headers (lines 1734-1750) (865 ms)
      ΓêÜ should handle SSE cleanup on connection close (lines 1815-1830) (565 ms)
    Inventory Error Handling (lines 1889-1890)
      ΓêÜ should handle inventory fetch errors gracefully (lines 1889-1890) (401 ms)
    Bulk Update Error Handling (lines 1993, 2006-2007)
      ΓêÜ should handle individual product update failures (lines 1993) (401 ms)
      ΓêÜ should handle bulk update server errors (lines 2006-2007) (392 ms)
    CSV Upload Operations (lines 2061-2069, 2096, 2110-2111)
      ΓêÜ should handle CSV upload with product updates (lines 2061-2069) (549 ms)
      ΓêÜ should handle CSV upload with validation errors (lines 2096) (400 ms)
      ΓêÜ should handle CSV upload server errors (lines 2110-2111) (367 ms)
      ΓêÜ should handle CSV upload with mixed results (lines 2061-2111) (526 ms)
    Database Error Handler Coverage (Phase 24.2)
      ΓêÜ should trigger toggle-open database error (lines 50-51) (535 ms)
      ΓêÜ should trigger product PUT database error (lines 114-115) (531 ms)
      ΓêÜ should trigger product PATCH database error (lines 135-136) (555 ms)
      ΓêÜ should trigger product DELETE database error (lines 168-169) (536 ms)
      ΓêÜ should trigger product listing database error (lines 179-180) (531 ms)
      ΓêÜ should trigger order listing database error (lines 248-249) (622 ms)
      ΓêÜ should trigger pending orders database error (lines 303-304) (536 ms)
      ΓêÜ should trigger SSE connection error (lines 383-385) (5539 ms)
      ΓêÜ should trigger order detail fetch database error (lines 368-369) (550 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/auth.test.js (75.117 s)
  Authentication - Integration Tests
    POST /api/admin/login - Admin Login
      ΓêÜ should login successfully with valid credentials (1728 ms)
      ΓêÜ should fail with invalid email (836 ms)
      ΓêÜ should fail with invalid password (947 ms)
      ΓêÜ should fail with missing credentials (798 ms)
    POST /api/auth/login/seller - Seller Login
      ΓêÜ should login successfully with valid credentials (902 ms)
      ΓêÜ should fail with invalid email (832 ms)
      ΓêÜ should fail with invalid password (904 ms)
    POST /api/auth/signup/seller - Seller Registration
      ΓêÜ should register new seller successfully (774 ms)
      ΓêÜ should fail with duplicate email (832 ms)
      ΓêÜ should fail with missing required fields (732 ms)
      ΓêÜ should fail with invalid email format (729 ms)
    POST /api/auth/signup/client - Client Registration
      ΓêÜ should register new client successfully (781 ms)
      ΓêÜ should fail with duplicate firebase_uid (794 ms)
      ΓêÜ should fail with missing required fields (687 ms)
      ΓêÜ should create client with optional name (768 ms)
      ΓêÜ should validate phone number format (689 ms)
      ΓêÜ should handle duplicate firebase_uid detection (776 ms)
    POST /api/auth/forgot-password - Password Reset Request
      ΓêÜ should generate reset token for valid seller email (882 ms)
      ΓêÜ should generate reset token for valid admin email (881 ms)
      ΓêÜ should not reveal if email does not exist (security) (743 ms)
      ΓêÜ should fail with missing email field (690 ms)
      ΓêÜ should fail with missing userType field (700 ms)
      ΓêÜ should reject password reset for client userType (686 ms)
    POST /api/auth/reset-password - Password Reset Execution
      ΓêÜ should reset password with valid token (1138 ms)
      ΓêÜ should fail with invalid token (839 ms)
      ΓêÜ should fail with expired token (947 ms)
      ΓêÜ should fail with weak password (less than 6 characters) (851 ms)
      ΓêÜ should fail with missing resetToken (864 ms)
      ΓêÜ should fail with missing newPassword (849 ms)
      ΓêÜ should fail with token having wrong purpose (850 ms)
    POST /api/auth/signup/delivery-agent - Delivery Agent Registration
      ΓêÜ should register new delivery agent successfully (778 ms)
      ΓêÜ should fail with duplicate email (1041 ms)
      ΓêÜ should fail with missing required fields (733 ms)
      ΓêÜ should normalize email to lowercase (770 ms)
    GET /api/auth/user/:firebase_uid - User Lookup
      ΓêÜ should retrieve client by firebase_uid (893 ms)
      ΓêÜ should retrieve seller by firebase_uid (815 ms)
      ΓêÜ should retrieve admin by firebase_uid (830 ms)
      ΓêÜ should return 404 for non-existent firebase_uid (850 ms)
    GET /api/auth/seller-id/:firebase_uid - Seller ID Lookup
      ΓêÜ should return seller_id for valid firebase_uid (773 ms)
      ΓêÜ should return 404 for non-seller firebase_uid (774 ms)
    GET /api/auth/role-by-email - Role Lookup by Email
      ΓêÜ should return admin role for admin email (832 ms)
      ΓêÜ should return seller role for seller email (823 ms)
      ΓêÜ should return 404 for non-existent email (895 ms)
      ΓêÜ should fail with invalid email format (682 ms)
      ΓêÜ should be case-insensitive for email lookup (819 ms)
    POST /api/auth/map-by-email - Map Firebase UID to Email
      ΓêÜ should map firebase_uid to existing seller by email (864 ms)
      ΓêÜ should map firebase_uid to existing admin by email (831 ms)
      ΓêÜ should return 404 for non-existent email (854 ms)
      ΓêÜ should fail with missing email (734 ms)
      ΓêÜ should fail with missing firebase_uid (682 ms)
      ΓêÜ should be case-insensitive for email mapping (828 ms)
    POST /api/auth/logout - Session Termination
      ΓêÜ should logout with firebase_uid in body (1497 ms)
      ΓêÜ should logout with both firebase_uid and internal_id (1144 ms)
      ΓêÜ should fail logout with missing firebase_uid (684 ms)
      ΓêÜ should clear device tokens on logout (1160 ms)
    GET /api/auth/whoami - Identity Inspection
      ΓêÜ should identify admin by firebase_uid (828 ms)
      ΓêÜ should identify seller by email (822 ms)
      ΓêÜ should identify delivery agent by firebase_uid (833 ms)
      ΓêÜ should identify client by firebase_uid (969 ms)
      ΓêÜ should handle non-existent user lookup (778 ms)
      ΓêÜ should fail with missing parameters (730 ms)
      ΓêÜ should handle email lookup (case-insensitive) (819 ms)
      ΓêÜ should prioritize admin role when multiple matches exist (927 ms)
    Phase 21: Error Paths & Edge Cases Coverage
      Section 1: JWT Secret Validation
        ΓêÜ should throw error if JWT_SECRET is not set (734 ms)
      Section 2: Client Signup Error Handling
        ΓêÜ should handle database error during client creation (733 ms)
        ΓêÜ should handle validation error during client creation (734 ms)
      Section 3: Seller Signup Error Handling
        ΓêÜ should return 400 for validation error (missing required fields) (775 ms)
        ΓêÜ should return 400 for invalid email format (773 ms)
        ΓêÜ should handle database error during seller creation (775 ms)
      Section 4: Seller Login Error Handling
        ΓêÜ should handle database error during seller login (728 ms)
        ΓêÜ should return 401 for seller not found (1033 ms)
        ΓêÜ should return 401 for incorrect password (1466 ms)
      Section 5: Password Reset Error Handling
        ΓêÜ should handle database error during password reset request (732 ms)
        ΓêÜ should handle database error during password reset execution (835 ms)
        ΓêÜ should return 400 for expired reset token (840 ms)
      Section 6: Delivery Agent Signup Error Handling
        ΓêÜ should handle database error during agent creation (792 ms)
        ΓêÜ should return 400 for invalid vehicle type (775 ms)
      Section 7: User Lookup Error Handling
        ΓêÜ should handle database error during user lookup (858 ms)
        ΓêÜ should return 404 for non-existent user (902 ms)
      Section 8: Role Lookup Error Handling
        ΓêÜ should handle database error during role lookup (730 ms)
        ΓêÜ should return 404 for email not found in any collection (904 ms)
      Section 9: Email Mapping Error Handling
        ΓêÜ should handle database error during email mapping (731 ms)
        ΓêÜ should return 404 if email not found during mapping (1155 ms)
      Section 10: Seller ID Lookup Error Handling
        ΓêÜ should handle database error during seller ID lookup (731 ms)
        ΓêÜ should return 404 for non-existent seller (791 ms)
      Section 11: WhoAmI Error Handling
        ΓêÜ should handle database error during whoami lookup (732 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db481a7be4cb310c592f1 cancelled - SSE and push notifications sent to customer, seller, and admin

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db487a7be4cb310c5938b cancelled - SSE and push notifications sent to customer, seller, and admin

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db488a7be4cb310c593af cancelled - SSE and push notifications sent to customer, seller, and admin

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/orders.test.js (76.714 s)
  Orders Controller - Unit Tests
    POST /api/orders - Create Order
      ΓêÜ should create order successfully with valid data (2411 ms)
      ΓêÜ should fail when product does not exist (1059 ms)
      ΓêÜ should fail when product is not available (1092 ms)
      ΓêÜ should fail when stock is insufficient (1078 ms)
      ΓêÜ should apply valid coupon correctly (1703 ms)
      ΓêÜ should fail when coupon is invalid (1296 ms)
      ΓêÜ should fail when coupon usage limit reached (1263 ms)
      ΓêÜ should fail when user already used coupon (max uses per user) (1264 ms)
      ΓêÜ should fail without authentication (992 ms)
      ΓêÜ should fail when items array is empty (982 ms)
      ΓêÜ should handle invalid payment method (980 ms)
      ΓêÜ should split multi-seller orders by category (2141 ms)
      ΓêÜ should handle large quantity orders (1652 ms)
      ΓêÜ should default to quantity 1 when quantity is zero (977 ms)
      ΓêÜ should allow guest orders with client_id in body (1552 ms)
      ΓêÜ should fail when coupon minimum subtotal not met (1247 ms)
      ΓêÜ should fail when coupon is expired (1246 ms)
      ΓêÜ should fail when coupon is inactive (1496 ms)
      ΓêÜ should validate stock for all products (1072 ms)
      ΓêÜ should allow orders for products with null stock (1610 ms)
      ΓêÜ should fail when delivery address is missing (1066 ms)
      ΓêÜ should handle delivery address without coordinates (1550 ms)
      ΓêÜ should handle order notes with special characters (1809 ms)
      ΓêÜ should handle negative quantity values (975 ms)
      ΓêÜ should handle duplicate product IDs in order (1556 ms)
      ΓêÜ should handle very long delivery addresses (993 ms)
      ΓêÜ should accept 'qty' as alternative to 'quantity' (1557 ms)
      ΓêÜ should handle coupon with zero discount (1761 ms)
    GET /api/orders/:id - Get Order Status
      ΓêÜ should retrieve order status successfully (1228 ms)
      ΓêÜ should fail to retrieve non-existent order (1019 ms)
      ΓêÜ should fail to retrieve order without authentication (1148 ms)
      ΓêÜ should handle invalid order ID format (974 ms)
    GET /api/orders/history - Get Order History
      ΓêÜ should retrieve order history successfully (1264 ms)
      ΓêÜ should support pagination in order history (1303 ms)
      ΓêÜ should filter orders by status (1259 ms)
      ΓêÜ should return empty array for user with no orders (1304 ms)
      ΓêÜ should fail to get history without authentication (1260 ms)
    Phase 22.4: Section 1 - GET /api/orders/:id/admin-detail
      ΓêÜ should return enriched order details with earnings breakdown (1310 ms)
      ΓêÜ should return 404 when order does not exist (1016 ms)
      ΓêÜ should calculate commission for multi-seller orders (1275 ms)
      ΓêÜ should include delivery agent earnings when assigned (1402 ms)
      ΓêÜ should handle database error gracefully (979 ms)
      ΓêÜ should fallback to calculated earnings when EarningLog not found (1549 ms)
      ΓêÜ should handle orders with no products gracefully (1346 ms)
      ΓêÜ should use default rates when PlatformSettings missing (1275 ms)
    Phase 22.4: Section 2 - GET /api/orders/:id/stream
      ΓêÜ should establish SSE connection with correct headers (1544 ms)
      ΓêÜ should send initial snapshot when order exists (1478 ms)
      ΓêÜ should handle non-existent order gracefully (1137 ms)
    Phase 22.4: Section 3 - POST /api/orders/:orderId/cancel
      ΓêÜ should cancel order successfully (1365 ms)
      ΓêÜ should return 400 when cancelled_by is missing (1079 ms)
      ΓêÜ should return 404 when order does not exist (1022 ms)
      ΓêÜ should return 400 when order is already delivered (1070 ms)
      ΓêÜ should return 400 when order is already cancelled (1155 ms)
      ΓêÜ should use default reason when cancellation_reason not provided (1350 ms)
      ΓêÜ should free up delivery agent when order has agent assigned (1690 ms)
      ΓêÜ should handle SSE/push notification errors gracefully (1198 ms)
      ΓêÜ should handle database error during save (1021 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/wishlist.test.js (54.223 s)
  POST /api/wishlist - Add to Wishlist
    ΓêÜ should add product to wishlist with valid data (2173 ms)
    ΓêÜ should reject add without authentication (980 ms)
    ΓêÜ should reject add without product_id (999 ms)
    ΓêÜ should reject add for non-existent product (1019 ms)
    ΓêÜ should reject duplicate wishlist entry (1300 ms)
    ΓêÜ should allow adding multiple different products (1289 ms)
  GET /api/wishlist - Get Wishlist
    ΓêÜ should retrieve user's wishlist with populated products (1258 ms)
    ΓêÜ should return empty array for user with no wishlist items (1075 ms)
    ΓêÜ should support pagination (1287 ms)
    ΓêÜ should reject request without authentication (993 ms)
    ΓêÜ should filter out items where product no longer exists (1201 ms)
    ΓêÜ should sort wishlist by added_at (newest first) (1277 ms)
  GET /api/wishlist/check/:productId - Check if in Wishlist
    ΓêÜ should return true when product is in wishlist (1094 ms)
    ΓêÜ should return false when product is not in wishlist (1038 ms)
    ΓêÜ should reject check without authentication (1010 ms)
    ΓêÜ should handle database error in check wishlist (984 ms)
  DELETE /api/wishlist/:productId - Remove from Wishlist
    ΓêÜ should remove product from wishlist (1108 ms)
    ΓêÜ should return 404 when product not in wishlist (1014 ms)
    ΓêÜ should reject delete without authentication (996 ms)
    ΓêÜ should only remove product for authenticated user (1149 ms)
  DELETE /api/wishlist - Clear Entire Wishlist
    ΓêÜ should clear entire wishlist (1213 ms)
    ΓêÜ should return 0 deletedCount when wishlist is already empty (1013 ms)
    ΓêÜ should reject clear without authentication (1004 ms)
    ΓêÜ should only clear wishlist for authenticated user (1239 ms)
  Database Error Handlers
    ΓêÜ should handle database error in POST wishlist (1059 ms)
    ΓêÜ should handle database error in GET wishlist (979 ms)
    ΓêÜ should handle database error in DELETE wishlist item (967 ms)
    ΓêÜ should handle database error in clear wishlist (997 ms)
  Phase 21.2: Error Paths & Edge Cases Coverage
    POST /api/wishlist - Advanced Error Handling
      ΓêÜ should return 404 when adding non-existent product (1019 ms)
      ΓêÜ should handle Product.findById database error (1032 ms)
      ΓêÜ should handle Wishlist.findOne database error (duplicate check) (1014 ms)
    GET /api/wishlist - Pagination & Query Errors
      ΓêÜ should handle Wishlist.countDocuments database error (1016 ms)
      ΓêÜ should handle populate() error gracefully (1021 ms)
      ΓêÜ should handle pagination with invalid page/limit (1058 ms)
    GET /api/wishlist/check/:productId - Error Handling
      ΓêÜ should handle database error in check endpoint (974 ms)
      ΓêÜ should handle invalid product ID format (970 ms)
    DELETE /api/wishlist/:productId - Not Found & Errors
      ΓêÜ should return 404 when removing non-existent wishlist item (1013 ms)
      ΓêÜ should handle database error in findOneAndDelete (1009 ms)
    DELETE /api/wishlist - Clear Wishlist Edge Cases
      ΓêÜ should successfully clear empty wishlist (1057 ms)
      ΓêÜ should handle database error in deleteMany (975 ms)
    Validation & Authorization Edge Cases
      ΓêÜ POST should return 400 for missing product_id (973 ms)
      ΓêÜ POST should return 400 when product already in wishlist (1240 ms)
      ΓêÜ should verify wishlist query filters by client_id (1441 ms)
    Logger Coverage - Production Paths
      ΓêÜ should log successful wishlist addition (1171 ms)
      ΓêÜ should log errors during wishlist operations (1077 ms)
      ΓêÜ should log successful wishlist item removal (1177 ms)
      ΓêÜ should log successful wishlist clear (1100 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/users.test.js (47.775 s)
  Users Routes - Complete Coverage
    GET /api/users/:uid/addresses - List Addresses
      ΓêÜ should return empty array when no addresses exist (2080 ms)
      ΓêÜ should return all user addresses sorted by created_at desc (1057 ms)
      ΓêÜ should only return addresses for specific user (1034 ms)
      ΓêÜ should handle database errors gracefully (943 ms)
    POST /api/users/:uid/addresses - Create Address
      ΓêÜ should create new address successfully (987 ms)
      ΓêÜ should create address as default and unset other defaults (1091 ms)
      ΓêÜ should handle missing required fields (909 ms)
    PUT /api/users/:uid/addresses/:addressId - Update Address
      ΓêÜ should update address successfully (1027 ms)
      ΓêÜ should update to default and unset other defaults (1125 ms)
      ΓêÜ should return 404 for non-existent address (952 ms)
      ΓêÜ should not update address of different user (1018 ms)
    DELETE /api/users/:uid/addresses/:addressId - Delete Address
      ΓêÜ should delete address successfully (1036 ms)
      ΓêÜ should return 404 for non-existent address (1059 ms)
      ΓêÜ should not delete address of different user (1030 ms)
    GET /api/users/:uid/profile - Get Profile
      ΓêÜ should return user profile (949 ms)
      ΓêÜ should return 404 for non-existent user (942 ms)
    PUT /api/users/:uid/profile - Update Profile
      ΓêÜ should update existing user profile (1063 ms)
      ΓêÜ should create profile if not exists (upsert) (958 ms)
      ΓêÜ should handle partial updates (949 ms)
    PUT /api/users/:uid/preferences - Update Preferences
      ΓêÜ should update notification preferences (1098 ms)
      ΓêÜ should default to true if not specified (945 ms)
      ΓêÜ should create profile with preferences if not exists (940 ms)
    GET /api/users/:uid/orders - Order History
      ΓêÜ should return empty array when no orders exist (988 ms)
      ΓêÜ should return user orders with pagination (1134 ms)
      ΓêÜ should filter orders by payment status (1216 ms)
      ΓêÜ should support pagination parameters (1718 ms)
      ΓêÜ should not return orders of other users (1027 ms)
      ΓêÜ should sort orders by created_at descending (1252 ms)
    POST /api/users/:uid/feedback - Submit Feedback
      ΓêÜ should create feedback successfully (936 ms)
      ΓêÜ should reject feedback with short message (894 ms)
      ΓêÜ should reject feedback without message (992 ms)
      ΓêÜ should trim whitespace from message (938 ms)
      ΓêÜ should create feedback without type (934 ms)
      ΓêÜ should reject empty body (1162 ms)
    Error Handling - Database Errors
      ΓêÜ should handle missing UID in requireUser middleware (unit test) (896 ms)
      ΓêÜ should pass through with valid UID in requireUser middleware (unit test) (922 ms)
      ΓêÜ should handle database error in GET addresses (896 ms)
      ΓêÜ should handle database error in PUT address (939 ms)
      ΓêÜ should handle database error in DELETE address (934 ms)
      ΓêÜ should handle database error in GET profile (968 ms)
      ΓêÜ should handle database error in PUT profile (897 ms)
      ΓêÜ should handle database error in PUT preferences (889 ms)
      ΓêÜ should handle database error in GET orders (888 ms)
      ΓêÜ should handle database error in POST feedback (921 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/reviews.test.js (47.464 s)
  Reviews & Ratings API
    POST /api/reviews - Create Review
      ΓêÜ should create review with valid data and verified purchase (1833 ms)
      ΓêÜ should create review without verified purchase (no order) (1188 ms)
      ΓêÜ should create review without comment (rating only) (1069 ms)
      ΓêÜ should reject review without product_id (887 ms)
      ΓêÜ should reject review without rating (887 ms)
      ΓêÜ should reject review for non-existent product (939 ms)
      ΓêÜ should reject duplicate review (same user, same product) (1162 ms)
      ΓêÜ should reject review without authentication (903 ms)
      ΓêÜ should reject review with invalid rating (< 1) (908 ms)
      ΓêÜ should reject review with invalid rating (> 5) (1046 ms)
      ΓêÜ should accept review with multiple images (1165 ms)
    GET /api/reviews/product/:productId - Get Product Reviews
      ΓêÜ should retrieve all reviews for a product (1598 ms)
      ΓêÜ should return rating statistics (1066 ms)
      ΓêÜ should support pagination (1070 ms)
      ΓêÜ should support sorting by creation date (1106 ms)
      ΓêÜ should return empty array for product with no reviews (1140 ms)
      ΓêÜ should handle invalid product ID format (953 ms)
    GET /api/reviews/user - Get User's Reviews
      ΓêÜ should retrieve all reviews by authenticated user (1134 ms)
      ΓêÜ should populate product details in user reviews (1151 ms)
      ΓêÜ should support pagination for user reviews (1120 ms)
      ΓêÜ should return empty array for user with no reviews (1365 ms)
      ΓêÜ should reject request without authentication (980 ms)
    PUT /api/reviews/:reviewId - Update Review
      ΓêÜ should update review rating (1030 ms)
      ΓêÜ should update review comment (1099 ms)
      ΓêÜ should update review images (1028 ms)
      ΓêÜ should update multiple fields simultaneously (1031 ms)
      ΓêÜ should reject update for non-existent review (1004 ms)
      ΓêÜ should reject update by non-owner (982 ms)
      ΓêÜ should update updated_at timestamp (1372 ms)
      ΓêÜ should reject update without authentication (936 ms)
    DELETE /api/reviews/:reviewId - Delete Review
      ΓêÜ should delete own review (1068 ms)
      ΓêÜ should reject delete for non-existent review (979 ms)
      ΓêÜ should reject delete by non-owner (1056 ms)
      ΓêÜ should reject delete without authentication (929 ms)
    POST /api/reviews/:reviewId/helpful - Mark Review as Helpful
      ΓêÜ should increment helpful count (1066 ms)
      ΓêÜ should allow multiple helpful marks (no duplicate prevention) (1111 ms)
      ΓêÜ should reject helpful mark for non-existent review (983 ms)
      ΓêÜ should reject helpful mark without authentication (930 ms)
    Database Error Handlers
      ΓêÜ should handle database error in GET user reviews (984 ms)
      ΓêÜ should handle database error in UPDATE review (931 ms)
      ΓêÜ should handle database error in DELETE review (933 ms)
      ΓêÜ should handle database error in mark helpful (979 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/admin_extensions.test.js (36.654 s)
  PATCH /api/admin/roles/:id - Update Admin Role
    ΓêÜ should update moderator role to superadmin (2063 ms)
    ΓêÜ should update superadmin role to moderator (when multiple superadmins exist) (1353 ms)
    ΓêÜ should reject demotion of last remaining superadmin (1158 ms)
    ΓêÜ should reject invalid role value (1027 ms)
    ΓêÜ should reject invalid admin ID (1026 ms)
    ΓêÜ should return 404 for non-existent admin (1060 ms)
  DELETE /api/admin/roles/:id - Delete Admin
    ΓêÜ should delete moderator successfully (1155 ms)
    ΓêÜ should reject deletion of last remaining superadmin (1148 ms)
    ΓêÜ should allow deletion of superadmin when multiple exist (1441 ms)
    ΓêÜ should reject invalid admin ID (1024 ms)
    ΓêÜ should return 404 for non-existent admin (1078 ms)
  GET /api/admin/payouts/summary - Payout Summary
    ΓêÜ should return payout summary with aggregated earnings (1367 ms)
    ΓêÜ should filter payout summary by date range (1644 ms)
    ΓêÜ should return empty rows array when no payouts exist (2059 ms)
  GET /api/admin/payouts/logs - Payout Logs
    ΓêÜ should return payout logs with pagination (1859 ms)
    ΓêÜ should support pagination with page and limit (1890 ms)
    ΓêÜ should filter payout logs by seller_id (1920 ms)
  DELETE /api/admin/sellers/:id - Cascade Delete
    ΓêÜ should cascade delete seller with all related data (1818 ms)
    ΓêÜ should return cascade summary with counts (1582 ms)
    ΓêÜ should support full delete with Firebase user deletion (2412 ms)
    ΓêÜ should return 404 for non-existent seller (1346 ms)
  DELETE /api/admin/delivery-agents/:id - Cascade Delete
    ΓêÜ should cascade delete agent and unassign from orders (1560 ms)
    ΓêÜ should return 404 for non-existent agent (1311 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒôí version env with Radar: https://dotenvx.com/radar

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒôí observe env with Radar: https://dotenvx.com/radar

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db56172b9387b86da96d8 cancelled - SSE and push notifications sent to customer, seller, and admin

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db56372b9387b86da970a cancelled - SSE and push notifications sent to customer, seller, and admin

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db56872b9387b86da9790 cancelled - SSE and push notifications sent to customer, seller, and admin

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/orders_edge_cases.test.js (38.549 s)
  Orders Controller - Edge Cases & Advanced Features
    PATCH /api/orders/:id/delivery - Status Transitions
      ΓêÜ should transition to 'dispatched' and set delivery_start_time (2443 ms)
      ΓêÜ should calculate delivery charge on dispatch for grocery (30) (1840 ms)
      ΓêÜ should calculate delivery charge on dispatch for food (40) (1672 ms)
      ΓêÜ should waive delivery charge when subtotal exceeds threshold (1618 ms)
      ΓêÜ should not recalculate delivery charge if already set (1575 ms)
      ΓêÜ should transition to 'delivered' and set delivery_end_time (1764 ms)
      ΓêÜ should increment agent completed_orders on delivery (1996 ms)
      ΓêÜ should create EarningLog entries on delivery (seller + agent) (2212 ms)
      ΓêÜ should reject invalid delivery status (1237 ms)
      ΓêÜ should update delivery status independently without ETA (1654 ms)
    GET /api/orders/:id/admin-detail - Admin Analytics
      ΓêÜ should return admin detail with earnings breakdown (1274 ms)
      ΓêÜ should calculate agent earnings when agent assigned (1402 ms)
      ΓêÜ should return 404 for non-existent order (1051 ms)
      ΓêÜ should prefer EarningLog values when available (post-delivery) (1303 ms)
    POST /api/orders/:orderId/cancel - Order Cancellation
      ΓêÜ should cancel order successfully with reason (1762 ms)
      ΓêÜ should set agent to null properly when order created without agent (2047 ms)
      ΓêÜ should reject cancellation without cancelled_by (1037 ms)
      ΓêÜ should reject cancellation of already delivered order (1128 ms)
      ΓêÜ should reject cancellation of already cancelled order (1131 ms)
      ΓêÜ should provide default cancellation reason if not specified (1713 ms)
    POST /api/orders/:id/verify - Payment Verification
      ΓêÜ should verify payment and update status to 'paid' (1654 ms)
      ΓêÜ should reject verification with invalid status (990 ms)
      ΓêÜ should mark payment as failed when status is 'failed' (1682 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/restaurant_manage.test.js (32.52 s)
  Phase 22.2: Restaurant Management
    Section 1: Get Restaurant Profile
      ΓêÜ should get restaurant profile with valid sellerId in query (1563 ms)
      ΓêÜ should get restaurant profile with sellerId in headers (790 ms)
      ΓêÜ should get restaurant profile with seller_id in body (794 ms)
      ΓêÜ should return all restaurant fields including optional ones (792 ms)
      ΓêÜ should return 404 when seller does not exist (736 ms)
      ΓêÜ should return 400 when sellerId is missing (702 ms)
      ΓêÜ should return 400 when sellerId is invalid ObjectId (724 ms)
      ΓêÜ should return 500 when database error occurs (737 ms)
    Section 2: Update Restaurant Profile
      ΓêÜ should update business_name (826 ms)
      ΓêÜ should update business_type from restaurant to grocery (1058 ms)
      ΓêÜ should update address field (837 ms)
      ΓêÜ should update description field (787 ms)
      ΓêÜ should update cuisine field (783 ms)
      ΓêÜ should update logo_url (783 ms)
      ΓêÜ should update banner_url (816 ms)
      ΓêÜ should update opening_hours (785 ms)
      ΓêÜ should update location object (788 ms)
      ΓêÜ should update place_id (874 ms)
      ΓêÜ should update delivery_radius_km (791 ms)
      ΓêÜ should update multiple fields at once (791 ms)
      ΓêÜ should ignore non-allowed fields in update (786 ms)
      ΓêÜ should return updated seller when no fields provided (789 ms)
      ΓêÜ should use sellerId from headers for update (785 ms)
      ΓêÜ should use seller_id from body for update (priority over query) (921 ms)
      ΓêÜ should return 404 when updating non-existent seller (741 ms)
      ΓêÜ should return 400 when sellerId is missing (692 ms)
      ΓêÜ should return 400 when sellerId is invalid ObjectId (694 ms)
      ΓêÜ should return 500 when database error occurs during update (734 ms)
    Section 3: Edge Cases and Data Validation
      ΓêÜ should handle empty string values in update (786 ms)
      ΓêÜ should handle null values in update (785 ms)
      ΓêÜ should handle very long string values (804 ms)
      ΓêÜ should handle special characters in text fields (782 ms)
      ΓêÜ should handle numeric delivery_radius_km as string (788 ms)
      ΓêÜ should handle updating with same values (no actual change) (778 ms)
    Section 4: requireSeller Middleware
      ΓêÜ should prioritize seller_id from body over query (831 ms)
      ΓêÜ should prioritize seller_id from body over header (907 ms)
      ΓêÜ should fall back to header when body and query are empty (782 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/restaurants.test.js (34.8 s)
  GET /api/restaurants - List Restaurants
    ΓêÜ should retrieve all approved restaurants (2058 ms)
    ΓêÜ should include product samples for each restaurant (1100 ms)
    ΓêÜ should calculate average rating from products (1068 ms)
    ΓêÜ should support search by business name (1196 ms)
    ΓêÜ should support search by cuisine (1217 ms)
    ΓêÜ should support search by description (1217 ms)
    ΓêÜ should support search by product name (1244 ms)
    ΓêÜ should return empty array for non-matching search (1189 ms)
    ΓêÜ should support pagination with page and limit (1231 ms)
    ΓêÜ should handle page 2 of paginated results (1191 ms)
    ΓêÜ should use default pagination values when not specified (1085 ms)
    ΓêÜ should only include approved sellers (1190 ms)
    ΓêÜ should include sellers with restaurant products even if business_type is not restaurant (1124 ms)
    ΓêÜ should only include active products in samples (1117 ms)
    ΓêÜ should limit product samples to 5 per restaurant (1317 ms)
    ΓêÜ should return null rating when no products exist (1113 ms)
    ΓêÜ should handle special characters in search query (1196 ms)
    ΓêÜ should escape regex special characters in search (1193 ms)
    ΓêÜ should handle empty search query (1157 ms)
    ΓêÜ should handle whitespace-only search query (1062 ms)
    ΓêÜ should include is_open status (1069 ms)
    ΓêÜ should default is_open to true when not specified (1122 ms)
    ΓêÜ should include optional fields (logo, banner, address) (1165 ms)
    ΓêÜ should handle restaurants with no cuisine (1057 ms)
    ΓêÜ should handle case-insensitive search (1444 ms)
  Edge Cases and Additional Coverage
    ΓêÜ should handle restaurants with multiple product categories (1108 ms)
    ΓêÜ should handle maximum pagination limit (1194 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/middleware/couponValidation.unit.test.js (31.242 s)
  Coupon Validation Middleware - Unit Tests
    validateCoupon - Happy Paths
      ΓêÜ should pass through when no coupon code provided (1752 ms)
      ΓêÜ should validate valid coupon and calculate discount (895 ms)
      ΓêÜ should handle lowercase coupon codes (834 ms)
      ΓêÜ should round discount to 2 decimal places (1236 ms)
    validateCoupon - Error Cases
      ΓêÜ should reject when no platform settings exist (789 ms)
      ΓêÜ should reject when coupons array is empty (839 ms)
      ΓêÜ should reject invalid coupon code (836 ms)
      ΓêÜ should reject inactive coupon (827 ms)
      ΓêÜ should reject coupon not yet valid (864 ms)
      ΓêÜ should reject expired coupon (824 ms)
      ΓêÜ should reject when total usage limit reached (846 ms)
      ΓêÜ should reject when user usage limit reached (843 ms)
      ΓêÜ should reject when subtotal below minimum (834 ms)
      ΓêÜ should reject when category doesn't match (829 ms)
      ΓêÜ should handle category case insensitively (993 ms)
      ΓêÜ should handle server errors gracefully (758 ms)
    validateCoupon - Edge Cases
      ΓêÜ should allow coupon with no date restrictions (832 ms)
      ΓêÜ should allow coupon with no usage limits (839 ms)
      ΓêÜ should allow coupon with no category restrictions (830 ms)
      ΓêÜ should calculate discount as 0 when no subtotal provided (832 ms)
      ΓêÜ should allow user below per-user limit (831 ms)
      ΓêÜ should allow new user when coupon has existing users (832 ms)
      ΓêÜ should handle usage_limit of 0 (828 ms)
    updateCouponUsage - Unit Tests
      ΓêÜ should increment usage count for first-time user (938 ms)
      ΓêÜ should increment existing user usage count (995 ms)
      ΓêÜ should handle lowercase coupon code (922 ms)
      ΓêÜ should handle null coupon code gracefully (753 ms)
      ΓêÜ should handle undefined coupon code gracefully (736 ms)
      ΓêÜ should handle empty coupon code gracefully (781 ms)
      ΓêÜ should handle missing platform settings gracefully (777 ms)
      ΓêÜ should handle nonexistent coupon code gracefully (833 ms)
      ΓêÜ should update usage without client_id (1002 ms)
      ΓêÜ should initialize used_by array if missing (921 ms)
      ΓêÜ should handle database errors gracefully (738 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒôí observe env with Radar: https://dotenvx.com/radar

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [upsertClient] claiming legacy phone record _id=692db5e22716dd05eaf08a17 for uid=new_uid_001

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [upsertClient] reassigning orphan phone record from uid=orphan_uid to uid=new_uid_002

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/controllers/clientsController.test.js (31.743 s)
  Clients Controller & Routes Tests
    POST /api/clients/upsert - Create/Update Client
      Success Cases
        ΓêÜ should create new client with required fields (1816 ms)
        ΓêÜ should update existing client profile (1122 ms)
        ΓêÜ should create client with minimal data (name only) (956 ms)
        ΓêÜ should create client with phone only (1278 ms)
        ΓêÜ should parse and store valid DOB (1080 ms)
        ΓêÜ should mark profile_completed when all fields present (1002 ms)
        ΓêÜ should use first_name as name if name not provided (997 ms)
        ΓêÜ should combine first_name and last_name for name (1006 ms)
      Validation & Error Cases
        ΓêÜ should reject request without firebase_uid (799 ms)
        ΓêÜ should reject new client without any identity fields (887 ms)
        ΓêÜ should reject duplicate phone number (997 ms)
        ΓêÜ should reject if firebase_uid belongs to admin (916 ms)
        ΓêÜ should reject if firebase_uid belongs to seller (963 ms)
        ΓêÜ should ignore invalid DOB format (1057 ms)
      Phone Claiming Logic (when ALLOW_PHONE_CLAIM=1)
        ΓêÜ should claim legacy phone record without firebase_uid (1190 ms)
        ΓêÜ should reassign orphan phone record (1147 ms)
    POST /api/clients/complete-profile
      ΓêÜ should complete profile with all required fields (786 ms)
      ΓêÜ should complete profile without DOB (optional) (782 ms)
      ΓêÜ should reject without firebase_uid (791 ms)
      ΓêÜ should reject without first_name (732 ms)
      ΓêÜ should reject without phone (733 ms)
      ΓêÜ should reject invalid DOB (736 ms)
      ΓêÜ should upsert client if not exists (823 ms)
    GET /api/clients/:uid - Get Client Profile
      ΓêÜ should return client profile by firebase_uid (933 ms)
      ΓêÜ should return 404 if client not found (781 ms)
      ΓêÜ should return 400 if uid missing (732 ms)
    PUT /api/clients/:uid - Update Client Profile
      ΓêÜ should update existing client profile (826 ms)
      ΓêÜ should update avatar_url (834 ms)
      ΓêÜ should create client if not exists (upsert) (870 ms)
      ΓêÜ should handle partial updates (834 ms)
      ΓêÜ should ignore email field (removed from spec) (840 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/auth_comprehensive.test.js (31.419 s)
  Phase 9: Auth Routes - Comprehensive Security Testing
    Section 1: Client Signup & Validation
      ΓêÜ 1.1: Should create new client with valid firebase_uid (1158 ms)
      ΓêÜ 1.2: Should reject duplicate client with same firebase_uid (301 ms)
      ΓêÜ 1.3: Should create client without firebase_uid (267 ms)
      ΓêÜ 1.4: Should handle missing required fields (phone) (216 ms)
      ΓêÜ 1.5: Should handle server errors gracefully (258 ms)
    Section 2: Seller Signup & Address Validation
      ΓêÜ 2.1: Should create seller with complete information (301 ms)
      ΓêÜ 2.2: Should normalize email to lowercase (300 ms)
      ΓêÜ 2.3: Should reject duplicate seller email (305 ms)
      ΓêÜ 2.4: Should reject seller without address (255 ms)
      ΓêÜ 2.5: Should accept seller with address but no location (304 ms)
      ΓêÜ 2.6: Should handle validation errors (mongoose) (256 ms)
      ΓêÜ 2.7: Should trim whitespace from address (298 ms)
      ΓêÜ 2.8: Should reject empty string address (257 ms)
    Section 3: Seller Login & JWT Validation
      ΓêÜ 3.1: Should login with valid credentials (451 ms)
      ΓêÜ 3.2: Should reject invalid password (427 ms)
      ΓêÜ 3.3: Should reject non-existent email (391 ms)
      ΓêÜ 3.4: Should reject missing email (321 ms)
      ΓêÜ 3.5: Should reject missing password (333 ms)
      ΓêÜ 3.6: Should handle case-insensitive email login (446 ms)
    Section 4: Delivery Agent Signup
      ΓêÜ 4.1: Should create delivery agent with complete info (301 ms)
      ΓêÜ 4.2: Should normalize agent email to lowercase (300 ms)
      ΓêÜ 4.3: Should reject duplicate agent email (299 ms)
      ΓêÜ 4.4: Should handle server errors (253 ms)
    Section 5: User Lookup by Firebase UID
      ΓêÜ 5.1: Should return admin user (501 ms)
      ΓêÜ 5.2: Should return seller user (628 ms)
      ΓêÜ 5.3: Should return delivery agent user (592 ms)
      ΓêÜ 5.4: Should return client user (635 ms)
      ΓêÜ 5.5: Should return 404 for non-existent firebase_uid (627 ms)
      ΓêÜ 5.6: Should prioritize admin over other roles (656 ms)
    Section 6: Password Reset Flow
      ΓêÜ 6.1: Should generate reset token for seller (624 ms)
      ΓêÜ 6.2: Should generate reset token for delivery agent (564 ms)
      ΓêÜ 6.3: Should generate reset token for admin (571 ms)
      ΓêÜ 6.4: Should reject client userType (OTP-only) (481 ms)
      ΓêÜ 6.5: Should reject missing email (523 ms)
      ΓêÜ 6.6: Should reject missing userType (527 ms)
      ΓêÜ 6.7: Should not reveal if email doesn't exist (529 ms)
      ΓêÜ 6.8: Should reset password with valid token (883 ms)
      ΓêÜ 6.9: Should reject short password (< 6 chars) (583 ms)
      ΓêÜ 6.10: Should reject invalid reset token (490 ms)
      ΓêÜ 6.11: Should reject expired reset token (987 ms)
      ΓêÜ 6.12: Should reject token with wrong purpose (490 ms)
    Section 7: Logout & Device Token Management
      ΓêÜ 7.1: Should logout and clear device tokens (1145 ms)
      ΓêÜ 7.2: Should clear tokens for both firebase_uid and internal_id (778 ms)
      ΓêÜ 7.3: Should reject logout without firebase_uid (298 ms)
    Section 8: Email Mapping & Role Lookup
      ΓêÜ 8.1: Should map admin email to firebase_uid (465 ms)
      ΓêÜ 8.2: Should map seller email (case-insensitive) (497 ms)
      ΓêÜ 8.3: Should return 404 for non-existent email (542 ms)
      ΓêÜ 8.4: Should reject missing email (373 ms)
      ΓêÜ 8.5: Should lookup role by email (admin) (420 ms)
      ΓêÜ 8.6: Should lookup role by email (seller) (494 ms)
      ΓêÜ 8.7: Should handle case-insensitive role lookup (412 ms)
      ΓêÜ 8.8: Should return 404 for unknown email (529 ms)
      ΓêÜ 8.9: Should reject invalid email format (371 ms)
    Section 9: WhoAmI Identity Resolution
      ΓêÜ 9.1: Should resolve identity by firebase_uid (423 ms)
      ΓêÜ 9.2: Should resolve identity by email (440 ms)
      ΓêÜ 9.3: Should handle case-insensitive email (483 ms)
      ΓêÜ 9.4: Should return null role for non-existent user (440 ms)
      ΓêÜ 9.5: Should reject request without identifiers (388 ms)
      ΓêÜ 9.6: Should prioritize admin in effective_role (543 ms)
    Section 10: Seller ID Convenience Endpoint
      ΓêÜ 10.1: Should return seller_id for valid firebase_uid (319 ms)
      ΓêÜ 10.2: Should return 404 for non-seller firebase_uid (319 ms)
      ΓêÜ 10.3: Should return 404 for non-existent firebase_uid (320 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/services/push.test.js (32.116 s)
  Push Notifications Service - Comprehensive Tests
    FCM v1 API Integration
      ΓêÜ should send notification to single device token (1614 ms)
      ΓêÜ should send multicast notification to multiple tokens (931 ms)
      ΓêÜ should handle Firebase Admin not initialized gracefully (867 ms)
      ΓêÜ should handle messaging API unavailable (865 ms)
      ΓêÜ should chunk tokens to max 500 per request (1520 ms)
      ΓêÜ should convert non-string data values to JSON strings (2858 ms)
      ΓêÜ should track FCM success/failure counts (925 ms)
      ΓêÜ should handle invalid token format (865 ms)
    Channel Selection Logic
      ΓêÜ should default to 'orders_updates' channel (870 ms)
      ΓêÜ should use 'orders_alerts_v2' for offer notifications (is_offer=true) (912 ms)
      ΓêÜ should use 'orders_alerts_v2' for order alert notifications (873 ms)
      ΓêÜ should use custom sound for alert channel (910 ms)
      ΓêÜ should respect android_channel_id override in data (1062 ms)
    Notification Delivery - Role-Based
      ΓêÜ should send order status update notification to client (871 ms)
      ΓêÜ should send delivery assignment notification to agent (910 ms)
      ΓêÜ should send promotional offer notification (873 ms)
      ΓêÜ should send admin dashboard alert (959 ms)
      ΓêÜ should send seller notification with order details (1093 ms)
      ΓêÜ should handle empty token array gracefully (834 ms)
      ΓêÜ should skip notification when tokens is null/undefined (912 ms)
    Error Handling
      ΓêÜ should handle FCM network errors (861 ms)
      ΓêÜ should handle expired tokens (1122 ms)
      ΓêÜ should handle rate limiting from FCM (931 ms)
      ΓêÜ should continue on partial failures (some tokens succeed) (867 ms)
      ΓêÜ should handle database query failures gracefully (779 ms)
    Advanced Scenarios
      ΓêÜ should handle cancellation notifications with reason (1027 ms)
      ΓêÜ should exclude specific roles from notifications (1005 ms)
      ΓêÜ should compute item kinds correctly (grocery, vegetables, food) (866 ms)
      ΓêÜ should handle multi-seller orders (products from different sellers) (1135 ms)
      ΓêÜ should handle client_id as embedded object (889 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/products.test.js (31.838 s)
  Products - Integration Tests
    GET /api/products - List Products
      ΓêÜ should return all active products (1706 ms)
      ΓêÜ should filter products by category (580 ms)
      ΓêÜ should search products by name (574 ms)
      ΓêÜ should paginate products (561 ms)
      ΓêÜ should not return inactive products (477 ms)
    GET /api/products/:id - Get Product Details
      ΓêÜ should return product details (523 ms)
      ΓêÜ should return 404 for non-existent product (428 ms)
      ΓêÜ should return 400 for invalid product ID (382 ms)
    POST /api/products/prices - Bulk Price Check
      ΓêÜ should return prices for multiple products (478 ms)
      ΓêÜ should return empty array for empty ids (380 ms)
      ΓêÜ should handle mix of valid and invalid IDs (461 ms)
    Product Stock Management
      ΓêÜ should check stock availability (518 ms)
      ΓêÜ restaurant products should have unlimited stock (516 ms)
    Product Ratings
      ΓêÜ should calculate average rating correctly (510 ms)
    Seller-Specific Product Info
      ΓêÜ should include seller information with products (454 ms)
      ΓêÜ should show restaurant cuisine type (560 ms)
    Product Caching
      ΓêÜ should cache product listings (475 ms)
    POST /api/products/stock - Stock Validation
      ΓêÜ should validate stock for single item (473 ms)
      ΓêÜ should validate stock for multiple items (518 ms)
      ΓêÜ should handle insufficient stock (467 ms)
      ΓêÜ should treat restaurant items as unlimited stock (464 ms)
      ΓêÜ should reject items array missing (379 ms)
      ΓêÜ should reject empty items array (372 ms)
      ΓêÜ should handle non-existent product IDs (421 ms)
      ΓêÜ should handle inactive products (650 ms)
      ΓêÜ should calculate remaining stock correctly (563 ms)
    POST /api/products/quote - Price Quote Generation
      ΓêÜ should generate quote for single item (619 ms)
      ΓêÜ should generate quote for multiple items (641 ms)
      ΓêÜ should apply valid coupon (613 ms)
      ΓêÜ should reject expired coupon (701 ms)
      ΓêÜ should reject inactive coupon (616 ms)
      ΓêÜ should enforce minimum subtotal for coupon (615 ms)
      ΓêÜ should apply category-specific coupon (874 ms)
      ΓêÜ should not apply category-specific coupon to wrong category (630 ms)
      ΓêÜ should calculate delivery charge for grocery (612 ms)
      ΓêÜ should calculate delivery charge for food (610 ms)
      ΓêÜ should waive delivery charge above free delivery threshold (601 ms)
      ΓêÜ should calculate combined delivery charge for mixed categories (650 ms)
      ΓêÜ should handle out of stock items in quote (657 ms)
      ΓêÜ should handle partial stock availability (605 ms)
      ΓêÜ should reject quote without items array (479 ms)
      ΓêÜ should reject quote with empty items array (475 ms)
      ΓêÜ should handle invalid product IDs in quote (552 ms)
      ΓêÜ should calculate grand total correctly (611 ms)
      ΓêÜ should treat restaurant items as unlimited stock in quote (706 ms)
    Error Path Coverage
      ΓêÜ should return products with pagination (564 ms)
      ΓêÜ should handle invalid ObjectId in GET /products/:id (371 ms)
      ΓêÜ should handle database error in POST /products/prices (384 ms)
      ΓêÜ should handle database error in POST /products/stock (380 ms)
      ΓêÜ should handle quote with non-ObjectId product_id (428 ms)
      ΓêÜ should handle PlatformSettings error in quote gracefully (472 ms)
      ΓêÜ should handle PlatformSettings not found gracefully (457 ms)
      ΓêÜ should handle database query warning in quote (422 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/admin_phase8_settings.test.js (28.997 s)
  PHASE 8 SECTION 3: Platform Settings & Device Tokens
    Device Token Listing (GET /api/admin/device-tokens)
      ΓêÜ should list all device tokens with default limit (1517 ms)
      ΓêÜ should filter device tokens by userId (967 ms)
      ΓêÜ should filter device tokens by email (resolve from Client) (1051 ms)
      ΓêÜ should respect limit parameter (max 200) (1585 ms)
      ΓêÜ should return empty array when no tokens exist (917 ms)
      ΓêÜ should require admin authentication (858 ms)
    Device Tokens by Client (GET /api/admin/device-tokens/by-client)
      ΓêÜ should list tokens for specific client UID (952 ms)
      ΓêÜ should return 400 when uid parameter missing (858 ms)
      ΓêÜ should return empty array for client with no tokens (902 ms)
      ΓêÜ should require admin authentication (847 ms)
    Test Push Notifications (POST /api/admin/test-push)
      ΓêÜ should send test push to specific token (1450 ms)
      ΓêÜ should send test push to user by userId (1156 ms)
      ΓêÜ should send test push to user by email (990 ms)
      ΓêÜ should return 404 when no tokens found (905 ms)
      ΓêÜ should return 503 when Firebase Admin not initialized (857 ms)
      ΓêÜ should use default values for title and body (1017 ms)
      ΓêÜ should require admin authentication (842 ms)
    Platform Settings (PlatformSettings collection)
      ΓêÜ should retrieve platform settings (commission rate, delivery fees) (945 ms)
      ΓêÜ should use default commission rate when not set (896 ms)
      ΓêÜ should support coupon configuration in settings (955 ms)
    Email Resolution (_resolveUserIdsByEmail)
      ΓêÜ should resolve user IDs from Admin by email (1130 ms)
      ΓêÜ should resolve user IDs from Seller by email (1045 ms)
      ΓêÜ should resolve user IDs from DeliveryAgent by email (1344 ms)
      ΓêÜ should handle email not found in any collection (955 ms)
      ΓêÜ should handle case-insensitive email matching (1027 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒôí auto-backup env with Radar: https://dotenvx.com/radar

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/tokens.test.js (27.694 s)
  Phase 22.1: Device Token Registration
    Section 1: Basic Token Registration
      ΓêÜ should register new device token successfully (1601 ms)
      ΓêÜ should register token with iOS platform (842 ms)
      ΓêÜ should register token with web platform (847 ms)
      ΓêÜ should register token without platform field (optional) (840 ms)
    Section 2: Token Update and Refresh
      ΓêÜ should update last_seen timestamp for existing token (914 ms)
      ΓêÜ should update platform if changed for existing token (887 ms)
      ΓêÜ should handle multiple tokens for same user (980 ms)
    Section 3: Token Migration Between Users
      ΓêÜ should migrate token when device switches to different user account (937 ms)
      ΓêÜ should handle E11000 error gracefully when token already exists for same user (889 ms)
    Section 4: Validation and Error Handling
      ΓêÜ should return 400 when user_id is missing (749 ms)
      ΓêÜ should return 400 when token is missing (747 ms)
      ΓêÜ should return 400 when both user_id and token are missing (805 ms)
      ΓêÜ should return 400 when request body is empty (741 ms)
      ΓêÜ should return 400 when request body is null (749 ms)
      ΓêÜ should return 500 when database operation fails unexpectedly (747 ms)
      ΓêÜ should handle E11000 error when findOne returns null (edge case) (746 ms)
      ΓêÜ should handle save() error during token migration gracefully (848 ms)
    Section 5: Edge Cases and Data Types
      ΓêÜ should handle very long token strings (849 ms)
      ΓêÜ should handle special characters in user_id (837 ms)
      ΓêÜ should handle numeric user_id (converted to string) (837 ms)
      ΓêÜ should handle empty string platform (857 ms)
      ΓêÜ should handle whitespace-only user_id (837 ms)
      ΓêÜ should handle token with newlines and special characters (874 ms)
    Section 6: Concurrent Token Operations
      ΓêÜ should handle multiple concurrent registrations for same token (847 ms)
      ΓêÜ should handle concurrent registrations with different tokens (849 ms)
    Section 7: Different User Types
      ΓêÜ should register token for client user (903 ms)
      ΓêÜ should register token for seller user (834 ms)
      ΓêÜ should register token for delivery agent (837 ms)
      ΓêÜ should register token for admin user (887 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/admin_phase8_payouts.test.js (26.493 s)
  PHASE 8: Payout Management
    Payout Calculations
      ΓêÜ should calculate seller payout with platform commission (2014 ms)
      ΓêÜ should calculate agent payout with delivery fees (1342 ms)
      ΓêÜ should handle bulk payout calculations (1548 ms)
      ΓêÜ should filter payouts by date range (1304 ms)
    Payout Approval Workflow
      ΓêÜ should list unpaid earnings logs (1463 ms)
      ΓêÜ should mark payout as paid (1079 ms)
      ΓêÜ should mark payout as unpaid (954 ms)
      ΓêÜ should filter payout logs by seller (1286 ms)
      ΓêÜ should filter payout logs by agent (1277 ms)
    Payout Error Handling
      ΓêÜ should reject invalid payout log ID (856 ms)
      ΓêÜ should return 404 for non-existent payout log (911 ms)
      ΓêÜ should handle empty payout logs gracefully (918 ms)
      ΓêÜ should handle invalid date formats in filters (945 ms)
      ΓêÜ should require admin authentication for payouts (954 ms)
      ΓêÜ should handle pagination for large payout logs (1320 ms)
      ΓêÜ should handle zero commission rate (1290 ms)
      ΓêÜ should enrich payout logs with order context (1269 ms)
    Aggregate Payouts (GET /api/admin/payouts)
      ΓêÜ should aggregate payouts by seller (1267 ms)
      ΓêÜ should handle pagination in aggregate payouts (921 ms)
      ΓêÜ should search payouts by seller ID (1164 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/couponValidation.test.js (24.133 s)
  Phase 18: Coupon Validation Middleware
    Section 1: Basic Setup
      ΓêÜ should allow request without coupon code (skip validation) (1563 ms)
      ΓêÜ should return 400 when no coupons exist in platform settings (938 ms)
    Section 2: Invalid/Inactive Codes
      ΓêÜ should return 400 for non-existent coupon code (890 ms)
      ΓêÜ should return 400 for inactive coupon (948 ms)
      ΓêÜ should handle uppercase/lowercase coupon codes (880 ms)
      ΓêÜ should handle error when PlatformSettings.findOne fails (836 ms)
    Section 3: Date Validation
      ΓêÜ should return 400 for coupon not yet valid (879 ms)
      ΓêÜ should return 400 for expired coupon (881 ms)
    Section 4: Usage Limits
      ΓêÜ should return 400 when total usage limit reached (958 ms)
      ΓêÜ should return 400 when per-user usage limit reached (979 ms)
      ΓêÜ should allow user below per-user limit (975 ms)
      ΓêÜ should allow coupon without usage limits (976 ms)
    Section 5: Amount/Category Rules
      ΓêÜ should return 400 when subtotal below minimum (881 ms)
      ΓêÜ should return 400 for invalid category (882 ms)
      ΓêÜ should allow valid category (929 ms)
    Section 6: Successful Validation
      ΓêÜ should successfully validate coupon with all checks passed (884 ms)
      ΓêÜ should calculate discount correctly with different percentages (976 ms)
      ΓêÜ should round discount to 2 decimal places (893 ms)
    Section 7: updateCouponUsage Function
      ΓêÜ should increment total usage count for first-time user (1032 ms)
      ΓêÜ should increment user-specific count for returning user (1065 ms)
      ΓêÜ should handle no coupon code provided (955 ms)
      ΓêÜ should handle non-existent coupon code gracefully (882 ms)
      ΓêÜ should handle missing PlatformSettings gracefully (932 ms)
      ΓêÜ should handle database save error gracefully (949 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÜá∩╕Å LOW AVAILABILITY MODE: Order 692db6c0c5c5cb134402bc37 assigned to available agent Agent 1 (0.14 km away) - ignoring distance due to low agent count

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÜá∩╕Å LOW AVAILABILITY MODE: Order 692db6c2c5c5cb134402bc70 assigned to available agent Agent 2 (0.42 km away) - ignoring distance due to low agent count

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÜá∩╕Å LOW AVAILABILITY MODE: Order 692db6c3c5c5cb134402bca6 assigned to agent Agent 2 (least assigned, no location data)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÜá∩╕Å LOW AVAILABILITY MODE: Order 692db6c5c5c5cb134402bcd6 assigned to agent Agent 1 (least assigned, no store location)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÜá∩╕Å LOW AVAILABILITY MODE: Order 692db6c6c5c5cb134402bd05 assigned to available agent Agent 2 (0.42 km away) - ignoring distance due to low agent count

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/phase25_11_seller_medium.test.js (23.833 s)
  Phase 25.11: Seller.js Medium Effort Coverage
    Agent Capacity & Nearest Assignment Logic
      ΓêÜ 11.1: should assign to nearest agent when multiple available (lines 495-520) (2766 ms)
      ΓêÜ 11.2: should filter agents by capacity - max 3 concurrent deliveries (lines 472-485) (1511 ms)
      ΓêÜ 11.3: should fallback to least assigned agent when no location data (lines 515-531) (1592 ms)
      ΓêÜ 11.4: should fallback when no store location available (lines 451-459, 541-544) (1603 ms)
      ΓêÜ 11.5: should handle agent with partial location data (lines 497-505) (1486 ms)
      ΓêÜ 11.6: should handle order rejection when no agents available (lines 553, 559) (1383 ms)
    POST /:sellerId/feedback - Feedback Submission
      ΓêÜ 11.7: should reject feedback with invalid seller ID (lines 828-830) (539 ms)
      ΓêÜ 11.8: should reject feedback with empty message (lines 831-834) (521 ms)
      ΓêÜ 11.9: should handle feedback creation database error (lines 845-846) (544 ms)
      ΓêÜ 11.10: should successfully create feedback (validate success path) (569 ms)
    GET /:sellerId/feedback - Feedback Retrieval
      ΓêÜ 11.11: should handle feedback retrieval database error (lines 870-871) (596 ms)
    GET /:sellerId/earnings/summary - Earnings Summary
      ΓêÜ 11.12: should reject invalid seller ID (lines 883-885) (530 ms)
      ΓêÜ 11.13: should handle earnings summary aggregation error (lines 890-892) (587 ms)
      ΓêÜ 11.14: should return earnings summary successfully (678 ms)
    GET /:sellerId/earnings/logs - Earnings Logs
      ΓêÜ 11.15: should reject invalid seller ID (lines 995-997) (530 ms)
      ΓêÜ 11.16: should handle earnings logs query error (lines 1016-1017) (582 ms)
      ΓêÜ 11.17: should return earnings logs with pagination (631 ms)
    GET /analytics/stream - Analytics SSE Stream
      ΓêÜ 11.18: should reject streaming without seller ID (lines 1737-1739) (529 ms)
      ΓêÜ 11.19: should handle analytics streaming aggregation error (lines 1800-1803) (527 ms)
      ΓêÜ 11.20: should establish SSE connection and send initial event (527 ms)
    Generic Error Handlers
      ΓêÜ 11.21: should handle toggle-open database error (lines 50-51) (528 ms)
      ΓêÜ 11.22: should handle orders list aggregation error (lines 248-249) (541 ms)
      ΓêÜ 11.23: should handle order detail query error (lines 328, 337) (529 ms)
      ΓêÜ 11.24: should handle SSE stream setup error (lines 383-385) (531 ms)
    Order Rejection Event Publishing
      ΓêÜ 11.25: should handle order rejection with SSE publish errors (lines 662) (583 ms)
      ΓêÜ 11.26: should handle generic rejection error (lines 672-673) (581 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/middleware/couponValidation.test.js (24.178 s)
  Coupon Validation Middleware - Complete Coverage
    Γ£à Happy Path - Valid Coupon Application
      ΓêÜ should apply valid coupon with correct discount (1804 ms)
      ΓêÜ should handle case-insensitive coupon codes (1096 ms)
      ΓêÜ should work when no coupon is provided (1038 ms)
    Γ¥î Error Handling - Invalid Coupons
      ΓêÜ should reject non-existent coupon code (1121 ms)
      ΓêÜ should reject expired coupon (1031 ms)
      ΓêÜ should reject coupon that hasn't started yet (1033 ms)
      ΓêÜ should reject inactive coupon (1034 ms)
    ≡ƒôÅ Business Rules - Minimum Subtotal
      ΓêÜ should apply coupon when minimum subtotal is met (1043 ms)
      ΓêÜ should NOT apply coupon when minimum subtotal is not met (1046 ms)
    ≡ƒÅ╖∩╕Å Category Restrictions
      ΓêÜ should apply category-specific coupon to matching category (1106 ms)
      ΓêÜ should NOT apply coupon to wrong category (1036 ms)
    ≡ƒöó Usage Limits
      ΓêÜ should reject coupon that has reached max total usage (1033 ms)
    ΓÜá∩╕Å Edge Cases
      ΓêÜ should handle empty coupon string (1036 ms)
      ΓêÜ should handle whitespace in coupon code (1036 ms)
      ΓêÜ should handle null coupon (1036 ms)
      ΓêÜ should handle cart with subtotal of exactly zero (1036 ms)
    ≡ƒöÆ Security Tests
      ΓêÜ should prevent coupon code injection attempts (1041 ms)
      ΓêÜ should handle extremely long coupon codes (1128 ms)
      ΓêÜ should handle special characters in coupon code (1033 ms)
    ΓÜí Performance Tests
      ΓêÜ should handle coupon validation within acceptable time (1034 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒôí observe env with Radar: https://dotenvx.com/radar

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/admin_phase8_fraud.test.js (22.682 s)
  PHASE 8: Fraud Detection & Alerts
    Fraud Signals (GET /api/admin/fraud/signals)
      ΓêÜ should detect rapid fire orders (3+ orders within 10 minutes) (1866 ms)
      ΓêÜ should detect high COD amount orders (>2000) (945 ms)
      ΓêÜ should detect high refund rate (>40% refunded) (1138 ms)
      ΓêÜ should filter signals by date range (1088 ms)
      ΓêÜ should return empty signals when no fraud detected (940 ms)
      ΓêÜ should require admin authentication (802 ms)
    Alert Evaluation (POST /api/admin/alerts/evaluate)
      ΓêÜ should generate revenue drop alert when revenue drops >40% (1437 ms)
      ΓêÜ should generate high refund ratio alert (>30%) (1504 ms)
      ΓêÜ should not create duplicate alerts for same issue (1268 ms)
      ΓêÜ should skip alert generation when revenue is stable (1165 ms)
      ΓêÜ should require admin authentication (796 ms)
    Alert Listing (GET /api/admin/alerts)
      ΓêÜ should list all alerts with pagination (1073 ms)
      ΓêÜ should filter unacknowledged alerts (991 ms)
      ΓêÜ should return empty list when no alerts exist (838 ms)
      ΓêÜ should require admin authentication (789 ms)
    Alert Acknowledgment (POST /api/admin/alerts/:id/ack)
      ΓêÜ should acknowledge alert successfully (1073 ms)
      ΓêÜ should return 404 for non-existent alert (990 ms)
      ΓêÜ should return 400 for invalid alert ID (791 ms)
      ΓêÜ should require admin authentication (842 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒôí auto-backup env with Radar: https://dotenvx.com/radar

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/middleware/verifyFirebaseToken.test.js (23.205 s)
  Firebase Token Verification Middleware - Complete Coverage
    Γ£à Valid Token Authentication
      ΓêÜ should verify valid Firebase token and set req.user (1774 ms)
      ΓêÜ should handle token with minimal claims (773 ms)
      ΓêÜ should handle token with extra claims (731 ms)
    Γ¥î Missing or Malformed Tokens
      ΓêÜ should reject request with no Authorization header (730 ms)
      ΓêÜ should reject request with invalid Authorization header format (733 ms)
      ΓêÜ should reject request with Bearer but no token (743 ms)
      ΓêÜ should reject request with only whitespace token (753 ms)
    ΓÅ░ Expired and Revoked Tokens
      ΓêÜ should reject expired token (736 ms)
      ΓêÜ should reject revoked token (756 ms)
      ΓêÜ should reject token with invalid argument (737 ms)
      ΓêÜ should handle generic verification errors (729 ms)
    ≡ƒöº Firebase Admin SDK Status
      ΓêÜ should return 500 when Firebase Admin is not initialized (912 ms)
      ΓêÜ should return 500 when Firebase Admin is undefined (729 ms)
    ≡ƒöô Optional Firebase Token Middleware
      ΓêÜ should continue without user when no token provided (754 ms)
      ΓêÜ should set user when valid token provided (733 ms)
      ΓêÜ should continue without user when invalid token provided (742 ms)
      ΓêÜ should continue when Firebase Admin not initialized (728 ms)
      ΓêÜ should handle malformed optional token gracefully (739 ms)
    ≡ƒöÆ Security Tests
      ΓêÜ should not expose sensitive error details in production (733 ms)
      ΓêÜ should expose error details in development (733 ms)
      ΓêÜ should handle malicious token strings (740 ms)
      ΓêÜ should handle extremely long tokens (738 ms)
    ΓÜá∩╕Å Edge Cases
      ΓêÜ should handle token with Unicode characters (741 ms)
      ΓêÜ should handle case-sensitive Bearer keyword (731 ms)
      ΓêÜ should handle multiple Bearer keywords (728 ms)
      ΓêÜ should handle token with special characters (1066 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.error
    Reset password error: Error: Database find error
        at Object.<anonymous> (C:\Users\asus\Documents\EasyApp\Backend\tests\phase25_10_quick_wins.test.js:571:32)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)

    [0m [90m 234 |[39m   [90m// Only log if it's NOT an expected error[39m
     [90m 235 |[39m   [36mif[39m ([33m![39misExpectedError) {
    [31m[1m>[22m[39m[90m 236 |[39m     originalError[33m.[39mapply(console[33m,[39m args)[33m;[39m
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 237 |[39m   }
     [90m 238 |[39m }[33m;[39m
     [90m 239 |[39m[0m

      at console.apply (tests/setup.js:236:19)
      at error (routes/auth.js:347:13)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/phase25_10_quick_wins.test.js (20.469 s)
  Phase 25.10: Quick Wins Coverage Tests
    Section 1: orders.js - Line 50 (PlatformSettings catch block)
      ΓêÜ 1.1: should handle PlatformSettings query error gracefully (line 50) (2400 ms)
    Section 2: orders.js - Line 106 (EarningLog else block)
      ΓêÜ 2.1: should use computed earnings when EarningLog query fails (line 106) (1494 ms)
    Section 3: orders.js - Lines 120-122 (catch block fallback)
      ΓêÜ 3.1: should use fallback earnings computation in catch block (lines 120-122) (1434 ms)
    Section 4: products.js - Line 366 (Category-free delivery threshold)
      ΓêÜ 4.1: should trigger food delivery charge calculation when food subtotal <= threshold (line 366) (1349 ms)
    Section 5: auth.js - Line 58 (Client signup error in test env)
      ΓêÜ 8.1: should handle client signup database error (line 58) (1267 ms)
    Section 6: auth.js - Lines 124, 143 (Seller signup validation)
      ΓêÜ 9.1: should return 400 for ValidationError on seller signup (line 124) (1215 ms)
      ΓêÜ 9.2: should handle seller signup database error (line 143) (1441 ms)
    Section 7: auth.js - Lines 347-348 (Reset password error)
      ΓêÜ 10.1: should handle reset password database error (lines 347-348) (1345 ms)
    Section 8: auth.js - Lines 381, 396-397 (Logout non-fatal errors)
      ΓêÜ 11.1: should handle revoke refresh tokens failure gracefully (line 381) (1952 ms)
      ΓêÜ 11.2: should handle DeviceToken deletion failure gracefully (lines 396-397) (1553 ms)
    Section 9: auth.js - Lines 515, 517-519 (whoami endpoint empty OR)
      ΓêÜ 12.1: should return 400 when no valid query params provided (line 522) (1279 ms)
      ΓêÜ 12.2: should find user with valid email query (valid flow) (1209 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/users_comprehensive.test.js (19.825 s)
  Users Routes - Comprehensive Tests
    Section 1: Address CRUD Operations
      ΓêÜ 1.1 Should get empty array for user with no addresses (987 ms)
      ΓêÜ 1.2 Should get all addresses for user (sorted by created_at desc) (344 ms)
      ΓêÜ 1.3 Should handle database errors when fetching addresses (182 ms)
      ΓêÜ 1.4 Should create new address for user (293 ms)
      ΓêÜ 1.5 Should create address and unset other defaults when is_default=true (423 ms)
      ΓêÜ 1.6 Should update address by addressId (279 ms)
      ΓêÜ 1.7 Should return 404 when updating non-existent address (226 ms)
      ΓêÜ 1.8 Should delete address by addressId (320 ms)
    Section 2: Default Address Logic
      ΓêÜ 2.1 Should unset other defaults when updating address to is_default=true (425 ms)
      ΓêÜ 2.2 Should not unset self when updating is_default=true on same address (379 ms)
      ΓêÜ 2.3 Should allow multiple non-default addresses (316 ms)
      ΓêÜ 2.4 Should handle database errors during default address update (229 ms)
      ΓêÜ 2.5 Should handle database errors when deleting address (233 ms)
    Section 3: User Profile Operations
      ΓêÜ 3.1 Should get user profile by firebase_uid (274 ms)
      ΓêÜ 3.2 Should return 404 when profile not found (231 ms)
      ΓêÜ 3.3 Should update user profile (upsert) (276 ms)
      ΓêÜ 3.4 Should create new profile when updating non-existent user (upsert) (274 ms)
    Section 5: Order History & Pagination
      ΓêÜ 5.1 Should get paginated order history (default page=1, pageSize=10) (1021 ms)
      ΓêÜ 5.2 Should get second page of orders (1254 ms)
      ΓêÜ 5.3 Should filter orders by payment status (421 ms)
      ΓêÜ 5.4 Should handle database errors when fetching orders (179 ms)
    Section 6: Feedback Submission
      ΓêÜ 6.2 Should create feedback without type (optional) (229 ms)
      ΓêÜ 6.3 Should reject feedback with message < 3 characters (180 ms)
      ΓêÜ 6.4 Should trim whitespace from message (273 ms)
    Phase 21.3: Error Paths & Edge Cases Coverage
      GET /:uid/addresses - Error Handling
        ΓêÜ should handle database error when fetching addresses (180 ms)
        ΓêÜ should handle sort() database error (181 ms)
      POST /:uid/addresses - Advanced Error Handling
        ΓêÜ should handle database error during updateMany (default unset) (181 ms)
        ΓêÜ should handle save() error when creating address (181 ms)
        ΓêÜ should handle validation error from schema (180 ms)
      PUT /:uid/addresses/:addressId - Error Handling
        ΓêÜ should return 404 for non-existent address (252 ms)
        ΓêÜ should handle database error during updateMany (default unset) (276 ms)
        ΓêÜ should handle findOneAndUpdate database error (276 ms)
      DELETE /:uid/addresses/:addressId - Error Handling
        ΓêÜ should return 404 for non-existent address (223 ms)
        ΓêÜ should handle findOneAndDelete database error (274 ms)
      GET /:uid/profile - Error Handling
        ΓêÜ should return 404 for non-existent user (225 ms)
        ΓêÜ should handle database error during findOne (180 ms)
      PUT /:uid/profile - Error Handling
        ΓêÜ should handle findOneAndUpdate database error (183 ms)
        ΓêÜ should handle upsert with validation error (181 ms)
      PUT /:uid/preferences - Error Handling
        ΓêÜ should handle database error during preferences update (180 ms)
        ΓêÜ should handle upsert creation for new user preferences (274 ms)
      GET /:uid/orders - Error Handling
        ΓêÜ should handle database error during find (178 ms)
        ΓêÜ should handle countDocuments database error (223 ms)
        ΓêÜ should handle populate() error (180 ms)
        ΓêÜ should handle invalid pagination parameters gracefully (267 ms)
      POST /:uid/feedback - Error Handling & Validation
        ΓêÜ should return 400 for empty message (181 ms)
        ΓêÜ should return 400 for message with only whitespace (178 ms)
        ΓêÜ should return 400 for message shorter than 3 chars after trim (430 ms)
        ΓêÜ should return 400 when message is missing (180 ms)
        ΓêÜ should handle database error during create (178 ms)
        ΓêÜ should convert non-string message to string (271 ms)
        ΓêÜ should handle type field correctly when provided (271 ms)
        ΓêÜ should omit type field when not provided (273 ms)
      Console Error Coverage - Production Paths
        ΓêÜ should log errors in GET addresses (182 ms)
        ΓêÜ should log errors in POST addresses (180 ms)
        ΓêÜ should log errors in PUT addresses (273 ms)
        ΓêÜ should log errors in DELETE addresses (273 ms)
        ΓêÜ should log errors in GET profile (179 ms)
        ΓêÜ should log errors in PUT profile (180 ms)
        ΓêÜ should log errors in PUT preferences (177 ms)
        ΓêÜ should log errors in GET orders (183 ms)
        ΓêÜ should log errors in POST feedback (180 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [METRICS] Starting metrics fetch...

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [METRICS] Starting metrics fetch...

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [METRICS] Starting metrics fetch...

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [METRICS] Starting metrics fetch...

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [METRICS] Starting metrics fetch...

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [METRICS] Starting metrics fetch...

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/admin_phase8_analytics.test.js (19.38 s)
  PHASE 8 SECTION 4: Advanced Analytics & Reporting
    Reporting Overview (GET /api/admin/reporting/overview)
      ΓêÜ should return revenue overview with metrics and trends (2176 ms)
      ΓêÜ should filter by date range (1211 ms)
      ΓêÜ should exclude cancelled orders from revenue (1305 ms)
      ΓêÜ should return top products ranked by revenue (1541 ms)
      ΓêÜ should return empty data when no orders exist (975 ms)
      ΓêÜ should use default date range (30 days) when not specified (951 ms)
      ΓêÜ should require admin authentication (917 ms)
    Platform Metrics (GET /api/admin/metrics)
      ΓêÜ should return comprehensive platform metrics (1649 ms)
      ΓêÜ should distinguish between clients, sellers, and restaurants (1053 ms)
      ΓêÜ should count restaurants separately from sellers (1154 ms)
      ΓêÜ should calculate total platform commission from earning logs (1106 ms)
      ΓêÜ should calculate total discounts from orders (1152 ms)
      ΓêÜ should return zero values when no data exists (957 ms)
      ΓêÜ should require admin authentication (898 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db75c71624f31820e7a98 force-reassigned to nearest agent Agent 3 Phase 9P (1.55 km away)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db75d71624f31820e7ac1 force-reassigned to nearest agent Agent 3 Phase 9P (1.55 km away)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db75e71624f31820e7ade force-reassigned to agent Agent 2 Phase 9P (least assigned, no store location)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db75f71624f31820e7afa force-reassigned to agent Agent 1 Phase 9P (least assigned, no location data)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db76071624f31820e7b1a force-reassigned to nearest agent Agent 1 Phase 9P (2.64 km away)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db76171624f31820e7b39 force-reassigned to nearest agent Agent 1 Phase 9P (1.55 km away)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db76271624f31820e7b54 force-reassigned to nearest agent Agent 3 Phase 9P (15.64 km away)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db76871624f31820e7c0c force-reassigned to nearest agent Agent 1 Phase 9P (1.55 km away)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db76971624f31820e7c2c force-reassigned to nearest agent Agent 1 Phase 9P (3.11 km away)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/delivery_phase9_batch_p.test.js (17.923 s)
  Phase 9: Delivery Routes - Batch P (Uncovered Paths)
    Section 1: Reassignment Without Store Location
      ΓêÜ 1.1: Should reassign using pickup_address location when no product seller location (1078 ms)
      ΓêÜ 1.2: Should fallback to delivery_address when no pickup_address location (900 ms)
      ΓêÜ 1.3: Should reassign when no store, pickup, or delivery location available (939 ms)
    Section 2: Agent Selection Without Location Data
      ΓêÜ 2.1: Should select least assigned agent when no agents have current_location (1075 ms)
      ΓêÜ 2.2: Should handle mixed location data (some agents with, some without location) (877 ms)
      ΓêÜ 2.3: Should select nearest agent when multiple agents have location data (1013 ms)
      ΓêÜ 2.4: Should handle all available agents already tried (no agents left) (792 ms)
    Section 3: OTP Verification Edge Cases
      ΓêÜ 3.1: Should return 400 when OTP parameter is missing (166 ms)
      ΓêÜ 3.2: Should return 404 when order does not exist (52 ms)
      ΓêÜ 3.3: Should return 400 when no OTP code generated for order (151 ms)
      ΓêÜ 3.4: Should return 400 when OTP does not match (148 ms)
      ΓêÜ 3.5: Should verify OTP successfully and update order (551 ms)
      ΓêÜ 3.6: Should handle SSE publish during OTP verification (505 ms)
    Section 4: Multi-Seller Commission Calculations
      ΓêÜ 4.1: Should calculate commission correctly for multi-seller order (513 ms)
      ΓêÜ 4.2: Should handle commission when product_id missing in order_items (468 ms)
      ΓêÜ 4.3: Should handle commission when products not found in database (471 ms)
      ΓêÜ 4.4: Should handle commission with zero price_snapshot (508 ms)
      ΓêÜ 4.5: Should handle commission with missing qty (514 ms)
      ΓêÜ 4.6: Should handle commission calculation rounding correctly (620 ms)
    Section 5: Distance Calculation Edge Cases
      ΓêÜ 5.1: Should handle distance calculation with invalid coordinates (930 ms)
      ΓêÜ 5.2: Should prioritize agents with location over agents without location (1015 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Accept order: seller with no location/place_id handled gracefully

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Accept order: place_id geocoding error handled with fallback

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Accept order: reverseGeocode error handled with coordinate fallback

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Accept order: idempotent accept (already accepted, returns 200)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Accept order: agent with active delivery correctly rejected

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Accept order: place_id takes precedence over location

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Update status: COD payment handled, EarningLog created with COD flag

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Update status: Online payment handled, EarningLog created with COD=false

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Update status: OTP required validation enforced

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Update status: Multiple products commission calculated correctly

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Update status: Invalid status transition rejected

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Reject order: No reassignment when only 1 agent available

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Reject order: Reassigned to nearest available agent

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Reject order: Marked pending when all agents at capacity

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Reject order: Seller location error handled gracefully

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Generate OTP: Successfully generated even without client

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Generate OTP: Idempotent (returned existing OTP)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Generate OTP: Phone number normalized for SMS

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/delivery_phase_21_7.test.js (18.184 s)
  Phase 21.7: Delivery.js Advanced Branch Coverage
    Priority 1: Accept Order Complex Branches
      ΓêÜ Lines 1044-1050: should handle seller with no location or place_id (2240 ms)
      ΓêÜ Lines 1086-1095: should fallback when seller place_id geocoding fails (971 ms)
      ΓêÜ Lines 1100-1115: should fallback when seller location reverseGeocode fails (1000 ms)
      ΓêÜ Lines 1120-1139: should reject idempotent accept (already on_the_way) (522 ms)
      ΓêÜ Lines 1044-1050: should reject accept when agent has active delivery (621 ms)
      ΓêÜ Lines 1086-1095: should prioritize place_id over location when both exist (931 ms)
    Priority 1: Update Status Payment Branches
      ΓêÜ Lines 1358-1372: should handle delivered status with COD payment (1016 ms)
      ΓêÜ Lines 1372-1386: should handle delivered status with online payment (razorpay) (935 ms)
      ΓêÜ Lines 1386-1396: should reject delivered status when OTP required but missing (481 ms)
      ΓêÜ Lines 1358-1396: should calculate commission with multiple products (988 ms)
      ΓêÜ Lines 1317-1335: should reject invalid status transition (484 ms)
    Priority 1: Reject Order Reassignment Branches
      ΓêÜ Lines 1210-1225: should handle reject when only 1 agent available (no reassignment) (844 ms)
      ΓêÜ Lines 1230-1248: should reassign to nearest agent after rejection (933 ms)
      ΓêÜ Lines 1248-1260: should mark pending when all agents at capacity (1050 ms)
      ΓêÜ Lines 1260-1270: should handle seller location error during reassignment (934 ms)
    Priority 1: Generate OTP Edge Cases
      ΓêÜ Lines 2020-2030: should reject OTP generation for order without client (697 ms)
      ΓêÜ Lines 2030-2045: should be idempotent (return existing OTP) (470 ms)
      ΓêÜ Lines 2045-2070: should normalize phone number for SMS (699 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [upsertClient] claiming legacy phone record _id=692db785c908e79c6f898e55 for uid=test_uid_013

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [upsertClient] reassigning orphan phone record from uid=orphan_uid to uid=test_uid_014

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/clients.test.js (16.189 s)
  Clients - Integration Tests
    POST /api/clients/upsert - Upsert Client
      ΓêÜ should create new client with minimal fields (1443 ms)
      ΓêÜ should create client with phone (433 ms)
      ΓêÜ should create client with first_name (354 ms)
      ΓêÜ should reject request without firebase_uid (170 ms)
      ΓêÜ should reject new client without identity fields (216 ms)
      ΓêÜ should update existing client (664 ms)
      ΓêÜ should reject if firebase_uid belongs to admin (406 ms)
      ΓêÜ should reject if firebase_uid belongs to seller (573 ms)
      ΓêÜ should reject duplicate phone (521 ms)
      ΓêÜ should parse and save valid dob (361 ms)
      ΓêÜ should skip invalid dob (346 ms)
      ΓêÜ should construct name from first_name and last_name (342 ms)
      ΓêÜ should set default name to Anonymous if no name provided (384 ms)
      ΓêÜ should mark profile_completed when all required fields present (386 ms)
      ΓêÜ should handle phone claim when ALLOW_PHONE_CLAIM=1 and legacy record exists (518 ms)
      ΓêÜ should handle orphan phone record reassignment (512 ms)
      ΓêÜ should handle database error gracefully (300 ms)
      ΓêÜ should handle E11000 phone duplicate error (338 ms)
      ΓêÜ should handle legacy email index E11000 gracefully (253 ms)
      ΓêÜ should log update payload when DEBUG_UPSERT=1 (342 ms)
      ΓêÜ should handle email index drop migration (339 ms)
    POST /api/clients/complete-profile - Complete Profile
      ΓêÜ should complete profile with required fields (177 ms)
      ΓêÜ should complete profile with last_name (176 ms)
      ΓêÜ should complete profile with valid dob (177 ms)
      ΓêÜ should reject without firebase_uid (131 ms)
      ΓêÜ should reject without first_name (130 ms)
      ΓêÜ should reject without phone (130 ms)
      ΓêÜ should reject invalid dob (127 ms)
      ΓêÜ should upsert if client does not exist (221 ms)
      ΓêÜ should update existing client profile (222 ms)
      ΓêÜ should handle database error gracefully (131 ms)
      ΓêÜ should construct name without last_name (177 ms)
    GET /api/clients/:uid - Get Client Profile
      ΓêÜ should get existing client profile (218 ms)
      ΓêÜ should return 400 without uid (132 ms)
      ΓêÜ should return 404 for non-existent client (169 ms)
      ΓêÜ should handle database error gracefully (128 ms)
    PUT /api/clients/:uid - Update Client Profile
      ΓêÜ should update client name (223 ms)
      ΓêÜ should update client phone (222 ms)
      ΓêÜ should update client avatar_url (219 ms)
      ΓêÜ should update multiple fields (219 ms)
      ΓêÜ should return 400 without uid (131 ms)
      ΓêÜ should upsert if client does not exist (263 ms)
      ΓêÜ should handle empty update object (218 ms)
      ΓêÜ should ignore email field (218 ms)
      ΓêÜ should handle database error gracefully (130 ms)
      ΓêÜ should handle upsert fallback when client not found (217 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db79748f821c92ef1297e reassigned to agent Backup Agent (least assigned, no store location)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/integration/end-to-end-order.test.js (15.917 s)
  End-to-End Order Flow - Integration Tests
    Complete Order Lifecycle - Happy Path
      ΓêÜ should complete full order flow from creation to delivery (6556 ms)
    Multi-Seller Order Flow
      ΓêÜ should handle order with products from multiple sellers (1303 ms)
    Order Rejection & Retry Flow
      ΓêÜ should handle agent rejection and reassignment (3040 ms)
    Stock Management During Order Flow
      ΓêÜ should handle concurrent orders for limited stock (1433 ms)
    Payment Calculation Accuracy
      ΓêÜ should calculate order totals correctly with all fees (1190 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/uploads_comprehensive.test.js (13.938 s)
  Image Upload System - Comprehensive Tests
    Section 1: Image Upload (Valid Formats)
      ΓêÜ 1.1: should upload JPEG image successfully (1004 ms)
      ΓêÜ 1.2: should upload PNG image successfully (512 ms)
      ΓêÜ 1.3: should upload WebP image successfully (367 ms)
      ΓêÜ 1.4: should handle image with special characters in filename (369 ms)
    Section 2: Image Format Validation
      ΓêÜ 2.1: should reject non-image file (PDF) (143 ms)
      ΓêÜ 2.2: should reject non-image file (text) (51 ms)
      ΓêÜ 2.3: should reject GIF format (not in allowed list) (54 ms)
      ΓêÜ 2.4: should return 500 if no file provided (56 ms)
      ΓêÜ 2.5: should accept image/jpg mimetype (alias for jpeg) (277 ms)
    Section 3: File Size Limits
      ΓêÜ 3.1: should accept file within size limit (389 ms)
      ΓêÜ 3.2: should reject file exceeding size limit (>5MB) (170 ms)
    Section 4: Image Optimization
      ΓêÜ 4.1: should optimize image and return optimized flag (531 ms)
      ΓêÜ 4.2: should continue with original if optimization fails (374 ms)
    Section 5: GridFS Storage
      ΓêÜ 5.1: should store image in GridFS uploads bucket (412 ms)
      ΓêÜ 5.2: should generate unique filename with timestamp (523 ms)
      ΓêÜ 5.3: should store chunks in GridFS for uploaded file (508 ms)
    Section 6: Image Download
      ΓêÜ 6.1: should download uploaded image successfully (463 ms)
      ΓêÜ 6.2: should return 404 for non-existent image (424 ms)
      ΓêÜ 6.3: should return 400 for invalid ObjectId format (373 ms)
      ΓêÜ 6.4: should handle very short invalid id (382 ms)
      ΓêÜ 6.5: should handle special characters in id (418 ms)
    Section 7: CDN Headers & Caching
      ΓêÜ 7.1: should set proper cache-control headers (461 ms)
      ΓêÜ 7.2: should set CORS headers (Access-Control-Allow-Origin) (456 ms)
      ΓêÜ 7.3: should set correct Content-Type header (461 ms)
      ΓêÜ 7.4: should generate CDN URL in upload response (510 ms)
    Section 8: Error Handling
      ΓêÜ 8.1: should handle GridFS upload error gracefully (458 ms)
      ΓêÜ 8.2: should handle missing file field gracefully (150 ms)
      ΓêÜ 8.3: should handle empty file buffer (242 ms)
      ΓêÜ 8.4: should handle corrupted image data (387 ms)
      ΓêÜ 8.5: should handle very long filename (367 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/seller_comprehensive_phase21.test.js (13.648 s)
  Seller Routes - Phase 21.4: Error Paths & Edge Cases
    POST /api/seller/toggle-open - Error Handling
      ΓêÜ should handle database error when updating seller (1586 ms)
    POST /api/seller/products - Error Handling
      ΓêÜ should handle database error during product creation (465 ms)
    PUT /api/seller/products/:id - Error Handling
      ΓêÜ should handle database error during product update (541 ms)
    PATCH /api/seller/products/:id - Error Handling
      ΓêÜ should handle database error during product patch (446 ms)
    DELETE /api/seller/products/:id - Error Handling
      ΓêÜ should handle database error during soft delete (458 ms)
      ΓêÜ should handle database error during permanent delete (450 ms)
    GET /api/seller/products - Error Handling
      ΓêÜ should handle database error when listing products (588 ms)
    GET /api/seller/orders - Error Handling
      ΓêÜ should handle database error during order aggregation (448 ms)
    GET /api/seller/orders/pending - Error Handling
      ΓêÜ should handle database error during pending orders aggregation (447 ms)
    GET /api/seller/orders/:id - Error Handling
      ΓêÜ should return 400 for invalid order ID (440 ms)
      ΓêÜ should return 404 for non-existent order (763 ms)
      ΓêÜ should return 403 when order has no items (597 ms)
      ΓêÜ should return 403 when order does not include seller items (967 ms)
      ΓêÜ should handle database error when fetching order (442 ms)
    POST /api/seller/orders/accept - Error Handling
      ΓêÜ should return 400 for invalid order ID (449 ms)
      ΓêÜ should return 404 for non-existent order (486 ms)
      ΓêÜ should return 403 when order does not include seller items (1061 ms)
      ΓêÜ should handle database error during order acceptance (634 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 1 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Order 692db7bd879c4f62ce797a4d marked as pending (no agents available after timeout)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ░ Found 0 timed-out orders to reassign

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 2 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 1 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry: Order 692db7bd879c4f62ce797a6a assigned to agent Test Agent (attempt 1/10)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ│ Order 692db7bd879c4f62ce797a4d - no agents available for retry (1 agents have capacity but tried within last 5 min)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry complete: 1 assigned, 0 escalated, 1 skipped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 2 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 1 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry: Order 692db7be879c4f62ce797a84 assigned to agent Test Agent (attempt 1/10)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ│ Order 692db7bd879c4f62ce797a4d - no agents available for retry (1 agents have capacity but tried within last 5 min)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry complete: 1 assigned, 0 escalated, 1 skipped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Order 692db7c4879c4f62ce797b24 force-reassigned to nearest agent Test Agent (0.00 km away)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/phase25_11_delivery_medium.test.js (12.61 s)
  Phase 25.11: Delivery.js Medium Effort Coverage
    POST /check-timeouts - Timeout Handling
      ΓêÜ 12.1: should detect and process timed-out offers (lines 2513-2550) (391 ms)
      ΓêÜ 12.2: should handle timeout check with no timed-out orders (lines 2600-2650) (155 ms)
      ΓêÜ 12.3: should handle timeout check database error (lines 2700-2708) (8 ms)
    POST /retry-pending-orders - Retry Mechanism
      ΓêÜ 12.4: should retry failed assignments for unassigned orders (lines 2709-2750) (796 ms)
      ΓêÜ 12.5: should skip recently created orders in retry (lines 2760-2780) (827 ms)
      ΓêÜ 12.6: should handle retry mechanism database error (lines 2890-2900) (7 ms)
    POST /:agentId/route/optimize - Route Optimization
      ΓêÜ 12.7: should optimize delivery route for multiple orders (lines 2220-2280) (309 ms)
      ΓêÜ 12.8: should return empty route for agent with no orders (lines 2350-2360) (303 ms)
      ΓêÜ 12.9: should handle route optimization error (lines 2415-2424) (6 ms)
      ΓêÜ 12.10: should use cached route when available (lines 2240-2250) (285 ms)
    Earning Calculations - Edge Cases
      ΓêÜ 12.11: should calculate earning with admin-paid compensation (lines 65-70) (967 ms)
      ΓêÜ 12.12: should handle zero delivery charge earning (lines 76-80) (906 ms)
      ΓêÜ 12.13: should calculate earning with platform share rate (lines 78-84) (872 ms)
      ΓêÜ 12.14: should handle PlatformSettings query error in earning calculation (lines 82-85) (828 ms)
    GET /:agentId/earnings/breakdown - Earnings Breakdown
      ΓêÜ 12.15: should return earnings breakdown with time period (lines 2103-2160) (302 ms)
      ΓêÜ 12.16: should handle invalid time period in breakdown (lines 2150-2160) (21 ms)
      ΓêÜ 12.17: should handle earnings breakdown database error (lines 2210-2220) (6 ms)
    POST /force-reassign/:orderId - Force Reassignment
      ΓêÜ 12.18: should require admin authentication (lines 1239-1245) (102 ms)
      ΓêÜ 12.19: should force reassign order with admin token (lines 1239-1330) (1029 ms)
      ΓêÜ 12.20: should handle reassignment to invalid agent (lines 1260-1270) (149 ms)
    GET /profile/:agentId - Agent Profile
      ΓêÜ 12.21: should return agent profile with stats (lines 1996-2030) (54 ms)
      ΓêÜ 12.22: should handle profile for non-existent agent (lines 2020-2030) (49 ms)
      ΓêÜ 12.23: should handle profile database error (lines 2025-2030) (6 ms)
    POST /logout - Agent Logout
      ΓêÜ 12.24: should logout agent and set unavailable (lines 2425-2470) (140 ms)
      ΓêÜ 12.25: should handle logout for non-existent agent (lines 2460-2470) (92 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/cart.test.js (11.357 s)
  Cart - Integration Tests
    GET /api/cart/:uid - Get Cart
      ΓêÜ should return empty cart for new user (1353 ms)
      ΓêÜ should return cart items for existing cart (583 ms)
    PUT /api/cart/:uid - Update Cart
      ΓêÜ should add items to cart (587 ms)
      ΓêÜ should update existing cart (596 ms)
      ΓêÜ should clear cart with empty items array (602 ms)
      ΓêÜ should fail with invalid items format (453 ms)
      ΓêÜ should fail with missing items field (477 ms)
    Cart Item Validation
      ΓêÜ should handle multiple items from different sellers (696 ms)
      ΓêÜ should maintain cart item order (548 ms)
    Cart Calculations
      ΓêÜ should calculate correct cart total (538 ms)
    Cart Persistence
      ΓêÜ cart should persist across sessions (536 ms)
    Phase 22.3: Error Path Coverage
      ΓêÜ should handle database error during GET cart (660 ms)
      ΓêÜ should handle database error during PUT cart (491 ms)
      ΓêÜ should handle findOne lean() chain during GET error (462 ms)
      ΓêÜ should handle findOneAndUpdate lean() chain during PUT error (456 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/delivery_phase25_8c.test.js (11.53 s)
  Phase 25.8C: Delivery Routes Coverage Enhancement
    Section 1: Force-Reassign Error Paths
      ΓêÜ 1.1: Should return 404 when order does not exist (155 ms)
      ΓêÜ 1.2: Should handle force-reassign when no agents are available (1245 ms)
      ΓêÜ 1.3: Should handle force-reassign when order has no product seller location (701 ms)
      ΓêÜ 1.4: Should handle force-reassign with no pickup_address or delivery location (642 ms)
      ΓêÜ 1.5: Should handle force-reassign when all available agents already tried (729 ms)
    Section 2: Geocoding Fallback Tests
      ΓêÜ 2.1: Should use coordinates when geocoding service fails (249 ms)
      ΓêÜ 2.2: Should use placeDetails when available and enabled (407 ms)
      ΓêÜ 2.3: Should fallback to reverseGeocode when place_id lookup fails (243 ms)
      ΓêÜ 2.4: Should use coordinate string when all geocoding methods fail (250 ms)
      ΓêÜ 2.5: Should handle geocoding with invalid coordinates gracefully (402 ms)
    Section 3: Commission Calculation Edge Cases
      ΓêÜ 3.1: Should calculate commission correctly for standard delivery (101 ms)
      ΓêÜ 3.2: Should handle commission when admin_pays_agent is true (150 ms)
      ΓêÜ 3.3: Should handle commission calculation with zero delivery charge (151 ms)
      ΓêÜ 3.4: Should handle commission calculation when PlatformSettings missing (246 ms)
    Section 4: Additional Edge Cases
      ΓêÜ 4.1: Should handle distance calculation with missing coordinates (539 ms)
      ΓêÜ 4.2: Should handle force-reassign when current agent has 0 assigned_orders (966 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.07KB ΓåÆ 0.32KB (saved -362.9%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒô╕ Image optimized: 0.28KB ΓåÆ 0.31KB (saved -12.2%)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/uploads.test.js (10.558 s)
  Image Upload & CDN - Integration Tests
    POST /api/uploads - Upload Image
      ΓêÜ should upload valid JPEG image (1638 ms)
      ΓêÜ should upload valid PNG image (483 ms)
      ΓêÜ should reject file without image (54 ms)
      ΓêÜ should reject unsupported file type (49 ms)
      ΓêÜ should reject oversized files (66 ms)
    GET /api/uploads/:id - Retrieve Image
      ΓêÜ should retrieve uploaded image (441 ms)
      ΓêÜ should return 404 for non-existent file (398 ms)
      ΓêÜ should return 400 for invalid file ID (353 ms)
      ΓêÜ should set cache headers on image response (435 ms)
    CDN URL Generation
      ΓêÜ should generate CDN URL when CDN is enabled (348 ms)
      ΓêÜ should generate local URL when CDN is disabled (347 ms)
    Image Optimization
      ΓêÜ should optimize JPEG images (459 ms)
      ΓêÜ should handle PNG to WebP conversion if supported (606 ms)
    GridFS Storage
      ΓêÜ should store file metadata in GridFS (389 ms)
      ΓêÜ should clean up failed uploads (48 ms)
    CORS Headers
      ΓêÜ should include CORS headers on image responses (436 ms)
    Error Path Coverage
      ΓêÜ should handle image optimization failure gracefully (877 ms)
      ΓêÜ should handle GridFS upload stream error (609 ms)
      ΓêÜ should handle general upload route errors (51 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Assigned orders: seller with no location handled gracefully

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Assigned orders: client with place_id uses placeDetails

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Assigned orders: client location uses reverseGeocode fallback

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Assigned orders: coordinate fallback when geocoding disabled

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Offers: sellers with place_id use placeDetails

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Offers: mixed geocoding strategies handled correctly

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Offers: seller address string fallback works

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Pending orders: mixed client geocoding (place_id vs location)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£ô Pending orders: coordinate fallback when geocoding disabled

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/delivery_phase_21_7_priority2.test.js (10.085 s)
  Phase 21.7 Priority 2: Location & Geocoding Tests
    Priority 2.1: Assigned Orders Geocoding Chains
      ΓêÜ Lines 733-750: should handle seller with no location, place_id, or address (1543 ms)
      ΓêÜ Lines 750-780: should use place_id for client delivery address (695 ms)
      ΓêÜ Lines 780-810: should use reverseGeocode for client location without place_id (674 ms)
      ΓêÜ Lines 810-834: should fallback to coordinate strings when geocoding disabled (666 ms)
    Priority 2.2: Offers Endpoint Geocoding Chains
      ΓêÜ Lines 373-395: should use place_id for seller pickup addresses (1035 ms)
      ΓêÜ Lines 395-416: should handle mixed geocoding strategies (place_id, location, none) (766 ms)
      ΓêÜ Lines 373-416: should fallback to seller address string (655 ms)
    Priority 2.3: Pending Orders Geocoding Fallbacks
      ΓêÜ Lines 206-218: should handle mixed client geocoding (place_id vs location) (673 ms)
      ΓêÜ Lines 220-223: should fallback to coordinate strings when geocoding disabled (617 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒôí observe env with Radar: https://dotenvx.com/radar

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/coupons.test.js (9.549 s)
  Coupons - Integration Tests
    Coupon Application via Quote Endpoint
      ΓêÜ should apply valid percentage coupon correctly (1754 ms)
      ΓêÜ should reject expired coupon (571 ms)
      ΓêÜ should apply coupon only when min subtotal is met (569 ms)
      ΓêÜ should NOT apply coupon when min subtotal is not met (567 ms)
      ΓêÜ should apply category-specific coupon (563 ms)
      ΓêÜ should handle case-insensitive coupon codes (558 ms)
    Admin Coupon Management
      ΓêÜ should list all coupons (512 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/tokens_comprehensive.test.js (6.54 s)
  Device Token Management - Comprehensive Tests
    Section 1: Device Token Registration
      ΓêÜ 1.1: should register new device token successfully (1142 ms)
      ΓêÜ 1.2: should register iOS device token (188 ms)
      ΓêÜ 1.3: should register web device token (155 ms)
    Section 2: Token Refresh & Updates
      ΓêÜ 2.1: should update last_seen timestamp on refresh (350 ms)
      ΓêÜ 2.2: should update platform when refreshing token (203 ms)
      ΓêÜ 2.3: should handle token refresh without platform field (204 ms)
    Section 3: User Account Switching
      ΓêÜ 3.1: should update token when different user registers same token (243 ms)
      ΓêÜ 3.2: should handle multiple registrations from same user-token pair (252 ms)
    Section 4: Upsert Behavior & Edge Cases
      ΓêÜ 4.1: should handle E11000 duplicate key error and recover (203 ms)
      ΓêÜ 4.2: should upsert token successfully on refresh (357 ms)
      ΓêÜ 4.3: should handle concurrent upserts gracefully (166 ms)
    Section 5: Validation & Error Handling
      ΓêÜ 5.1: should return 400 if user_id is missing (51 ms)
      ΓêÜ 5.2: should return 400 if token is missing (49 ms)
      ΓêÜ 5.3: should return 400 if both user_id and token are missing (50 ms)
      ΓêÜ 5.4: should return 400 if request body is empty (48 ms)
      ΓêÜ 5.5: should return 400 if request body is null (49 ms)
      ΓêÜ 5.6: should handle empty string values for user_id (50 ms)
      ΓêÜ 5.7: should handle empty string values for token (49 ms)
      ΓêÜ 5.8: should handle database errors gracefully (500) (54 ms)
      ΓêÜ 5.9: should handle very long token strings (143 ms)
      ΓêÜ 5.10: should handle special characters in token (145 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/auth_phase25_5.test.js (6.449 s)
  Phase 25.5: Authentication Edge Cases
    Section 1: JWT_SECRET Missing Error (Line 23)
      ΓêÜ should throw error when JWT_SECRET is not set during seller login (154 ms)
    Section 2: Seller Validation Error (Line 143)
      ΓêÜ should return 400 for seller signup without required address (52 ms)
    Section 3: Reset Password Edge Cases
      ΓêÜ Line 319-322: should reject reset with invalid user type in token (12 ms)
      ΓêÜ Line 327: should return 404 when user not found during reset (51 ms)
      ΓêÜ Line 332: should reject invalid reset token (186 ms)
      ΓêÜ Lines 347-348: should reject expired reset token (440 ms)
    Section 4: Logout Error Paths
      ΓêÜ Line 381: should handle token revocation failure gracefully (915 ms)
      ΓêÜ Lines 396-397: should handle device token deletion errors gracefully (406 ms)
    Section 5: Seller ID Lookup Edge Cases
      ΓêÜ Line 515: should handle empty OR array in seller lookup (8 ms)
      ΓêÜ Lines 517-519: should match seller by token user email regex (167 ms)
    Section 6: Additional Branch Coverage
      ΓêÜ should handle delivery agent signup with all fields (146 ms)
      ΓêÜ should handle admin signup edge cases (9 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒôí observe env with Radar: https://dotenvx.com/radar

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/phase25_11_orders_medium.test.js (6.487 s)
  Phase 25.11: OrdersController.js Medium Effort Coverage
    POST /api/orders - JWT Authentication Edge Cases
      ΓêÜ 13.1: should fallback to client_id when JWT decode fails (lines 470-510) (86 ms)
      ΓêÜ 13.2: should generate guest client_id when no auth and no client_id (lines 470-510) (6 ms)
      ΓêÜ 13.3: should reject empty string client_id (lines 470-510) (9 ms)
    POST /api/orders - Address Validation Complexity
      ΓêÜ 13.4: should handle invalid delivery_address_id ObjectId format (lines 574-666) (7 ms)
      ΓêÜ 13.5: should use alternative address lookup when ObjectId fails (lines 574-666) (5 ms)
      ΓêÜ 13.6: should construct full_address from structured fields (lines 574-666) (5 ms)
      ΓêÜ 13.7: should accept string delivery_address as fallback (lines 574-666) (4 ms)
      ΓêÜ 13.8: should return 400 when no delivery address provided (lines 574-666) (3 ms)
    POST /api/orders - Product Validation Paths
      ΓêÜ 13.9: should reject order with unavailable product (status=inactive) (line 511) (126 ms)
      ΓêÜ 13.10: should use legacy 'available' field if status missing (line 511) (110 ms)
      ΓêÜ 13.11: should check stock using 'stock_quantity' fallback (line 511) (100 ms)
    POST /api/orders - Error Handling Paths
      ΓêÜ 13.12: should handle buildGroupedOrders database error (line 795) (8 ms)
      ΓêÜ 13.13: should handle assignNearestDeliveryAgent failure (lines 812-814) (8 ms)
      ΓêÜ 13.14: should handle order save error during final save (line 857) (4 ms)
    GET /api/orders/:id/status - getStatus Edge Cases
      ΓêÜ 13.15: should return 500 when buildEnrichedSnapshot fails (lines 972-973) (341 ms)
      ΓêÜ 13.16: should calculate ETA minutes when eta_at in past (lines 987-991) (327 ms)
    POST /api/orders/:id/verify - verifyPayment Scenarios
      ΓêÜ 13.17: should handle assignNearestDeliveryAgent failure during payment verification (line 1027) (107 ms)
      ΓêÜ 13.18: should handle Product.find error during seller notification (line 1057) (106 ms)
    Edge Cases - Haversine & Enrichment
      ΓêÜ 13.19: should handle haversineKm error gracefully (7 ms)
      ΓêÜ 13.20: should handle missing seller during enrichment (lines 856-857) (416 ms)
      ΓêÜ 13.21: should handle missing delivery agent during enrichment (lines 856-857) (325 ms)
      ΓêÜ 13.22: should handle Client.findOne error during admin enrichment (lines 972-973) (327 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/restaurant_manage_comprehensive.test.js (6.25 s)
  Restaurant Management Routes - Comprehensive Tests
    Section 1: requireSeller Middleware
      ΓêÜ 1.1: should require valid sellerId in query (1209 ms)
      ΓêÜ 1.2: should accept sellerId in request body (550 ms)
      ΓêÜ 1.3: should accept sellerId in x-seller-id header (236 ms)
      ΓêÜ 1.4: should return 400 if sellerId is missing (54 ms)
      ΓêÜ 1.5: should return 400 if sellerId is invalid ObjectId (50 ms)
      ΓêÜ 1.6: should return 400 if sellerId is empty string (50 ms)
    Section 2: GET /me - Fetch Restaurant Profile
      ΓêÜ 2.1: should return seller profile with all fields (218 ms)
      ΓêÜ 2.2: should return 404 if seller not found (98 ms)
      ΓêÜ 2.3: should handle database errors gracefully (178 ms)
    Section 3: PUT /me - Update Restaurant Profile
      ΓêÜ 3.1: should update business_name (219 ms)
      ΓêÜ 3.2: should update multiple fields at once (222 ms)
      ΓêÜ 3.3: should ignore non-allowed fields (220 ms)
      ΓêÜ 3.4: should return 404 if seller not found (104 ms)
      ΓêÜ 3.5: should handle database errors gracefully (156 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒôí auto-backup env with Radar: https://dotenvx.com/radar

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database dropped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Test database connection closed

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/cart_comprehensive.test.js
  Cart Routes - Comprehensive Tests
    Section 1: GET Cart Operations
      ΓêÜ 1.1 Should return empty array for non-existent cart (769 ms)
      ΓêÜ 1.2 Should return cart items for existing cart (234 ms)
      ΓêÜ 1.3 Should return empty array if cart has no items (147 ms)
      ΓêÜ 1.4 Should handle database errors gracefully (56 ms)
    Section 2: PUT Cart - Valid Operations
      ΓêÜ 2.1 Should create new cart with items (upsert) (155 ms)
      ΓêÜ 2.2 Should update existing cart (upsert) (200 ms)
      ΓêÜ 2.3 Should filter out items with qty <= 0 (150 ms)
      ΓêÜ 2.4 Should sanitize item fields (convert types, handle missing seller_id) (152 ms)
    Section 3: PUT Cart - Validation & Error Handling
      ΓêÜ 3.1 Should reject non-array items with 400 (57 ms)
      ΓêÜ 3.2 Should reject missing items field with 400 (52 ms)
      ΓêÜ 3.3 Should filter out items without product_id (154 ms)
      ΓêÜ 3.4 Should handle database errors during save (55 ms)

  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 0 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ│ No orders ready for retry (no agents available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 1 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ│ No orders ready for retry (1 in cooldown or no agents available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 1 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ│ Order 692db81f11ee033d31bc1303 - no agents available for retry (1 agents have capacity but tried within last 5 min)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ΓÅ│ No orders ready for retry (1 in cooldown or no agents available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 2 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry: Order 692db81f11ee033d31bc131b assigned to agent Near Agent (attempt 1/10)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry complete: 1 assigned, 0 escalated, 0 skipped

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒöä Found 1 abandoned pending orders to retry

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    ≡ƒôï 2 delivery agents currently available (approved, active, available)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry: Order 692db81f11ee033d31bc1345 assigned to agent Free Agent (attempt 1/10)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Retry complete: 1 assigned, 0 escalated, 0 skipped

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/delivery_phase_21_6.test.js
  Phase 21.6: Delivery.js Branch Coverage Tests
    Phase 21.6: Pending Orders - Branch Coverage
      ΓêÜ Lines 154-174: should derive kinds from product category (vegetables) (442 ms)
      ΓêÜ Lines 158-160: should derive kinds from product category (grocery) (79 ms)
      ΓêÜ Lines 161-163: should derive kinds from product category (food/restaurant) (54 ms)
      ΓêÜ Lines 165-174: should fallback to business_type when kindsSet empty (47 ms)
      ΓêÜ Lines 169-172: should use business_type with 'restaurant' keyword (58 ms)
      ΓêÜ Lines 182-189: should use fallback seller from product when order.seller_id missing (51 ms)
      ΓêÜ Lines 197-223: should use place_id geocoding when available (52 ms)
      ΓêÜ Lines 206-218: should use reverseGeocode when no place_id but has location (50 ms)
      ΓêÜ Lines 220-223: should use coordinate fallback when geocoding disabled (51 ms)
    Phase 21.6: Retry Pending Orders - Branch Coverage
      ΓêÜ Lines 2460-2470: should return early when no pending orders (24 ms)
      ΓêÜ Lines 2480-2490: should return early when no agents available (40 ms)
      ΓêÜ Lines 2600-2608: should skip orders when all agents at capacity (58 ms)
      ΓêÜ Lines 2625-2638: should skip agents within cooldown period (45 ms)
      ΓêÜ Lines 2645-2665: should select nearest agent by distance calculation (64 ms)
      ΓêÜ Lines 2667-2672: should fallback to least-assigned agent when no location (74 ms)

PASS tests/firebase_auth_middleware.test.js
  Firebase Auth Middleware - Comprehensive Security Tests
    Section 1: Valid Token Authentication
      ΓêÜ 1.1 Should authenticate with valid token and set req.user (24 ms)
      ΓêÜ 1.2 Should handle token without email (phone-only user) (8 ms)
      ΓêÜ 1.3 Should handle token with extra spaces after Bearer (7 ms)
      ΓêÜ 1.4 Should set both req.user and req.firebaseUser for backward compatibility (12 ms)
    Section 2: Missing/Invalid Headers
      ΓêÜ 2.1 Should reject request with no Authorization header (9 ms)
      ΓêÜ 2.2 Should reject request with invalid Authorization format (no Bearer) (6 ms)
      ΓêÜ 2.3 Should reject request with Bearer but empty token (5 ms)
      ΓêÜ 2.4 Should reject request with Bearer and only whitespace (7 ms)
      ΓêÜ 2.5 Should reject request with lowercase 'bearer' (6 ms)
    Section 3: Firebase SDK Errors
      ΓêÜ 3.1 Should handle expired token error (23 ms)
      ΓêÜ 3.2 Should handle revoked token error (10 ms)
      ΓêÜ 3.3 Should handle invalid token argument error (5 ms)
      ΓêÜ 3.4 Should handle generic Firebase errors (6 ms)
    Section 4: Firebase Admin SDK Not Initialized
      ΓêÜ 4.1 Should return 500 when Firebase Admin SDK is not initialized (4 ms)
      ΓêÜ 4.2 Should return 500 when Firebase Admin SDK is undefined (4 ms)
    Section 5: Optional Authentication
      ΓêÜ 5.1 Should continue without authentication when no token provided (5 ms)
      ΓêÜ 5.2 Should authenticate when valid token provided (3 ms)
      ΓêÜ 5.3 Should continue without auth when token is invalid (silent fail) (12 ms)
      ΓêÜ 5.4 Should continue when Firebase Admin SDK not initialized (5 ms)
      ΓêÜ 5.5 Should continue when token format is invalid (no Bearer) (4 ms)
      ΓêÜ 5.6 Should continue when Bearer has empty token (edge case) (6 ms)

PASS tests/middleware/cache.test.js
  Cache Middleware - Complete Coverage
    Redis Initialization
      ΓêÜ should initialize Redis client successfully (14 ms)
      ΓêÜ should register error event handler (2 ms)
      ΓêÜ should handle ECONNREFUSED error silently (Redis not running) (2 ms)
      ΓêÜ should log non-ECONNREFUSED errors (2 ms)
      ΓêÜ should handle ready event and set isRedisReady flag (2 ms)
      ΓêÜ should handle end event and reset isRedisReady flag (2 ms)
      ΓêÜ should handle Redis connection failure gracefully (2 ms)
      ΓêÜ should test reconnectStrategy function (8 ms)
    Cache Hit/Miss Logic
      ΓêÜ should return cached data on cache HIT (3 ms)
      ΓêÜ should call next() on cache MISS (cache key not found) (3 ms)
      ΓêÜ should cache response data after controller execution (cache MISS) (3 ms)
      ΓêÜ should use custom keyGenerator if provided (2 ms)
      ΓêÜ should skip caching when Redis is not available (2 ms)
      ΓêÜ should handle cache read errors gracefully (2 ms)
      ΓêÜ should handle cache write errors gracefully (setEx failure) (22 ms)
      ΓêÜ should use custom TTL when specified (2 ms)
    Cache Invalidation
      ΓêÜ should invalidate cache by pattern (3 ms)
      ΓêÜ should handle invalidateCache when no keys match pattern (2 ms)
      ΓêÜ should handle invalidateCache errors gracefully (2 ms)
      ΓêÜ should skip invalidateCache when Redis is not available (2 ms)
    Clear All Cache
      ΓêÜ should clear all cache successfully (1 ms)
      ΓêÜ should handle clearAllCache errors gracefully (1 ms)
      ΓêÜ should skip clearAllCache when Redis is not available (4 ms)
    Close Redis Connection
      ΓêÜ should close Redis connection gracefully (2 ms)
      ΓêÜ should handle closeRedis when client is null (not initialized) (1 ms)
    Helper Functions
      ΓêÜ getRedisClient should return client when ready
      ΓêÜ getRedisClient should return null when not ready (1 ms)
      ΓêÜ isRedisAvailable should return false before initialization (1 ms)
      ΓêÜ isRedisAvailable should return true after successful initialization (1 ms)
    Integration Tests
      ΓêÜ should handle full cache lifecycle: MISS ΓåÆ cache ΓåÆ HIT (1 ms)
      ΓêÜ should handle fallback to req.url when originalUrl is missing (1 ms)
      ΓêÜ should handle concurrent requests with different cache keys (5 ms)

  console.log
    Γ£à Image optimized: test.jpg (0.01KB ΓåÆ 4.88KB)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Image optimized: test1.jpg (0.01KB ΓåÆ 4.88KB)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Image optimized: test2.png (0.01KB ΓåÆ 4.88KB)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Image optimized: test.jpg (0.01KB ΓåÆ 4.88KB)

      at console.originalLog [as log] (tests/setup.js:221:5)

  console.log
    Γ£à Image optimized: test.jpg (0.01KB ΓåÆ 4.88KB)

      at console.originalLog [as log] (tests/setup.js:221:5)

PASS tests/middleware/imageOptimization.test.js
  Image Optimization Middleware Tests
    optimizeImage()
      ΓêÜ should optimize image with default options (JPEG) (14 ms)
      ΓêÜ should optimize image with custom width and height (1 ms)
      ΓêÜ should optimize image with custom quality (2 ms)
      ΓêÜ should optimize image with custom fit option (2 ms)
      ΓêÜ should convert to PNG format (1 ms)
      ΓêÜ should convert to WebP format (1 ms)
      ΓêÜ should default to JPEG for unknown format (2 ms)
      ΓêÜ should handle JPG format (alias for JPEG) (2 ms)
      ΓêÜ should throw error on sharp failure (28 ms)
    generateMultipleSizes()
      ΓêÜ should generate all image sizes (thumbnail, small, medium, large) (4 ms)
      ΓêÜ should generate sizes with correct dimensions (3 ms)
      ΓêÜ should generate sizes in WebP format (1 ms)
      ΓêÜ should throw error if size generation fails (1 ms)
    autoOptimizeMiddleware()
      ΓêÜ should call next if no files uploaded (3 ms)
      ΓêÜ should optimize single image file (8 ms)
      ΓêÜ should optimize multiple image files (4 ms)
      ΓêÜ should skip non-image files (6 ms)
      ΓêÜ should use custom optimization options (3 ms)
      ΓêÜ should continue on optimization error (non-blocking) (2 ms)
    validateImage()
      ΓêÜ should call next if no files uploaded (1 ms)
      ΓêÜ should reject image exceeding file size limit (1 ms)
      ΓêÜ should reject image exceeding max dimensions (1 ms)
      ΓêÜ should reject image below min dimensions (1 ms)
      ΓêÜ should accept valid image dimensions and size (1 ms)
      ΓêÜ should use custom validation options (6 ms)
      ΓêÜ should skip non-image files (3 ms)
      ΓêÜ should validate multiple files (2 ms)
      ΓêÜ should return error on invalid image file (3 ms)
    convertToWebP()
      ΓêÜ should convert image to WebP with default quality (2 ms)
      ΓêÜ should convert image to WebP with custom quality (2 ms)
    IMAGE_QUALITY constants
      ΓêÜ should have correct thumbnail dimensions (1 ms)
      ΓêÜ should have correct small dimensions (2 ms)
      ΓêÜ should have correct medium dimensions (1 ms)
      ΓêÜ should have correct large dimensions (1 ms)

PASS tests/services/pricing.test.js
  Pricing Service Tests
    buildOrderItemsAndTotal - Basic Functionality
      ΓêÜ should calculate total for valid products from database (6 ms)
      ΓêÜ should handle single product order (2 ms)
      ΓêÜ should default quantity to 1 if missing (2 ms)
      ΓêÜ should handle zero or negative quantity by defaulting to 1 (2 ms)
      ΓêÜ should round total to 2 decimal places (2 ms)
    buildOrderItemsAndTotal - Fallback to Client Snapshot
      ΓêÜ should use client snapshot when product not found in DB (6 ms)
      ΓêÜ should throw error if product not in DB and no valid price snapshot (20 ms)
      ΓêÜ should throw error if price snapshot is negative (2 ms)
      ΓêÜ should handle DB unavailability and use fallback (2 ms)
    buildOrderItemsAndTotal - Error Handling
      ΓêÜ should throw error for empty items array (2 ms)
      ΓêÜ should throw error for null items (1 ms)
      ΓêÜ should throw error for undefined items (1 ms)
      ΓêÜ should throw error for non-array items (1 ms)
    buildGroupedOrders - Category Grouping
      ΓêÜ should group grocery and food items separately (5 ms)
      ΓêÜ should classify 'restaurant' category as food (1 ms)
      ΓêÜ should classify 'food' category as food (1 ms)
      ΓêÜ should default unknown categories to grocery (2 ms)
      ΓêÜ should return only non-empty groups (2 ms)
      ΓêÜ should maintain stable order: grocery then food (2 ms)
    buildGroupedOrders - Fallback Handling
      ΓêÜ should use category_snapshot from client for grouping when product not in DB (2 ms)
      ΓêÜ should handle DB errors and use fallback grouping (2 ms)
      ΓêÜ should throw error if product not in DB and no valid price (2 ms)
    buildGroupedOrders - Error Handling
      ΓêÜ should throw error for empty items array (2 ms)
      ΓêÜ should throw error for null items (5 ms)
      ΓêÜ should throw error for undefined items (2 ms)
    buildGroupedOrders - Quantity & Price Handling
      ΓêÜ should handle quantity field variations (qty vs quantity) (2 ms)
      ΓêÜ should round group totals to 2 decimal places (2 ms)
      ΓêÜ should handle mixed products and fallbacks in same group (2 ms)

PASS tests/middleware/cdn.test.js
  CDN Middleware Tests
    setCacheHeaders()
      ΓêÜ should set cache headers for images (1 year) (9 ms)
      ΓêÜ should set cache headers for static assets (30 days) (2 ms)
      ΓêÜ should set no-cache headers for API responses (2 ms)
      ΓêÜ should set no-cache headers for unknown types (1 ms)
      ΓêÜ should default to images type when no type specified (1 ms)
    getCDNUrl()
      ΓêÜ should return empty string for empty path (1 ms)
      ΓêÜ should return path as-is if it has http protocol (1 ms)
      ΓêÜ should return path as-is if it has https protocol (1 ms)
      ΓêÜ should prepend CDN domain when configured (1 ms)
      ΓêÜ should remove leading slash when prepending CDN domain (1 ms)
      ΓêÜ should prepend CDN prefix when configured (no domain) (1 ms)
      ΓêÜ should prefer CDN domain over prefix (1 ms)
      ΓêÜ should return original path when no CDN configured (1 ms)
    optimizeStaticServing()
      ΓêÜ should add compression and CORS headers (1 ms)
      ΓêÜ should add security headers (1 ms)
    transformUrlsToCDN()
      ΓêÜ should transform image URLs in JSON response (1 ms)
      ΓêÜ should transform nested image URLs (1 ms)
      ΓêÜ should transform arrays of objects (1 ms)
      ΓêÜ should handle null and undefined values (2 ms)
      ΓêÜ should not transform non-image fields (5 ms)
    cloudflareOptimizations()
      ΓêÜ should add Cloudflare optimization headers (2 ms)
    imageOptimizationHints()
      ΓêÜ should add image optimization headers without query params (2 ms)
      ΓêÜ should add responsive image hints with width query param (2 ms)
      ΓêÜ should add responsive image hints with height query param (2 ms)
      ΓêÜ should prefer width over default viewport width (1 ms)
    getConfig()
      ΓêÜ should return CDN disabled when no domain or prefix (1 ms)
      ΓêÜ should return CDN enabled when domain is set (1 ms)
      ΓêÜ should return CDN enabled when prefix is set (1 ms)

PASS tests/phase25_13_validation.test.js
  Phase 25.13: Validation Middleware - MongoDB Operator Filtering
    Section 1: MongoDB Operator Key Filtering (line 225)
      ΓêÜ 1.1: should filter MongoDB operators from object keys (3 ms)
      ΓêÜ 1.2: should handle nested MongoDB operators (2 ms)
      ΓêÜ 1.3: should preserve normal keys while filtering operators (2 ms)
      ΓêÜ 1.4: should handle array of objects with MongoDB operators (2 ms)
      ΓêÜ 1.5: should skip keys starting with $ and continue to next key (2 ms)
      ΓêÜ 1.6: should call sanitize middleware with MongoDB operators in req.body (3 ms)

PASS tests/services/geocode.test.js
  Geocoding Service Tests
    Reverse Geocoding
      ΓêÜ should reverse geocode valid coordinates (cache miss) (9 ms)
      ΓêÜ should use cached result for same coordinates (cache hit) (2 ms)
      ΓêÜ should apply coordinate precision (5 decimal places) (2 ms)
      ΓêÜ should return null when Google API returns ZERO_RESULTS (2 ms)
      ΓêÜ should return null when Google API returns error status (2 ms)
      ΓêÜ should handle network errors gracefully (2 ms)
      ΓêÜ should handle invalid JSON response gracefully (2 ms)
    Place Details Lookup
      ΓêÜ should fetch place details for valid place ID (cache miss) (7 ms)
      ΓêÜ should use cached result for same place ID (cache hit) (2 ms)
      ΓêÜ should return null when place ID is missing or empty (2 ms)
      ΓêÜ should return null when API returns no result (3 ms)
      ΓêÜ should properly encode place IDs with special characters (2 ms)
    Configuration & Fallback
      ΓêÜ should expose ENABLED flag based on GEOCODE_SERVER_FALLBACK env var (1 ms)
      ΓêÜ should return valid address when enabled (current state) (1 ms)
      ΓêÜ should handle API errors gracefully (2 ms)
      ΓêÜ should include API key in requests (2 ms)
    Cache Management
      ΓêÜ should enforce 24-hour TTL for reverse geocoding cache (3 ms)
      ΓêÜ should use correct cache key format (lat,lng with 5 decimals) (2 ms)
      ΓêÜ should maintain separate caches for reverse geocoding and place details (6 ms)
      ΓêÜ should handle cache isolation between different coordinates (3 ms)

PASS tests/services/orderEvents.test.js
  Order Events SSE Service - Comprehensive Tests
    Client Management (Order-specific streams)
      ΓêÜ should add client to order stream (6 ms)
      ΓêÜ should handle multiple clients for same order (2 ms)
      ΓêÜ should remove client on close event (3 ms)
      ΓêÜ should remove client on error event (5 ms)
      ΓêÜ should handle concurrent connections for different orders (2 ms)
      ΓêÜ should handle client write failures gracefully (4 ms)
    Order Broadcasting (publish to clients)
      ΓêÜ should broadcast order update to all listening clients (2 ms)
      ΓêÜ should not crash when publishing to non-existent order (2 ms)
      ΓêÜ should broadcast complex payload with nested objects (2 ms)
      ΓêÜ should handle empty payload (2 ms)
      ΓêÜ should handle null payload gracefully (2 ms)
      ΓêÜ should broadcast to admin on every order publish (2 ms)
      ΓêÜ should handle rapid sequential publishes (7 ms)
    Seller Streams (publishToSeller)
      ΓêÜ should add seller to seller stream (3 ms)
      ΓêÜ should publish updates to seller stream (2 ms)
      ΓêÜ should sanitize OTP code from seller payload (2 ms)
      ΓêÜ should handle multiple sellers simultaneously (1 ms)
      ΓêÜ should handle seller stream write failures (1 ms)
    Admin Dashboard Streams
      ΓêÜ should add admin client to global stream (1 ms)
      ΓêÜ should broadcast to all admin clients (1 ms)
      ΓêÜ should remove admin client on close
      ΓêÜ should handle admin stream write failures (2 ms)
    Edge Cases & Error Handling
      ΓêÜ should handle publishing with undefined payload (1 ms)
      ΓêÜ should handle sellerIds as strings and numbers (5 ms)
      ΓêÜ should handle payload sanitization errors gracefully (2 ms)
      ΓêÜ should handle publishing to empty client set (2 ms)
      ΓêÜ should handle publishing to empty seller set (1 ms)
      ΓêÜ should handle publishing to empty admin set (1 ms)
      ΓêÜ should handle payload without delivery field (no OTP) (2 ms)
      ΓêÜ should handle null payload in seller stream (2 ms)

PASS tests/middleware/pagination.test.js
  Pagination Middleware - Complete Coverage
    paginationMiddleware - Request Parsing
      ΓêÜ should apply default pagination (page=1, limit=20) when no query params (6 ms)
      ΓêÜ should parse page and limit from query string (4 ms)
      ΓêÜ should enforce custom defaultLimit and maxLimit options (2 ms)
      ΓêÜ should treat page=0 as page=1 (minimum enforcement) (2 ms)
      ΓêÜ should treat negative page numbers as page=1 (1 ms)
      ΓêÜ should handle non-numeric page/limit gracefully (use defaults) (2 ms)
    paginate - Response Formatting
      ΓêÜ should format paginated response with metadata (page 1 of 3) (1 ms)
      ΓêÜ should format middle page correctly (page 2 of 5) (2 ms)
      ΓêÜ should format last page correctly (no next page) (1 ms)
      ΓêÜ should handle single page result (total < limit) (4 ms)
      ΓêÜ should handle empty result set (total=0) (1 ms)
      ΓêÜ should calculate totalPages correctly with exact division (2 ms)
    getPaginationMeta - Metadata Generation
      ΓêÜ should generate metadata for first page (hasNextPage=true, hasPrevPage=false) (1 ms)
      ΓêÜ should generate metadata for middle page (both next and prev) (1 ms)
      ΓêÜ should generate metadata for last page (hasNextPage=false) (1 ms)
      ΓêÜ should handle single page (no next or prev) (2 ms)
      ΓêÜ should handle edge case with very large page numbers (1 ms)
    Edge Cases & Integration
      ΓêÜ should handle very small limits (limit=1) (1 ms)
      ΓêÜ should handle very large page numbers without overflow (2 ms)

PASS tests/services/upi.test.js
  UPI Service - Stub Tests
    buildUpiLink()
      ΓêÜ should throw error when called (UPI removed) (8 ms)
      ΓêÜ should throw error with any arguments (2 ms)
      ΓêÜ should throw error with multiple arguments (2 ms)
    getUpiEnv()
      ΓêÜ should throw error when called (UPI removed) (2 ms)
      ΓêÜ should throw error with any arguments (2 ms)
    Module Exports
      ΓêÜ should export buildUpiLink function (1 ms)
      ΓêÜ should export getUpiEnv function (1 ms)

-------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File                     | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
-------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All files                |   90.49 |    80.47 |    93.6 |   91.38 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
 controllers             |   87.38 |    73.99 |   87.23 |   88.81 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  clientsController.js   |   98.87 |    93.61 |      75 |   98.78 | 147                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  ordersController.js    |   85.61 |    71.44 |   88.37 |   87.31 | 35,45,68,99-102,131,140-141,404,415,421-425,511,574-666,690,795,812-814,856-857,972-973,987-991,1027,1057,1067,1109-1110,1282,1288-1290,1328-1329,1344-1345                                                                                                                                                                                                                                                                                                                                                                                
 middleware              |   98.62 |    95.61 |     100 |   98.87 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  cache.js               |     100 |    89.28 |     100 |     100 | 12,80,165                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
  cdn.js                 |   98.21 |    97.56 |     100 |   98.18 | 118                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  couponValidation.js    |   98.46 |    95.38 |     100 |   98.38 | 182                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  imageOptimization.js   |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  pagination.js          |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  validation.js          |   95.65 |    86.36 |     100 |   97.67 | 225                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  verifyFirebaseToken.js |   97.56 |    95.83 |     100 |   97.56 | 116                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 routes                  |   90.13 |    80.72 |   92.73 |   90.99 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  admin.js               |   87.97 |    81.35 |   92.48 |   88.92 | 14,70-72,136-138,166-167,198,203,221-222,264-276,307,672-673,677-678,689-690,695-696,701-702,803,907-908,943-944,1042,1069-1074,1117-1118,1152,1163,1311,1350-1351,1379-1380,1438-1441,1453-1458,1483,1499-1511,1526,1555-1565,1623-1624,1720,1727,1756-1758,1879,1933,2001-2002,2034,2069-2070,2131-2132,2163-2164,2273-2275,2300,2423-2424,2506-2507,2555,2557,2559,2561,2563,2579-2580,2622-2623,2669-2675,2710-2711,2723-2724,2748-2749,2776-2777,2822-2826,2842-2843,2867-2868,3184-3185,3241-3245,3261-3262,3370,3379-3401,3511-3512 
  auth.js                |   94.46 |    89.26 |     100 |   95.65 | 58,124,143,381,396-397,515,517-519                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
  cart.js                |     100 |    77.77 |     100 |     100 | 12-23,30-31                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
  clients.js             |   94.59 |    81.25 |     100 |     100 | 17,34-35                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
  delivery.js            |   86.37 |    75.86 |   87.83 |   87.46 | 34,40,75,116,396-399,485-486,527-528,539-542,564-565,573-577,668,756-757,810,820,845,854,875,920-921,1067-1068,1109-1110,1135-1162,1233-1234,1390,1419-1420,1544,1580-1581,1595,1605,1635-1636,1673-1674,1685,1713,1721-1722,1771-1772,1789-1790,1857,1890-1897,1915-1959,1974-1975,1990-1991,2037,2096-2097,2230,2346,2418-2419,2429,2448-2463,2473-2474,2483,2491-2493,2505-2506,2598-2618,2669-2672,2688,2805-2813,2839-2840,2960                                                                                                       
  orders.js              |   98.43 |    80.59 |    87.5 |   98.34 | 50,106                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
  products.js            |   96.05 |    86.79 |   94.11 |   96.92 | 59-60,93-94,423-424                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  restaurant_manage.js   |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  restaurants.js         |   96.15 |     87.5 |     100 |   95.65 | 99-100                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
  reviews.js             |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  seller.js              |   90.61 |    80.84 |   95.16 |   91.43 | 383-385,409,553,662,672-673,817-818,855,890-892,1002-1004,1421-1422,1453,1545-1546,1608-1609,1645-1646,1685,1718-1719,1754-1803,1825-1835,1889-1890,2006-2007,2110-2111                                                                                                                                                                                                                                                                                                                                                                    
  tokens.js              |     100 |    92.85 |     100 |     100 | 9                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  uploads.js             |   96.49 |    71.42 |   83.33 |   96.29 | 56-57                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  users.js               |   94.84 |    82.14 |      90 |   94.79 | 7-12                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  wishlist.js            |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
 services                |    92.2 |    83.15 |     100 |    92.9 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  geocode.js             |   97.82 |    89.65 |     100 |     100 | 3-31                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  orderEvents.js         |   84.09 |       80 |     100 |   83.33 | 71,113-117,122-127,132-135                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
  pricing.js             |     100 |    90.24 |     100 |     100 | 29,101,107,124                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  push.js                |   91.61 |    80.92 |     100 |   92.85 | 88-89,94-96,101,193,309,371-372                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  upi.js                 |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
-------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Summary of all failing tests
FAIL tests/admin_phase25_6.test.js (6.823 s)
  ΓùÅ Phase 25.6: Admin Panel Testing ΓÇ║ Section 1: Reporting & Overview (Lines 307-425) ΓÇ║ GET /api/admin/reporting/overview - should return platform metrics

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1
    Received:    0

    [0m [90m 157 |[39m       expect(response[33m.[39mbody[33m.[39mmetrics)[33m.[39mtoHaveProperty([32m"orderCount"[39m)[33m;[39m
     [90m 158 |[39m       expect(response[33m.[39mbody[33m.[39mmetrics)[33m.[39mtoHaveProperty([32m"averageOrderValue"[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 159 |[39m       expect(response[33m.[39mbody[33m.[39mmetrics[33m.[39morderCount)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m [90m// Should find our test 
order[39m
     [90m     |[39m                                                [31m[1m^[22m[39m
     [90m 160 |[39m     })[33m;[39m
     [90m 161 |[39m
     [90m 162 |[39m     test([32m"GET /api/admin/reporting/overview - should use default date range (30 days)"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.toBeGreaterThanOrEqual (tests/admin_phase25_6.test.js:159:48)

  ΓùÅ Phase 25.6: Admin Panel Testing ΓÇ║ Section 1: Reporting & Overview (Lines 307-425) ΓÇ║ GET /api/admin/reporting/overview - should exclude cancelled orders

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 1
    Received:    0

    [0m [90m 199 |[39m       [90m// Cancelled order should not affect revenue[39m
     [90m 200 |[39m       expect(response[33m.[39mbody[33m.[39mmetrics)[33m.[39mtoHaveProperty([32m"orderCount"[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 201 |[39m       expect(response[33m.[39mbody[33m.[39mmetrics[33m.[39morderCount)[33m.[39mtoBeGreaterThanOrEqual([35m1[39m)[33m;[39m
     [90m     |[39m                                                [31m[1m^[22m[39m
     [90m 202 |[39m     })[33m;[39m
     [90m 203 |[39m
     [90m 204 |[39m     test([32m"GET /api/admin/reporting/overview - should handle database errors"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.toBeGreaterThanOrEqual (tests/admin_phase25_6.test.js:201:48)

FAIL tests/phase25_14_cdn.test.js
  ΓùÅ Phase 25.14: CDN Middleware - Array Transformation ΓÇ║ Section 1: Array Handling (line 118) ΓÇ║ 1.2: should handle array responses from seller products route

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [200, 401, 403, 404, 500]

    [0m [90m 46 |[39m         [33m.[39m[36mset[39m([32m"Accept"[39m[33m,[39m [32m"application/json"[39m)[33m;[39m
     [90m 47 |[39m
    [31m[1m>[22m[39m[90m 48 |[39m       expect([[35m200[39m[33m,[39m [35m401[39m[33m,[39m [35m403[39m[33m,[39m [35m404[39m[33m,[39m 
[35m500[39m])[33m.[39mtoContain(res[33m.[39mstatus)[33m;[39m
     [90m    |[39m                                         [31m[1m^[22m[39m
     [90m 49 |[39m     })[33m;[39m
     [90m 50 |[39m
     [90m 51 |[39m     it([32m"1.3: should handle array responses from orders route"[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.toContain (tests/phase25_14_cdn.test.js:48:41)


Test Suites: 2 failed, 1 skipped, 56 passed, 58 of 59 total
Tests:       3 failed, 38 skipped, 2425 passed, 2466 total
Snapshots:   0 total
Time:        2060.586 s, estimated 2087 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
