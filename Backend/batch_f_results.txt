  console.log
    [dotenv@17.2.2] injecting env (18) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at _log (node_modules/dotenv/lib/main.js:139:11)

  console.log
    [dotenv@17.2.2] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at _log (node_modules/dotenv/lib/main.js:139:11)

  console.log
    Γ£à Connected to MongoDB Atlas test database

      at log (tests/testUtils/dbHandler.js:26:11)

  console.log
    Order 6916019e4fc8853d4c02ae26 reassigned to agent Agent One (least assigned, no store location)

      at log (routes/delivery.js:1148:15)

  console.error
    Invalid or missing agentId: invalid

    [0m [90m 37 |[39m   [90m// Only log if it's NOT an expected error[39m
     [90m 38 |[39m   [36mif[39m ([33m![39misExpectedError) {
    [31m[1m>[22m[39m[90m 39 |[39m     originalError[33m.[39mapply(console[33m,[39m args)[33m;[39m
     [90m    |[39m                   [31m[1m^[22m[39m
     [90m 40 |[39m   }
     [90m 41 |[39m }[33m;[39m
     [90m 42 |[39m[0m

      at console.apply (tests/setup.js:39:19)
      at error (routes/delivery.js:1525:15)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (app.js:221:18)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at urlencodedParser (node_modules/body-parser/lib/types/urlencoded.js:85:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.log
    ΓÜá∩╕Å FORCE OFFLINE: Reassigning 1 active deliveries from agent 691601a24fc8853d4c02aea0

      at log (routes/delivery.js:1580:19)

  console.log
      Γ£ô Order 691601a24fc8853d4c02aea4 reassigned to Agent One

      at log (routes/delivery.js:1628:23)

  console.log
    Γ£à Test database dropped

      at log (tests/testUtils/dbHandler.js:37:15)

  console.log
    Γ£à Test database connection closed

      at log (tests/testUtils/dbHandler.js:41:15)

npx : FAIL tests/delivery.test.js (26.425 s)
At line:1 char:1
+ npx jest tests/delivery.test.js -t "Batch F" --forceExit --maxWorkers ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (FAIL tests/delivery.test.js (26.425 s):String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
  Delivery System - Integration Tests
    Agent Assignment Logic
      Γùï skipped should assign nearest available agent to order
      Γùï skipped should not assign agent who is already on delivery
      Γùï skipped should fail if no agents available within radius
    Agent Order Management
      Γùï skipped agent should be able to accept assigned order
      Γùï skipped agent should be able to reject order
      Γùï skipped agent cannot accept order assigned to another agent
      Γùï skipped agent should update order to picked up
      Γùï skipped agent should complete delivery
    Location Tracking
      Γùï skipped agent should update location in real-time
      Γùï skipped should retrieve agent location for tracking
    Order Timeout & Retry Logic
      Γùï skipped should reassign order if agent doesn't accept within timeout
      Γùï skipped should retry pending orders
    Agent Earnings
      Γùï skipped agent earnings should update after delivery completion
      Γùï skipped should retrieve agent earnings history
    Agent Availability
      Γùï skipped agent should toggle availability status
      Γùï skipped unavailable agent should not receive new assignments
    Delivery Proof & Verification
      Γùï skipped agent should upload delivery proof on completion
      Γùï skipped should reject delivery proof from wrong agent
      Γùï skipped should verify OTP before delivery completion
    Agent Order History & Tracking
      Γùï skipped should retrieve agent's current orders
      Γùï skipped should retrieve agent's completed orders
      Γùï skipped should retrieve agent performance statistics
    Distance & Route Optimization
      Γùï skipped should calculate distance between two locations
      Γùï skipped should get route between agent and delivery location
      Γùï skipped should handle invalid coordinates gracefully
    Payment Collection & Verification
      Γùï skipped agent should mark COD payment as collected
      Γùï skipped should reject payment collection by wrong agent
    Agent Load Balancing
      Γùï skipped should prefer agent with fewer assigned orders
      Γùï skipped should not assign multiple concurrent orders to single agent
    Pending Orders Endpoint
      Γùï skipped should return formatted pending orders for agent
      Γùï skipped should exclude orders already offered to the agent
    Offers Endpoint
      Γùï skipped should return offers for specific agent
    Assigned Orders Endpoint
      Γùï skipped should return assigned orders for agent
    Order History Endpoint
      Γùï skipped should return completed orders for agent
    Reject Order Endpoint
      Γùï skipped should allow agent to reject an order
    Update Status Endpoint
      Γùï skipped should update order delivery status
    Generate OTP Endpoint
      Γùï skipped should generate OTP for order
    Verify OTP Endpoint
      Γùï skipped should verify OTP for order
    Update Location Endpoint
      Γùï skipped should update agent location
    Toggle Availability Endpoint
      Γùï skipped should toggle agent availability
    Agent Profile Endpoint
      Γùï skipped should return agent profile
    Earnings Summary Endpoint
      Γùï skipped should return agent earnings summary
    Earnings Breakdown Endpoint
      Γùï skipped should return earnings breakdown
    Route Optimize Endpoint
      Γùï skipped should optimize delivery route
    Logout Endpoint
      Γùï skipped should logout agent
    Earnings Logs Endpoint
      Γùï skipped should return detailed earnings logs
    Check Timeouts Endpoint
      Γùï skipped should check for timed out orders
    Retry Pending Orders Endpoint
      Γùï skipped should retry pending orders
    Additional Coverage - High-Value Areas
      Γùï skipped should handle earnings breakdown for different periods
      Γùï skipped should retrieve earnings logs with pagination
      Γùï skipped should handle agent profile retrieval
      Γùï skipped should handle missing agent profile gracefully
      Γùï skipped should update agent location
      Γùï skipped should handle invalid location coordinates
      Γùï skipped should logout agent and set inactive
      Γùï skipped should handle pending orders with no available agents
      Γùï skipped should handle retry with truly pending orders
      Γùï skipped should handle orders from different product categories
      Γùï skipped should handle restaurant/food orders
      Γùï skipped should handle agent earnings summary
      Γùï skipped should check timeouts and detect timed out orders
      Γùï skipped should handle order with missing seller location
      Γùï skipped should handle offers endpoint
      Γùï skipped should handle earnings with no completed deliveries
      Γùï skipped should handle concurrent agent assignment attempts
    Retry Logic System
      Γùï skipped should escalate order after max retry attempts exceeded
      Γùï skipped should skip orders in retry cooldown period
      Γùï skipped should avoid recently-tried agents within agent retry cooldown
      Γùï skipped should select nearest untried agent for retry
      Γùï skipped should handle retry when all agents at capacity
      Γùï skipped should use fallback agent selection when no location available
      Γùï skipped should increment assignment_history on each retry
      Γùï skipped should handle multiple pending orders in one retry call
      Γùï skipped should send SSE notification on successful retry assignment
      Γùï skipped should return correct response when no orders need retry
    Timeout Detection & Reassignment System
      Γùï skipped should detect and reassign order when agent timeout exceeded
      Γùï skipped should not reassign order within timeout window
      Γùï skipped should exclude previously-tried agents from reassignment
      Γùï skipped should select nearest available agent for timeout reassignment
      Γùï skipped should mark order as pending when no agents available after timeout
      Γùï skipped should use fallback (least assigned) when no location available
      Γùï skipped should handle multiple timed-out orders in single check
      Γùï skipped should send SSE notification on timeout reassignment
      Γùï skipped should update assignment_history with timeout response
      Γùï skipped should return correct response when no timeouts detected
    Batch C: Offers Endpoint - Order Formatting Logic
      Γùï skipped should return formatted offers for active agent with pending orders
      Γùï skipped should return empty offers for inactive agent
      Γùï skipped should handle offers with geocoding fallback for missing seller address
      Γùï skipped should detect product categories (vegetables) in offers
      Γùï skipped should detect product categories (grocery) in offers
      Γùï skipped should detect product categories (food/restaurant) in offers
      Γùï skipped should use business_type for category detection when products lack categories
      Γùï skipped should exclude offers that agent previously rejected
      Γùï skipped should set hasActiveOrder=true when agent has active delivery
      Γùï skipped should handle offers with missing client address using coordinate fallback
    Batch D: Earnings Breakdown System (Lines 1846-1960)
      Γùï skipped should return daily breakdown with completed deliveries
      Γùï skipped should filter earnings by date range (from/to)
      Γùï skipped should return empty breakdown when agent has no delivered orders
      Γùï skipped should calculate agent earnings with platform share rate (80%)
      Γùï skipped should calculate COD collection totals correctly
      Γùï skipped should handle invalid agentId with 400 error
    Batch E: Error Handling & Edge Cases (Uncovered Lines)
      Γùï skipped should handle check-timeouts with no timed out orders
      Γùï skipped should handle retry-pending-orders with no pending orders
      Γùï skipped should handle timeout reassignment with no agents available
      Γùï skipped should use fallback agent selection for timeout when store location missing
      Γùï skipped should use fallback agent selection for retry when store location missing
      Γùï skipped should filter out agents in cooldown during retry
      Γùï skipped should skip orders in cooldown period during retry
      Γùï skipped should handle seller without address in retry system
      Γùï skipped should use seller business_type for category detection
      Γùï skipped should handle platform settings updates
      Γùï skipped should continue retry assignment even if SSE notification fails
      Γùï skipped should continue timeout reassignment even if SSE publish fails
    Batch F: Complete Remaining Lines Coverage
      ΓêÜ should calculate earnings with admin_pays_agent and admin_agent_payment (1930 ms)
      ΓêÜ should calculate effective delivery charge from order items (966 ms)
      ΓêÜ should use geocoding fallback for offers when seller has place_id (1507 ms)
      ├ù should handle geocoding in current-order endpoint (728 ms)
      ├ù should resolve client by firebase_uid in current-order (730 ms)
      ΓêÜ should handle geocoding fallback in pending-orders (817 ms)
      ΓêÜ should resolve client details in pending-orders (816 ms)
      ΓêÜ should calculate route info in delivery history (859 ms)
      ΓêÜ should handle missing store_location in route_info (844 ms)
      ΓêÜ should handle accept-order idempotency (already accepted) (774 ms)
      ΓêÜ should reject accept-order when agent has active orders (857 ms)
      ΓêÜ should set pickup_address from seller location on accept (1534 ms)
      ├ù should reassign order without store location using least assigned (725 ms)
      ΓêÜ should handle reject-order with agent and order validation (1610 ms)
      ├ù should handle complete delivery with OTP validation (694 ms)
      ΓêÜ should update agent location and broadcast to active orders (781 ms)
      ΓêÜ should validate agentId in toggle-availability (541 ms)
      ΓêÜ should block toggle offline with active deliveries (no forceOffline) (778 ms)
      ΓêÜ should force offline and reassign active deliveries (1063 ms)
      ├ù should reassign pending offers when agent goes offline (814 ms)
      ΓêÜ should toggle agent online and increment assigned_orders (666 ms)
      ├ù should calculate earnings summary with COD and platform payments (775 ms)
      ├ù should fetch earnings logs with pagination (623 ms)
      ├ù should optimize route with order_ids (674 ms)
      ΓêÜ should optimize route with custom points array (632 ms)
      ΓêÜ should handle route optimization with no agent location (625 ms)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Batch F: Complete Remaining Lines Coverage ΓÇ║ should handle geocoding in current-order endpoint

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 4289 |[39m         [32m`/api/delivery/current-order/${agent._id}`[39m
     [90m 4290 |[39m       )[33m;[39m
    [31m[1m>[22m[39m[90m 4291 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m      |[39m                               [31m[1m^[22m[39m
     [90m 4292 |[39m     })[33m;[39m
     [90m 4293 |[39m
     [90m 4294 |[39m     [90m// Lines 394-395, 462-463: Client lookup with firebase_uid[39m[0m

      at Object.toBe (tests/delivery.test.js:4291:31)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Batch F: Complete Remaining Lines Coverage ΓÇ║ should resolve client by firebase_uid in current-order

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 4308 |[39m         [32m`/api/delivery/current-order/${agent._id}`[39m
     [90m 4309 |[39m       )[33m;[39m
    [31m[1m>[22m[39m[90m 4310 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m      |[39m                               [31m[1m^[22m[39m
     [90m 4311 |[39m     })[33m;[39m
     [90m 4312 |[39m
     [90m 4313 |[39m     [90m// Lines 501-505, 516-519, 532-559: Geocoding in pending-orders[39m[0m

      at Object.toBe (tests/delivery.test.js:4310:31)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Batch F: Complete Remaining Lines Coverage ΓÇ║ should reassign order without store location using least assigned

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 4460 |[39m         [33m.[39mpost([32m"/api/delivery/reassign-order"[39m)
     [90m 4461 |[39m         [33m.[39msend({ orderId[33m:[39m order[33m.[39m_id })[33m;[39m
    [31m[1m>[22m[39m[90m 4462 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m      |[39m                               [31m[1m^[22m[39m
     [90m 4463 |[39m     })[33m;[39m
     [90m 4464 |[39m
     [90m 4465 |[39m     [90m// Lines 1210-1211, 1248: Reject order[39m[0m

      at Object.toBe (tests/delivery.test.js:4462:31)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Batch F: Complete Remaining Lines Coverage ΓÇ║ should handle complete delivery with OTP validation

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 4487 |[39m         [33m.[39mpost([32m"/api/delivery/complete"[39m)
     [90m 4488 |[39m         [33m.[39msend({ orderId[33m:[39m order[33m.[39m_id[33m,[39m agentId[33m:[39m agent[33m.[39m_id[33m,[39m otp[33m:[39m 
[32m"1234"[39m })[33m;[39m
    [31m[1m>[22m[39m[90m 4489 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m      |[39m                               [31m[1m^[22m[39m
     [90m 4490 |[39m     })[33m;[39m
     [90m 4491 |[39m
     [90m 4492 |[39m     [90m// Lines 1371-1372, 1386, 1396: Update location[39m[0m

      at Object.toBe (tests/delivery.test.js:4489:31)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Batch F: Complete Remaining Lines Coverage ΓÇ║ should reassign pending offers when agent goes offline

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

    [0m [90m 4555 |[39m         [33m.[39mpost([32m"/api/delivery/toggle-availability"[39m)
     [90m 4556 |[39m         [33m.[39msend({ agentId[33m:[39m agent1[33m.[39m_id[33m,[39m available[33m:[39m [36mfalse[39m })[33m;[39m
    [31m[1m>[22m[39m[90m 4557 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m      |[39m                               [31m[1m^[22m[39m
     [90m 4558 |[39m     })[33m;[39m
     [90m 4559 |[39m
     [90m 4560 |[39m     [90m// Lines 1733-1734, 1769-1770, 1780, 1791-1793: Toggle online[39m[0m

      at Object.toBe (tests/delivery.test.js:4557:31)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Batch F: Complete Remaining Lines Coverage ΓÇ║ should calculate earnings summary with COD and platform payments

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 4589 |[39m         [32m`/api/delivery/earnings/${agent._id}`[39m
     [90m 4590 |[39m       )[33m;[39m
    [31m[1m>[22m[39m[90m 4591 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m      |[39m                               [31m[1m^[22m[39m
     [90m 4592 |[39m       expect(response[33m.[39mbody[33m.[39mtotal_cod_collected)[33m.[39mtoBeGreaterThan([35m0[39m)[33m;[39m
     [90m 4593 |[39m     })[33m;[39m
     [90m 4594 |[39m[0m

      at Object.toBe (tests/delivery.test.js:4591:31)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Batch F: Complete Remaining Lines Coverage ΓÇ║ should fetch earnings logs with pagination

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 4608 |[39m         [32m`/api/delivery/earnings-logs/${agent._id}?page=1&limit=10`[39m
     [90m 4609 |[39m       )[33m;[39m
    [31m[1m>[22m[39m[90m 4610 |[39m       expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m      |[39m                               [31m[1m^[22m[39m
     [90m 4611 |[39m     })[33m;[39m
     [90m 4612 |[39m
     [90m 4613 |[39m     [90m// Lines 2027-2062, 2090: Route optimization[39m[0m

      at Object.toBe (tests/delivery.test.js:4610:31)

  ΓùÅ Delivery System - Integration Tests ΓÇ║ Batch F: Complete Remaining Lines Coverage ΓÇ║ should optimize route with order_ids

    ValidationError: Order validation failed: delivery.delivery_address.full_address: Path `delivery.delivery_address.full_address` is required.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3358:32)
      at node_modules/mongoose/lib/document.js:3119:17
      at node_modules/mongoose/lib/schemaType.js:1416:9

Test Suites: 1 failed, 1 total
Tests:       8 failed, 113 skipped, 18 passed, 139 total
Snapshots:   0 total
Time:        26.53 s, estimated 27 s
Ran all test suites matching tests/delivery.test.js with tests matching "Batch F".
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
